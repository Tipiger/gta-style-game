var z=Object.defineProperty;var A=(p,t,e)=>t in p?z(p,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[t]=e;var o=(p,t,e)=>A(p,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class V{constructor(t){o(this,"canvas");o(this,"ctx");o(this,"width");o(this,"height");const e=document.getElementById(t);if(!e)throw new Error(`Canvas element with id "${t}" not found`);this.canvas=e,this.ctx=e.getContext("2d"),this.width=window.innerWidth,this.height=window.innerHeight,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height}clear(t="#2a2a2a"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height)}drawRect(t,e,i,s,n=!0){this.ctx.fillStyle=s,this.ctx.strokeStyle=s,n?this.ctx.fillRect(t.x,t.y,e,i):this.ctx.strokeRect(t.x,t.y,e,i)}drawCircle(t,e,i,s=!0){this.ctx.fillStyle=i,this.ctx.strokeStyle=i,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,Math.PI*2),s?this.ctx.fill():this.ctx.stroke()}drawLine(t,e,i,s=1){this.ctx.strokeStyle=i,this.ctx.lineWidth=s,this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}drawText(t,e,i,s=16,n="Arial"){this.ctx.fillStyle=i,this.ctx.font=`${s}px ${n}`,this.ctx.fillText(t,e.x,e.y)}getWidth(){return this.width}getHeight(){return this.height}getContext(){return this.ctx}}class d{constructor(t=0,e=0){o(this,"x");o(this,"y");this.x=t,this.y=e}add(t){return new d(this.x+t.x,this.y+t.y)}subtract(t){return new d(this.x-t.x,this.y-t.y)}multiply(t){return new d(this.x*t,this.y*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?new d(0,0):new d(this.x/t,this.y/t)}distance(t){return this.subtract(t).length()}clone(){return new d(this.x,this.y)}set(t,e){return this.x=t,this.y=e,this}dot(t){return this.x*t.x+this.y*t.y}}class N{constructor(t,e){o(this,"position");o(this,"zoom");o(this,"width");o(this,"height");o(this,"minZoom",.5);o(this,"maxZoom",3);this.position=new d(0,0),this.zoom=1,this.width=t,this.height=e}setPosition(t){this.position=t.clone()}getPosition(){return this.position.clone()}follow(t,e=.1){const i=t.subtract(this.position);this.position=this.position.add(i.multiply(e))}setZoom(t){this.zoom=Math.max(this.minZoom,Math.min(t,this.maxZoom))}getZoom(){return this.zoom}zoomIn(t=.1){this.setZoom(this.zoom+t)}zoomOut(t=.1){this.setZoom(this.zoom-t)}worldToScreen(t){const e=(t.x-this.position.x)*this.zoom+this.width/2,i=(t.y-this.position.y)*this.zoom+this.height/2;return new d(e,i)}screenToWorld(t){const e=(t.x-this.width/2)/this.zoom+this.position.x,i=(t.y-this.height/2)/this.zoom+this.position.y;return new d(e,i)}getViewport(){const t=this.width/this.zoom,e=this.height/this.zoom;return{x:this.position.x-t/2,y:this.position.y-e/2,width:t,height:e}}updateSize(t,e){this.width=t,this.height=e}}class W{constructor(){o(this,"keys",new Map);o(this,"keysJustPressed",new Set);o(this,"mousePosition",{x:0,y:0});o(this,"mouseButtons",new Map);this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();this.keys.get(e)||this.keysJustPressed.add(e),this.keys.set(e,!0)}),window.addEventListener("keyup",t=>{this.keys.set(t.key.toLowerCase(),!1)})}setupMouseListeners(){window.addEventListener("mousemove",t=>{this.mousePosition={x:t.clientX,y:t.clientY}}),window.addEventListener("mousedown",t=>{this.mouseButtons.set(t.button,!0)}),window.addEventListener("mouseup",t=>{this.mouseButtons.set(t.button,!1)})}isKeyPressed(t){return this.keys.get(t.toLowerCase())??!1}isKeyJustPressed(t){return this.keysJustPressed.has(t.toLowerCase())}clearJustPressedKeys(){this.keysJustPressed.clear()}isMouseButtonPressed(t=0){return this.mouseButtons.get(t)??!1}getMousePosition(){return{...this.mousePosition}}getMovementInput(){let t=0,e=0;return(this.isKeyPressed("w")||this.isKeyPressed("arrowup"))&&(e-=1),(this.isKeyPressed("s")||this.isKeyPressed("arrowdown"))&&(e+=1),(this.isKeyPressed("a")||this.isKeyPressed("arrowleft"))&&(t-=1),(this.isKeyPressed("d")||this.isKeyPressed("arrowright"))&&(t+=1),{x:t,y:e}}}var f=(p=>(p.PISTOL="pistol",p.RIFLE="rifle",p.SHOTGUN="shotgun",p))(f||{}),b=(p=>(p.SEMI_AUTO="semi_auto",p.FULL_AUTO="full_auto",p))(b||{});class x{constructor(t,e=0){o(this,"type");o(this,"config");o(this,"currentAmmo");o(this,"reserveAmmo");o(this,"lastFireTime",0);o(this,"fireInterval");o(this,"isReloading",!1);o(this,"reloadStartTime",0);o(this,"isMouseDown",!1);this.type=t,this.config=this.getWeaponConfig(t),this.currentAmmo=this.config.magazineCapacity,this.reserveAmmo=e,this.fireInterval=1/this.config.fireRate}getWeaponConfig(t){switch(t){case"pistol":return{type:"pistol",damage:10,fireRate:2.22,range:300,bulletSpeed:500,bulletSize:3,accuracy:.9,magazineCapacity:10,reloadTime:.8,fireMode:"semi_auto",spread:0};case"rifle":return{type:"rifle",damage:20,fireRate:8,range:500,bulletSpeed:700,bulletSize:4,accuracy:.95,magazineCapacity:30,reloadTime:2,fireMode:"full_auto",spread:15};case"shotgun":return{type:"shotgun",damage:15,fireRate:1,range:150,bulletSpeed:400,bulletSize:2,accuracy:.95,magazineCapacity:6,reloadTime:1.2,fireMode:"semi_auto",spread:15,pelletsPerShot:8}}}canFire(t){return this.currentAmmo<=0||this.isReloading?!1:this.config.fireMode==="semi_auto"?t-this.lastFireTime>=this.fireInterval:this.isMouseDown&&t-this.lastFireTime>=this.fireInterval}fire(t){return this.canFire(t)?(this.currentAmmo--,this.lastFireTime=t,!0):!1}setMouseDown(t){this.isMouseDown=t}startReload(t){this.isReloading||this.currentAmmo===this.config.magazineCapacity||this.reserveAmmo>0&&(this.isReloading=!0,this.reloadStartTime=t)}updateReload(t){if(this.isReloading&&t-this.reloadStartTime>=this.config.reloadTime){this.isReloading=!1;const e=this.config.magazineCapacity-this.currentAmmo,i=Math.min(e,this.reserveAmmo);this.currentAmmo+=i,this.reserveAmmo-=i}}getReloadProgress(){return this.isReloading,0}isReloadingNow(){return this.isReloading}getConfig(){return{...this.config}}getCurrentAmmo(){return this.currentAmmo}getReserveAmmo(){return this.reserveAmmo}addReserveAmmo(t){this.reserveAmmo+=t}getTotalAmmo(){return this.currentAmmo+this.reserveAmmo}getType(){return this.type}getWeaponType(){return this.type}getName(){switch(this.type){case"pistol":return"手枪";case"rifle":return"步枪";case"shotgun":return"霰弹枪"}}}class R{constructor(t,e,i,s,n,l,r){o(this,"position");o(this,"velocity");o(this,"damage");o(this,"range");o(this,"size");o(this,"distanceTraveled",0);o(this,"color","#ffff00");o(this,"ownerId");this.position=t.clone(),this.velocity=e.normalize().multiply(s),this.damage=i,this.range=n,this.size=l,this.ownerId=r}update(t){const e=this.velocity.multiply(t);this.position=this.position.add(e),this.distanceTraveled+=e.length()}isOutOfRange(){return this.distanceTraveled>this.range}render(t,e){const i=e.worldToScreen(this.position);t.drawCircle(i,this.size*e.getZoom(),this.color,!0)}getPosition(){return this.position.clone()}getDamage(){return this.damage}getSize(){return this.size}getOwnerId(){return this.ownerId}getDirection(){return this.velocity.normalize()}}class k{constructor(){o(this,"bullets",[])}addBullet(t){this.bullets.push(t)}update(t){for(let e=this.bullets.length-1;e>=0;e--)this.bullets[e].update(t),this.bullets[e].isOutOfRange()&&this.bullets.splice(e,1)}render(t,e){for(const i of this.bullets)i.render(t,e)}getBullets(){return this.bullets}removeBullet(t){this.bullets.splice(t,1)}clear(){this.bullets=[]}getCount(){return this.bullets.length}}class C{constructor(t){o(this,"position");o(this,"velocity");o(this,"speed",150);o(this,"radius",8);o(this,"color","#00ff00");o(this,"collisionSystem",null);o(this,"playerId","player");o(this,"weapons",new Map);o(this,"currentWeaponType",f.PISTOL);o(this,"bulletManager");o(this,"direction",new d(1,0));o(this,"mousePosition",new d(0,0));o(this,"lastReloadTime",0);o(this,"shouldFire",!1);o(this,"maxHealth",100);o(this,"health",100);o(this,"isDead",!1);o(this,"currentVehicle",null);o(this,"weaponBeforeVehicle",f.PISTOL);o(this,"autoShootRange",300);o(this,"getNPCsCallback",null);this.position=t.clone(),this.velocity=new d(0,0),this.weapons.set(f.PISTOL,new x(f.PISTOL,1/0)),this.bulletManager=new k}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.playerId,{position:this.position.clone(),radius:this.radius,type:"circle"})}setMousePosition(t,e){this.mousePosition=new d(t,e)}setGetNPCsCallback(t){this.getNPCsCallback=t}getCurrentWeapon(){const t=this.weapons.get(this.currentWeaponType);if(!t)throw new Error(`Weapon type ${this.currentWeaponType} not found`);return t}findNearestEnemy(){if(!this.getNPCsCallback)return null;const t=this.getNPCsCallback();let e=null,i=this.autoShootRange;for(const s of t){if(s.getIsDead&&s.getIsDead())continue;const n=s.getPosition(),l=this.position.distance(n);if(l<i){if(this.collisionSystem&&!this.collisionSystem.raycastBuildings(this.position,n))continue;i=l,e=s}}return e}fire(t){const e=this.getCurrentWeapon(),i=e.getConfig(),s=this.findNearestEnemy();if(s){const n=s.getPosition().subtract(this.position),l=n.length();if(l>0&&(this.direction=n.normalize()),l>i.range){this.shouldFire=!1;return}if(e.getCurrentAmmo()<=0){e.getReserveAmmo()>0&&this.reload(t);return}this.shouldFire=!0,e.setMouseDown(!0)}else{this.shouldFire=!1,e.setMouseDown(!1);return}if(!(i.fireMode===b.SEMI_AUTO&&!this.shouldFire)&&e.fire(t)){this.shouldFire=!1;const n=i.pelletsPerShot||1;for(let l=0;l<n;l++){let h=(Math.random()-.5)*i.spread*(Math.PI/180);if(i.spread>0&&i.accuracy<1){const y=i.accuracy,m=Math.random()*(1-y)*Math.PI*2;h+=m}const a=this.direction.clone(),c=a.x*Math.cos(h)-a.y*Math.sin(h),u=a.x*Math.sin(h)+a.y*Math.cos(h),g=new R(this.position.clone(),new d(c,u),i.damage,i.bulletSpeed,i.range,i.bulletSize,this.playerId);this.bulletManager.addBullet(g)}}}reload(t){const e=this.getCurrentWeapon();e.isReloadingNow()||(this.lastReloadTime=t),e.startReload(t)}getReloadProgress(t){const e=this.getCurrentWeapon();if(!e.isReloadingNow())return 0;const i=e.getConfig(),s=t-this.lastReloadTime;return Math.min(s/i.reloadTime,1)}isReloading(){return this.getCurrentWeapon().isReloadingNow()}switchWeapon(t){this.currentVehicle!==null&&t!==f.PISTOL||this.weapons.has(t)&&(this.currentWeaponType=t)}getCurrentWeaponType(){return this.currentWeaponType}enterVehicle(t){this.currentVehicle=t,this.weaponBeforeVehicle=this.currentWeaponType,this.currentWeaponType=f.PISTOL,t.enterVehicle(this.playerId)}exitVehicle(){if(this.currentVehicle!==null){const t=this.currentVehicle.getPosition(),e=50,i=this.currentVehicle.getRotation(),s=new d(t.x+Math.cos(i+Math.PI/2)*e,t.y+Math.sin(i+Math.PI/2)*e);this.position=s,this.collisionSystem&&this.collisionSystem.updatePosition(this.playerId,this.position),this.currentVehicle.exitVehicle(),this.weapons.has(this.weaponBeforeVehicle)&&(this.currentWeaponType=this.weaponBeforeVehicle),this.currentVehicle=null}}getCurrentVehicle(){return this.currentVehicle}isInVehicle(){return this.currentVehicle!==null}pickupWeapon(t){if(this.weapons.has(t)){const e=this.weapons.get(t),i=e.getConfig();e.addReserveAmmo(i.magazineCapacity)}else{const e=new x(t,0),i=e.getConfig();e.addReserveAmmo(i.magazineCapacity),this.weapons.set(t,e)}}update(t,e,i){if(this.currentVehicle!==null){e.x>0?this.currentVehicle.turnRight():e.x<0&&this.currentVehicle.turnLeft(),e.y<0?this.currentVehicle.accelerate():e.y>0&&this.currentVehicle.decelerate(),this.position=this.currentVehicle.getPosition().clone(),this.bulletManager.update(t),this.getCurrentWeapon().updateReload(i);return}this.bulletManager.update(t),this.getCurrentWeapon().updateReload(i);let n=new d(e.x,e.y);n.length()>0&&(n=n.normalize().multiply(this.speed));const l=.2;this.velocity.x+=(n.x-this.velocity.x)*l,this.velocity.y+=(n.y-this.velocity.y)*l;const r=this.position.add(this.velocity.multiply(t));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.playerId,r),this.collisionSystem.getCollisions(this.playerId).length>0){const a=this.position.add(new d(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.playerId,a),this.collisionSystem.getCollisions(this.playerId).length===0)this.position=a;else{const u=this.position.add(new d(0,this.velocity.y*t));this.collisionSystem.updatePosition(this.playerId,u),this.collisionSystem.getCollisions(this.playerId).length===0?this.position=u:this.collisionSystem.updatePosition(this.playerId,this.position)}}else this.position=r;else this.position=r}render(t,e,i){const s=e.worldToScreen(this.position),n=e.getZoom();t.drawCircle(s,this.radius*n,this.color,!0),this.renderWeaponIcon(t,s,n),this.renderHealthBar(t,s,n),this.bulletManager.render(t,e),this.isReloading()&&this.renderReloadAnimation(t,e,i)}renderHealthBar(t,e,i){const s=this.radius*2.5*i,n=3*i,l=e.y-this.radius*1.5*i,r=t.getContext();r.fillStyle="#000000",r.fillRect(e.x-s/2,l,s,n),r.strokeStyle="#ffffff",r.lineWidth=1,r.strokeRect(e.x-s/2,l,s,n);const h=this.health/this.maxHealth,a=s*h;h>.5?r.fillStyle="#00ff00":h>.25?r.fillStyle="#ffff00":r.fillStyle="#ff0000",r.fillRect(e.x-s/2,l,a,n)}renderWeaponIcon(t,e,i){const s=t.getContext(),l=this.getCurrentWeapon().getType(),r=this.radius*1.2*i,h=e.add(this.direction.multiply(r)),a=this.radius*.8*i;switch(s.save(),l){case f.PISTOL:s.fillStyle="#ffff00",s.beginPath(),s.arc(h.x,h.y,a,0,Math.PI*2),s.fill();break;case f.RIFLE:s.fillStyle="#00ff00",s.save(),s.translate(h.x,h.y),s.rotate(Math.atan2(this.direction.y,this.direction.x)),s.fillRect(-a,-a*.5,a*2,a),s.restore();break;case f.SHOTGUN:s.fillStyle="#ff6600",s.beginPath();for(let c=0;c<6;c++){const u=c*Math.PI/3,g=h.x+Math.cos(u)*a,y=h.y+Math.sin(u)*a;c===0?s.moveTo(g,y):s.lineTo(g,y)}s.closePath(),s.fill();break}s.restore()}renderReloadAnimation(t,e,i){const s=this.getReloadProgress(i),n=e.worldToScreen(this.position),l=20*e.getZoom(),r=t.getContext();r.strokeStyle="rgba(255, 255, 255, 0.3)",r.lineWidth=2,r.beginPath(),r.arc(n.x,n.y,l,0,Math.PI*2),r.stroke(),r.strokeStyle="#00ff00",r.lineWidth=3,r.beginPath();const h=Math.max(s,.01);r.arc(n.x,n.y,l,-Math.PI/2,-Math.PI/2+Math.PI*2*h),r.stroke()}getPosition(){return this.position.clone()}setPosition(t){this.position=t.clone()}getRadius(){return this.radius}getWeapon(){return this.getCurrentWeapon()}getBulletManager(){return this.bulletManager}getDirection(){return this.direction.clone()}takeDamage(t){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}}class L{constructor(t,e){o(this,"position");o(this,"velocity");o(this,"speed",40);o(this,"radius",6);o(this,"color","#4a90e2");o(this,"id");o(this,"behavior","idle");o(this,"collisionSystem",null);o(this,"patrolPoints",[]);o(this,"currentPatrolIndex",0);o(this,"idleTimer",0);o(this,"idleDuration",2);o(this,"targetPosition",null);o(this,"direction",new d(1,0));o(this,"visionRange",187.5);o(this,"visionAngle",120);o(this,"showVision",!0);o(this,"fleeRange",150);o(this,"maxHealth",50);o(this,"health",50);o(this,"isDead",!1);o(this,"lastShotTime",0);o(this,"shotCooldown",.5);o(this,"onShoot",null);this.id=t,this.position=e.clone(),this.velocity=new d(0,0),this.health=this.maxHealth}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:this.radius,type:"circle"})}setPatrolPoints(t){this.patrolPoints=t.map(e=>e.clone()),this.patrolPoints.length>0&&(this.behavior="patrol",this.targetPosition=this.patrolPoints[0].clone())}setBehavior(t){this.behavior=t,t==="idle"&&(this.idleTimer=0,this.velocity=new d(0,0))}getBehavior(){return this.behavior}update(t,e,i=0){if(this.velocity.length()>0&&(this.direction=this.velocity.normalize()),this.isPointInVisionWithLineOfSight(e)){this.setBehavior("chase"),this.targetPosition=e.clone();const l=e.subtract(this.position);l.length()>0&&(this.direction=l.normalize()),this.tryShoot(i)}else this.behavior==="chase"&&this.setBehavior("patrol");switch(this.behavior){case"idle":this.updateIdle(t);break;case"patrol":this.updatePatrol(t);break;case"chase":this.updateChase(t);break;case"flee":this.updateFlee(t,e);break}const n=this.position.add(this.velocity.multiply(t));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.id,n),this.collisionSystem.getCollisions(this.id).length>0){const r=this.position.add(new d(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.id,r),this.collisionSystem.getCollisions(this.id).length===0)this.position=r;else{const a=this.position.add(new d(0,this.velocity.y*t));this.collisionSystem.updatePosition(this.id,a),this.collisionSystem.getCollisions(this.id).length===0?this.position=a:this.collisionSystem.updatePosition(this.id,this.position)}}else this.position=n;else this.position=n}updateIdle(t){this.idleTimer+=t,this.velocity=new d(0,0),this.idleTimer>this.idleDuration&&this.setBehavior("patrol")}updatePatrol(t){if(this.patrolPoints.length===0){this.setBehavior("idle");return}this.targetPosition||(this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone());const e=this.targetPosition.subtract(this.position);e.length()<10?(this.currentPatrolIndex=(this.currentPatrolIndex+1)%this.patrolPoints.length,this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone(),this.velocity=new d(0,0)):this.velocity=e.normalize().multiply(this.speed)}updateChase(t){if(!this.targetPosition)return;const e=this.targetPosition.subtract(this.position);e.length()>0&&(this.velocity=e.normalize().multiply(this.speed*1.2))}updateFlee(t,e){const i=this.position.subtract(e),s=i.length();s>this.fleeRange?this.setBehavior("patrol"):s>0&&(this.velocity=i.normalize().multiply(this.speed*1.5))}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom();this.showVision&&this.drawVisionCone(t,e,i),t.drawCircle(i,this.radius*s,this.color,!0);const n=this.radius*1.5*s,l=i.add(this.direction.multiply(n));t.drawLine(i,l,"#ffffff",1),this.drawHealthBar(t,i,s)}drawHealthBar(t,e,i){const s=this.radius*2.5*i,n=3*i,l=e.y-this.radius*1.5*i,r=t.getContext();r.fillStyle="#000000",r.fillRect(e.x-s/2,l,s,n),r.strokeStyle="#ffffff",r.lineWidth=1,r.strokeRect(e.x-s/2,l,s,n);const h=this.health/this.maxHealth,a=s*h;h>.5?r.fillStyle="#00ff00":h>.25?r.fillStyle="#ffff00":r.fillStyle="#ff0000",r.fillRect(e.x-s/2,l,a,n)}drawVisionCone(t,e,i){const s=e.getZoom(),n=this.visionRange*s,l=this.visionAngle/2,r=Math.atan2(this.direction.y,this.direction.x),h=r-l*Math.PI/180,a=r+l*Math.PI/180,c=i.add(new d(Math.cos(h)*n,Math.sin(h)*n)),u=i.add(new d(Math.cos(a)*n,Math.sin(a)*n));t.drawLine(i,c,"#4a90e2",1),t.drawLine(i,u,"#4a90e2",1);const g=t.getContext();g.strokeStyle="#4a90e2",g.lineWidth=1,g.beginPath(),g.arc(i.x,i.y,n,h,a),g.stroke(),g.fillStyle="rgba(74, 144, 226, 0.1)",g.beginPath(),g.moveTo(i.x,i.y),g.arc(i.x,i.y,n,h,a),g.lineTo(i.x,i.y),g.fill()}getPosition(){return this.position.clone()}setPosition(t){this.position=t.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position)}getRadius(){return this.radius}getId(){return this.id}getDirection(){return this.direction.clone()}getVisionRange(){return this.visionRange}getVisionAngle(){return this.visionAngle}isPointInVision(t){const e=t.subtract(this.position);if(e.length()>this.visionRange)return!1;const s=Math.atan2(e.y,e.x),n=Math.atan2(this.direction.y,this.direction.x),l=this.visionAngle/2;let r=s-n;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;return Math.abs(r)<=l*Math.PI/180}isPointInVisionWithLineOfSight(t){return this.isPointInVision(t)?this.collisionSystem?this.collisionSystem.raycast(this.position,t,[this.id,"player"]):!0:!1}setShowVision(t){this.showVision=t}getShowVision(){return this.showVision}takeDamage(t,e){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0),e&&(this.setBehavior("chase"),this.targetPosition=e.clone()))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}tryShoot(t){this.onShoot&&t-this.lastShotTime>=this.shotCooldown&&(this.lastShotTime=t,this.onShoot(this.position.clone(),this.direction.clone()))}setOnShoot(t){this.onShoot=t}cleanup(){this.collisionSystem&&this.collisionSystem.unregister(this.id)}}class v{constructor(){o(this,"npcs",new Map);o(this,"collisionSystem",null);o(this,"maxNPCs",5);o(this,"_spawnRange",600);o(this,"despawnRange",1e3);o(this,"npcIdCounter",0)}setCollisionSystem(t){this.collisionSystem=t;for(const e of this.npcs.values())e.setCollisionSystem(t)}createNPC(t,e){const i=new L(t,e);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),this.npcs.set(t,i),i}getNPC(t){return this.npcs.get(t)}removeNPC(t){const e=this.npcs.get(t);return e&&e.cleanup(),this.npcs.delete(t)}getAllNPCs(){return Array.from(this.npcs.values())}getNPCCount(){return this.npcs.size}update(t,e,i=0){const s=[];for(const[n,l]of this.npcs.entries())l.update(t,e,i),(l.getPosition().distance(e)>this.despawnRange||l.getIsDead())&&s.push(n);for(const n of s)this.removeNPC(n);this.spawnNPCsAroundPlayer(e)}spawnNPCsAroundPlayer(t){if(this.npcs.size>=this.maxNPCs)return;const e=this.maxNPCs-this.npcs.size;for(let i=0;i<e;i++){const s=Math.random()*Math.PI*2,n=400+Math.random()*200,l=t.x+Math.cos(s)*n,r=t.y+Math.sin(s)*n,h=`npc_${this.npcIdCounter++}`,a=this.createNPC(h,new d(l,r)),c=[new d(l,r),new d(l+200,r),new d(l+200,r+200),new d(l,r+200)];a.setPatrolPoints(c)}}render(t,e){for(const i of this.npcs.values())i.render(t,e)}clear(){this.npcs.clear()}}class D{constructor(){o(this,"colliders",new Map)}register(t,e){this.colliders.set(t,e)}unregister(t){this.colliders.delete(t)}updatePosition(t,e){const i=this.colliders.get(t);i&&(i.position=e.clone())}circleToCircle(t,e){return t.position.distance(e.position)<t.radius+e.radius}circleToRect(t,e){const i=e.position.x,s=e.position.x+(e.width||0),n=e.position.y,l=e.position.y+(e.height||0),r=Math.max(i,Math.min(t.position.x,s)),h=Math.max(n,Math.min(t.position.y,l));return Math.sqrt((t.position.x-r)**2+(t.position.y-h)**2)<t.radius}rectToRect(t,e){return t.position.x<e.position.x+(e.width||0)&&t.position.x+(t.width||0)>e.position.x&&t.position.y<e.position.y+(e.height||0)&&t.position.y+(t.height||0)>e.position.y}isColliding(t,e){const i=this.colliders.get(t),s=this.colliders.get(e);return!i||!s?!1:i.type==="circle"&&s.type==="circle"?this.circleToCircle(i,s):i.type==="circle"&&s.type==="rect"?this.circleToRect(i,s):i.type==="rect"&&s.type==="circle"?this.circleToRect(s,i):this.rectToRect(i,s)}getCollisions(t){const e=[];for(const[i]of this.colliders)i!==t&&this.isColliding(t,i)&&e.push(i);return e}pointInCollider(t,e){const i=this.colliders.get(e);return i?i.type==="circle"?t.distance(i.position)<i.radius:t.x>=i.position.x&&t.x<=i.position.x+(i.width||0)&&t.y>=i.position.y&&t.y<=i.position.y+(i.height||0):!1}getCollider(t){return this.colliders.get(t)}getCollisionNormal(t,e){const i=this.colliders.get(t),s=this.colliders.get(e);if(!i||!s)return null;const n=s.position.subtract(i.position);return n.length()===0?new d(1,0):n.normalize()}getCollisionNormalCircleRect(t,e){const i=this.colliders.get(t),s=this.colliders.get(e);if(!i||!s)return null;const n=s.position.x,l=s.position.x+(s.width||0),r=s.position.y,h=s.position.y+(s.height||0),a=Math.max(n,Math.min(i.position.x,l)),c=Math.max(r,Math.min(i.position.y,h)),u=new d(i.position.x-a,i.position.y-c);return u.length()===0?new d(1,0):u.normalize()}raycastBuildings(t,e){const i=e.subtract(t),s=i.length();if(s===0)return!0;const n=i.normalize();for(const[l,r]of this.colliders)if(l.startsWith("building_")&&this.raycastCollider(t,n,s,r))return!1;return!0}raycast(t,e,i=[]){const s=e.subtract(t),n=s.length();if(n===0)return!0;const l=s.normalize(),r=new Set(i);for(const[h,a]of this.colliders)if(!r.has(h)&&this.raycastCollider(t,l,n,a))return!1;return!0}raycastCollider(t,e,i,s){return s.type==="circle"?this.raycastCircle(t,e,i,s):this.raycastRect(t,e,i,s)}raycastCircle(t,e,i,s){const l=s.position.subtract(t).dot(e);return l<0||l>i?!1:t.add(e.multiply(l)).distance(s.position)<s.radius}raycastRect(t,e,i,s){const n=s.position.x,l=s.position.x+(s.width||0),r=s.position.y,h=s.position.y+(s.height||0);let a=0,c=i;if(Math.abs(e.x)>1e-4){const u=(n-t.x)/e.x,g=(l-t.x)/e.x,y=Math.min(u,g),m=Math.max(u,g);a=Math.max(a,y),c=Math.min(c,m)}else if(t.x<n||t.x>l)return!1;if(Math.abs(e.y)>1e-4){const u=(r-t.y)/e.y,g=(h-t.y)/e.y,y=Math.min(u,g),m=Math.max(u,g);a=Math.max(a,y),c=Math.min(c,m)}else if(t.y<r||t.y>h)return!1;return a<=c}}class H{constructor(t,e,i=32){o(this,"tileSize");o(this,"elementMap",new Map);o(this,"collisionSystem");o(this,"chunkSize",10);o(this,"generatedChunks",new Set);o(this,"buildingIdCounter",0);this.tileSize=i,this.collisionSystem=new D}getChunkKey(t,e){return`${t},${e}`}_getTileChunk(t,e){return{x:Math.floor(t/this.chunkSize),y:Math.floor(e/this.chunkSize)}}generateChunk(t,e){const i=this.getChunkKey(t,e);if(this.generatedChunks.has(i))return;this.generatedChunks.add(i);const s=t*this.chunkSize,n=e*this.chunkSize,l=s+this.chunkSize,r=n+this.chunkSize;for(let h=n;h<r;h++)for(let a=s;a<l;a++){const c=`${a},${h}`;this.elementMap.set(c,{x:a*this.tileSize,y:h*this.tileSize,width:this.tileSize,height:this.tileSize,type:"grass",color:"#2d5016"})}this.generateRoadsInChunk(s,n,l,r),this.generateBuildingsInChunk(s,n,l,r)}generateRoadsInChunk(t,e,i,s){for(let n=e;n<s;n++)if(n%8===0)for(let l=t;l<i;l++){const r=`${l},${n}`,h=this.elementMap.get(r);h&&(h.type="road",h.color="#444444")}for(let n=t;n<i;n++)if(n%8===0)for(let l=e;l<s;l++){const r=`${n},${l}`,h=this.elementMap.get(r);h&&(h.type="road",h.color="#444444")}}generateBuildingsInChunk(t,e,i,s){const n=["#8b4513","#a0522d","#cd853f","#daa520"];for(let l=e+2;l<s-2;l+=10)for(let r=t+2;r<i-2;r+=10){const h=r*73856093^l*19349663,a=Math.abs(Math.sin(h)*1e4)%1,c=Math.abs(Math.sin(h+1)*1e4)%1,u=2+a*3|0,g=2+c*3|0;for(let y=0;y<g;y++)for(let m=0;m<u;m++){const M=r+m,S=l+y;if(M<i&&S<s){const T=`${M},${S}`,w=this.elementMap.get(T);if(w){const P=`building_${this.buildingIdCounter++}`;w.type="building",w.color=n[Math.floor(a*n.length)],w.id=P,this.collisionSystem.register(P,{position:new d(w.x,w.y),radius:0,type:"rect",width:w.width,height:w.height})}}}}}ensureChunksGenerated(t){const e=Math.floor(t.x/this.tileSize),i=Math.floor(t.y/this.tileSize),s=Math.ceil((t.x+t.width)/this.tileSize),n=Math.ceil((t.y+t.height)/this.tileSize),l=Math.floor(e/this.chunkSize),r=Math.floor(i/this.chunkSize),h=Math.ceil(s/this.chunkSize),a=Math.ceil(n/this.chunkSize);for(let c=r;c<a;c++)for(let u=l;u<h;u++)this.generateChunk(u,c)}render(t,e){const i=e.getViewport(),s=e.getZoom();this.ensureChunksGenerated(i);for(const n of this.elementMap.values()){if(n.x+n.width<i.x||n.x>i.x+i.width||n.y+n.height<i.y||n.y>i.y+i.height)continue;const l=e.worldToScreen(new d(n.x,n.y)),r=n.width*s,h=n.height*s;t.drawRect(l,r,h,n.color,!0),t.drawRect(l,r,h,"#333333",!1)}}getTileSize(){return this.tileSize}getCollisionSystem(){return this.collisionSystem}getBuildings(){return Array.from(this.elementMap.values()).filter(t=>t.type==="building")}isPointInBuilding(t){const e=this.getBuildings();for(const i of e)if(t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height)return!0;return!1}}class O{constructor(t,e,i){o(this,"position");o(this,"type");o(this,"weaponType");o(this,"radius",8);o(this,"color");o(this,"id");o(this,"rotationAngle",0);this.id=t,this.position=e.clone(),this.type="weapon",this.weaponType=i,this.color=this.getColorByWeapon(i)}getColorByWeapon(t){switch(t){case f.PISTOL:return"#ffff00";case f.RIFLE:return"#00ff00";case f.SHOTGUN:return"#ff6600"}}update(t){this.rotationAngle+=t*3}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom(),n=t.getContext();switch(n.save(),n.translate(i.x,i.y),n.rotate(this.rotationAngle),this.weaponType){case f.PISTOL:this.drawPistolIcon(n,s);break;case f.RIFLE:this.drawRifleIcon(n,s);break;case f.SHOTGUN:this.drawShotgunIcon(n,s);break}n.restore(),t.drawCircle(i,3*s,"#ffffff",!0),this.drawWeaponLabel(t,i,s)}drawWeaponLabel(t,e,i){const s=t.getContext();let n="";switch(this.weaponType){case f.RIFLE:n="步枪";break;case f.SHOTGUN:n="霰弹枪";break;default:return}s.fillStyle=this.color,s.font=`${12*i}px Arial`,s.textAlign="center",s.textBaseline="top",s.fillText(n,e.x,e.y+this.radius*1.5*i)}drawPistolIcon(t,e){t.fillStyle=this.color,t.beginPath();for(let i=0;i<5;i++){const s=i*4*Math.PI/5-Math.PI/2,n=Math.cos(s)*this.radius*e,l=Math.sin(s)*this.radius*e;i===0?t.moveTo(n,l):t.lineTo(n,l)}t.closePath(),t.fill()}drawRifleIcon(t,e){t.fillStyle=this.color;const i=this.radius*1.5*e,s=this.radius*.8*e;t.fillRect(-i/2,-s/2,i,s),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(-i/2,-s/2,i,s)}drawShotgunIcon(t,e){t.fillStyle=this.color,t.beginPath(),t.arc(0,0,this.radius*e,0,Math.PI*2),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=1,t.stroke(),t.strokeStyle="#ffffff",t.lineWidth=.5;for(let i=0;i<3;i++){const s=i*Math.PI/3,n=Math.cos(s)*this.radius*.5*e,l=Math.sin(s)*this.radius*.5*e;t.beginPath(),t.moveTo(0,0),t.lineTo(n,l),t.stroke()}}getPosition(){return this.position.clone()}getId(){return this.id}getWeaponType(){return this.weaponType}getRadius(){return this.radius}}class I{constructor(){o(this,"items",new Map);o(this,"itemIdCounter",0)}addItem(t,e){const i=`item_${this.itemIdCounter++}`,s=new O(i,t,e);return this.items.set(i,s),s}removeItem(t){return this.items.delete(t)}getItem(t){return this.items.get(t)}getAllItems(){return Array.from(this.items.values())}update(t){for(const e of this.items.values())e.update(t)}render(t,e){for(const i of this.items.values())i.render(t,e)}getCount(){return this.items.size}clear(){this.items.clear()}}class E{constructor(t,e){o(this,"position");o(this,"velocity");o(this,"speed",600);o(this,"maxSpeed",900);o(this,"acceleration",450);o(this,"friction",.98);o(this,"width",40);o(this,"height",24);o(this,"color","#ff0000");o(this,"rotation",0);o(this,"id");o(this,"collisionSystem",null);o(this,"isOccupied",!1);o(this,"occupantId",null);o(this,"maxHealth",100);o(this,"health",100);o(this,"isDead",!1);o(this,"restitution",.6);o(this,"lastCollisionNormal",null);this.id=t,this.position=e.clone(),this.velocity=new d(0,0)}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:Math.max(this.width,this.height)/2,type:"circle"})}getId(){return this.id}getPosition(){return this.position.clone()}getWidth(){return this.width}getHeight(){return this.height}isOccupiedByPlayer(){return this.isOccupied}getOccupantId(){return this.occupantId}enterVehicle(t){this.isOccupied=!0,this.occupantId=t}exitVehicle(){this.isOccupied=!1,this.occupantId=null,this.velocity=new d(0,0)}setPosition(t){this.position=t.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position.clone())}setRotation(t){this.rotation=t}getRotation(){return this.rotation}accelerate(){if(this.velocity.length()<this.maxSpeed){const e=new d(Math.cos(this.rotation),Math.sin(this.rotation));this.velocity=this.velocity.add(e.multiply(this.acceleration*.016))}}decelerate(){this.velocity=this.velocity.multiply(.85)}turnLeft(){this.rotation-=.05}turnRight(){this.rotation+=.05}update(t){this.velocity=this.velocity.multiply(this.friction);const e=this.position.add(this.velocity.multiply(t));if(this.collisionSystem){this.collisionSystem.updatePosition(this.id,e);const i=this.collisionSystem.getCollisions(this.id);if(i.length>0){const s=this.velocity.length(),n=this.position.add(new d(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.id,n),this.collisionSystem.getCollisions(this.id).length===0)this.position=n,this.velocity=new d(this.velocity.x,-this.velocity.y*this.restitution);else{const r=this.position.add(new d(0,this.velocity.y*t));if(this.collisionSystem.updatePosition(this.id,r),this.collisionSystem.getCollisions(this.id).length===0)this.position=r,this.velocity=new d(-this.velocity.x*this.restitution,this.velocity.y);else{this.collisionSystem.updatePosition(this.id,this.position);let a=null;for(const c of i){const u=this.collisionSystem.getCollider(this.id),g=this.collisionSystem.getCollider(c);if(u&&g&&(u.type==="circle"&&g.type==="circle"?a=this.collisionSystem.getCollisionNormal(this.id,c):u.type==="circle"&&g.type==="rect"&&(a=this.collisionSystem.getCollisionNormalCircleRect(this.id,c)),a)){this.lastCollisionNormal=a;break}}if(a){const c=this.velocity.x*a.x+this.velocity.y*a.y;if(c<0){const u=(1+this.restitution)*c,g=new d(this.velocity.x-u*a.x,this.velocity.y-u*a.y);this.velocity=g}}else this.velocity=this.velocity.multiply(-this.restitution);if(s>50){const c=Math.max(1,Math.floor(s/30));this.takeDamage(c)}}}}else this.position=e}else this.position=e}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom(),n=t.getContext();n.save(),n.translate(i.x,i.y),n.rotate(this.rotation),n.fillStyle=this.color,n.fillRect(-this.width/2*s,-this.height/2*s,this.width*s,this.height*s),n.fillStyle="#87ceeb",n.fillRect(-this.width/3*s,-this.height/3*s,this.width/1.5*s,this.height/3*s),n.fillStyle="#ffff00",n.fillRect(-this.width/2*s,-this.height/4*s,3*s,3*s),n.fillRect(this.width/2*s-3*s,-this.height/4*s,3*s,3*s),n.restore(),this.isOccupied||(n.strokeStyle="#00ff00",n.lineWidth=2,n.strokeRect(i.x-this.width/2*s,i.y-this.height/2*s,this.width*s,this.height*s)),this.renderHealthBar(t,i,s)}renderHealthBar(t,e,i){const s=t.getContext(),n=this.width*i,l=4*i,r=this.height/2*i+8*i;s.fillStyle="#000000",s.fillRect(e.x-n/2,e.y+r,n,l),s.strokeStyle="#ffffff",s.lineWidth=1,s.strokeRect(e.x-n/2,e.y+r,n,l);const h=this.health/this.maxHealth,a=n*h;h>.5?s.fillStyle="#00ff00":h>.25?s.fillStyle="#ffff00":s.fillStyle="#ff0000",s.fillRect(e.x-n/2,e.y+r,a,l)}isPlayerNearby(t,e=50){return this.position.subtract(t).length()<e}takeDamage(t){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}getRadius(){return Math.max(this.width,this.height)/2}setRestitution(t){this.restitution=Math.max(0,Math.min(1,t))}getRestitution(){return this.restitution}getLastCollisionNormal(){return this.lastCollisionNormal}}class F{constructor(){o(this,"vehicles",new Map);o(this,"vehicleIdCounter",0);o(this,"collisionSystem",null);o(this,"maxVehicles",0);o(this,"spawnRange",800);o(this,"despawnRange",1200)}setCollisionSystem(t){this.collisionSystem=t}spawnVehicle(t){if(this.vehicles.size>=this.maxVehicles)return Array.from(this.vehicles.values())[0];const e=`vehicle_${this.vehicleIdCounter++}`,i=new E(e,t);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),this.vehicles.set(e,i),i}getVehicles(){return Array.from(this.vehicles.values())}getNearbyVehicles(t,e=100){return Array.from(this.vehicles.values()).filter(i=>i.isPlayerNearby(t,e))}getPlayerVehicle(t){for(const e of this.vehicles.values())if(e.getOccupantId()===t)return e;return null}update(t,e){const i=[];for(const[s,n]of this.vehicles){if(n.update(t),n.getIsDead()){i.push(s);continue}n.getPosition().subtract(e).length()>this.despawnRange&&i.push(s)}for(const s of i)this.vehicles.delete(s);if(this.vehicles.size<this.maxVehicles&&Math.random()<.01){const s=Math.random()*Math.PI*2,n=400+Math.random()*400,l=new d(e.x+Math.cos(s)*n,e.y+Math.sin(s)*n);this.spawnVehicle(l)}}render(t,e){for(const i of this.vehicles.values())i.render(t,e)}getCount(){return this.vehicles.size}}class Y{constructor(){o(this,"renderer");o(this,"camera");o(this,"inputManager");o(this,"player");o(this,"npcManager");o(this,"gameMap");o(this,"itemManager");o(this,"vehicleManager");o(this,"isRunning",!1);o(this,"frameCount",0);o(this,"lastFrameTime",0);o(this,"fps",0);o(this,"itemSpawnTimer",0);o(this,"itemSpawnInterval",3);o(this,"maxItems",0);o(this,"itemSpawnRange",600);o(this,"score",0);o(this,"gameOver",!1);o(this,"npcBulletManager");o(this,"gameLoop",()=>{if(!this.isRunning)return;const t=performance.now(),e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this.update(e),this.render(),this.frameCount++,t-this.lastFrameTime>1e3&&(this.fps=this.frameCount,this.frameCount=0),requestAnimationFrame(this.gameLoop)});this.renderer=new V("game-canvas"),this.camera=new N(this.renderer.getWidth(),this.renderer.getHeight()),this.inputManager=new W,this.gameMap=new H(0,0,32),this.npcManager=new v,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.setupNPCShootCallback(),this.itemManager=new I,this.vehicleManager=new F,this.vehicleManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcBulletManager=new k,this.player=new C(new d(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.player.setGetNPCsCallback(()=>this.npcManager.getAllNPCs()),this.camera.setPosition(this.player.getPosition()),window.addEventListener("resize",()=>{this.camera.updateSize(this.renderer.getWidth(),this.renderer.getHeight())})}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.gameLoop())}stop(){this.isRunning=!1}update(t){if(this.gameOver){this.inputManager.isKeyPressed("r")&&this.restartGame();return}const e=this.inputManager.getMovementInput(),i=performance.now()/1e3;this.player.fire(i),this.inputManager.isKeyPressed("r")&&this.player.reload(i),this.inputManager.isKeyPressed("1")&&this.player.switchWeapon(f.PISTOL),this.inputManager.isKeyPressed("2")&&this.player.switchWeapon(f.RIFLE),this.inputManager.isKeyPressed("3")&&this.player.switchWeapon(f.SHOTGUN),this.player.update(t,e,i),this.vehicleManager.update(t,this.player.getPosition()),this.handleVehicleInteraction(),this.npcManager.update(t,this.player.getPosition(),i),this.npcBulletManager.update(t),this.itemManager.update(t),this.itemSpawnTimer+=t,this.itemSpawnTimer>=this.itemSpawnInterval&&(this.itemSpawnTimer=0,this.itemManager.getCount()<this.maxItems&&this.spawnRandomItem()),this.cleanupFarItems(),this.checkItemPickup(),this.checkBulletsHitBuildings(),this.checkBulletHits(),this.checkNPCBulletHits(),this.cleanupNPCBullets(),this.checkDestroyedVehicles(),this.player.getIsDead()&&(this.gameOver=!0),this.camera.follow(this.player.getPosition(),.1);const n=this.player.isInVehicle()?.9:1.5,l=this.camera.getZoom(),r=n-l;Math.abs(r)>.01?this.camera.setZoom(l+r*.1):this.camera.setZoom(n),this.updateHUD(),this.inputManager.clearJustPressedKeys()}spawnRandomItem(){for(let t=0;t<5;t++){const e=Math.random()*Math.PI*2,i=300+Math.random()*300,s=this.player.getPosition().x+Math.cos(e)*i,n=this.player.getPosition().y+Math.sin(e)*i;if(!this.isPositionInBuilding(new d(s,n))){const l=[f.RIFLE,f.SHOTGUN],r=l[Math.floor(Math.random()*l.length)];this.itemManager.addItem(new d(s,n),r);return}}}dropItemFromNPC(t){const e=[f.RIFLE,f.SHOTGUN],i=e[Math.floor(Math.random()*e.length)];this.itemManager.addItem(t.clone(),i)}cleanupFarItems(){const t=this.player.getPosition(),e=this.itemManager.getAllItems();for(const i of e)t.distance(i.getPosition())>this.itemSpawnRange&&this.itemManager.removeItem(i.getId())}isPositionInBuilding(t){const e=this.gameMap.getBuildings();for(const i of e)if(t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height)return!0;return!1}handleVehicleInteraction(){if(this.player.isInVehicle()){this.inputManager.isKeyJustPressed("f")&&this.player.exitVehicle();return}const t=this.vehicleManager.getNearbyVehicles(this.player.getPosition(),100);if(t.length>0&&this.inputManager.isKeyJustPressed("f")){const e=t[0];this.player.enterVehicle(e)}}checkItemPickup(){const t=this.player.getPosition(),e=this.player.getRadius();for(const i of this.itemManager.getAllItems())t.distance(i.getPosition())<e+i.getRadius()&&(this.player.pickupWeapon(i.getWeaponType()),this.itemManager.removeItem(i.getId()))}setupNPCShootCallback(){const t=this.npcManager.createNPC.bind(this.npcManager);this.npcManager.createNPC=(e,i)=>{const s=t(e,i);return s.setOnShoot((n,l)=>{const r=new R(n,l,10,500,300,3,e);this.npcBulletManager.addBullet(r)}),s}}restartGame(){this.score=0,this.gameOver=!1,this.npcBulletManager.clear(),this.player=new C(new d(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcManager=new v,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.setupNPCShootCallback(),this.player.setGetNPCsCallback(()=>this.npcManager.getAllNPCs()),this.itemManager=new I}checkBulletsHitBuildings(){const t=this.player.getBulletManager().getBullets();for(let i=t.length-1;i>=0;i--){const s=t[i];this.gameMap.isPointInBuilding(s.getPosition())&&this.player.getBulletManager().removeBullet(i)}const e=this.npcBulletManager.getBullets();for(let i=e.length-1;i>=0;i--){const s=e[i];this.gameMap.isPointInBuilding(s.getPosition())&&this.npcBulletManager.removeBullet(i)}}checkBulletHits(){const t=this.player.getBulletManager().getBullets(),e=this.npcManager.getAllNPCs(),i=this.vehicleManager.getVehicles(),s=this.player.getCurrentVehicle();for(let n=t.length-1;n>=0;n--){const l=t[n],r=l.getPosition(),h=l.getSize();let a=!1;for(const c of e){if(c.getIsDead())continue;const u=c.getPosition(),g=c.getRadius();if(r.distance(u)<h+g){const m=l.getDamage();c.takeDamage(m,this.player.getPosition()),c.getIsDead()&&(this.score++,this.dropItemFromNPC(u),this.npcManager.removeNPC(c.getId())),a=!0;break}}if(!a)for(const c of i){if(c.getIsDead()||s===c)continue;const u=c.getPosition(),g=c.getRadius();if(r.distance(u)<h+g){const m=l.getDamage();c.takeDamage(m),a=!0;break}}a&&this.player.getBulletManager().removeBullet(n)}}checkNPCBulletHits(){const t=this.npcBulletManager.getBullets(),e=this.player.getPosition(),i=this.player.getRadius(),s=this.vehicleManager.getVehicles();for(let n=t.length-1;n>=0;n--){const l=t[n],r=l.getPosition(),h=l.getSize();let a=!1;if(!this.player.isInVehicle()&&r.distance(e)<h+i){const u=l.getDamage();this.player.takeDamage(u),a=!0}if(!a)for(const c of s){if(c.getIsDead())continue;const u=c.getPosition(),g=c.getRadius();if(r.distance(u)<h+g){const m=l.getDamage();c.takeDamage(m),a=!0;break}}a&&this.npcBulletManager.removeBullet(n)}}cleanupNPCBullets(){const t=this.npcBulletManager.getBullets(),e=this.player.getPosition();for(let i=t.length-1;i>=0;i--)t[i].getPosition().distance(e)>1e3&&this.npcBulletManager.removeBullet(i)}checkDestroyedVehicles(){if(this.player.isInVehicle()){const t=this.vehicleManager.getPlayerVehicle("player");t&&t.getIsDead()&&this.player.exitVehicle()}}render(){this.renderer.clear(),this.gameMap.render(this.renderer,this.camera),this.itemManager.render(this.renderer,this.camera),this.vehicleManager.render(this.renderer,this.camera),this.npcManager.render(this.renderer,this.camera),this.npcBulletManager.render(this.renderer,this.camera);const t=performance.now()/1e3;this.player.render(this.renderer,this.camera,t),this.drawDebugGrid(),this.gameOver&&this.drawGameOverScreen()}drawGameOverScreen(){const t=this.renderer.getContext(),e=this.renderer.getWidth(),i=this.renderer.getHeight();t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,e,i),t.fillStyle="#ff0000",t.font="bold 48px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("GAME OVER",e/2,i/2-60),t.fillStyle="#ffff00",t.font="bold 36px Arial",t.fillText(`最终得分: ${this.score}`,e/2,i/2+20),t.fillStyle="#00ff00",t.font="24px Arial",t.fillText("按 R 键重新开始",e/2,i/2+80)}drawDebugGrid(){const t=this.camera.getViewport(),e=32,i=Math.floor(t.x/e)*e,s=Math.floor(t.y/e)*e,n=i+t.width+e,l=s+t.height+e;for(let r=i;r<n;r+=e){const h=this.camera.worldToScreen(new d(r,s)),a=this.camera.worldToScreen(new d(r,l));this.renderer.drawLine(h,a,"#444444",.5)}for(let r=s;r<l;r+=e){const h=this.camera.worldToScreen(new d(i,r)),a=this.camera.worldToScreen(new d(n,r));this.renderer.drawLine(h,a,"#444444",.5)}}updateHUD(){const t=document.getElementById("score"),e=document.getElementById("weapon"),i=document.getElementById("ammo");if(t&&(t.textContent=`得分: ${this.score}`),e){const n=this.player.getWeapon().getName(),l=this.player.isReloading()?" [装弹中]":"";e.textContent=`武器: ${n}${l}`}if(i){const s=this.player.getWeapon(),n=s.getCurrentAmmo(),l=s.getReserveAmmo();i.textContent=`弹药: ${n}/${l}`}this.updateControlsDisplay()}updateControlsDisplay(){const t=document.getElementById("controls-walking"),e=document.getElementById("controls-driving");!t||!e||(this.player.isInVehicle()?(t.style.display="none",e.style.display="block"):(t.style.display="block",e.style.display="none"))}}const B=new Y;B.start();window.game=B;
