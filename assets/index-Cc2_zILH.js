var z=Object.defineProperty;var A=(g,t,e)=>t in g?z(g,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[t]=e;var n=(g,t,e)=>A(g,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class V{constructor(t){n(this,"canvas");n(this,"ctx");n(this,"width");n(this,"height");const e=document.getElementById(t);if(!e)throw new Error(`Canvas element with id "${t}" not found`);this.canvas=e,this.ctx=e.getContext("2d"),this.width=window.innerWidth,this.height=window.innerHeight,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height}clear(t="#2a2a2a"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height)}drawRect(t,e,i,s,o=!0){this.ctx.fillStyle=s,this.ctx.strokeStyle=s,o?this.ctx.fillRect(t.x,t.y,e,i):this.ctx.strokeRect(t.x,t.y,e,i)}drawCircle(t,e,i,s=!0){this.ctx.fillStyle=i,this.ctx.strokeStyle=i,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,Math.PI*2),s?this.ctx.fill():this.ctx.stroke()}drawLine(t,e,i,s=1){this.ctx.strokeStyle=i,this.ctx.lineWidth=s,this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}drawText(t,e,i,s=16,o="Arial"){this.ctx.fillStyle=i,this.ctx.font=`${s}px ${o}`,this.ctx.fillText(t,e.x,e.y)}getWidth(){return this.width}getHeight(){return this.height}getContext(){return this.ctx}}class c{constructor(t=0,e=0){n(this,"x");n(this,"y");this.x=t,this.y=e}add(t){return new c(this.x+t.x,this.y+t.y)}subtract(t){return new c(this.x-t.x,this.y-t.y)}multiply(t){return new c(this.x*t,this.y*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?new c(0,0):new c(this.x/t,this.y/t)}distance(t){return this.subtract(t).length()}clone(){return new c(this.x,this.y)}set(t,e){return this.x=t,this.y=e,this}}class W{constructor(t,e){n(this,"position");n(this,"zoom");n(this,"width");n(this,"height");n(this,"minZoom",.5);n(this,"maxZoom",3);this.position=new c(0,0),this.zoom=1,this.width=t,this.height=e}setPosition(t){this.position=t.clone()}getPosition(){return this.position.clone()}follow(t,e=.1){const i=t.subtract(this.position);this.position=this.position.add(i.multiply(e))}setZoom(t){this.zoom=Math.max(this.minZoom,Math.min(t,this.maxZoom))}getZoom(){return this.zoom}zoomIn(t=.1){this.setZoom(this.zoom+t)}zoomOut(t=.1){this.setZoom(this.zoom-t)}worldToScreen(t){const e=(t.x-this.position.x)*this.zoom+this.width/2,i=(t.y-this.position.y)*this.zoom+this.height/2;return new c(e,i)}screenToWorld(t){const e=(t.x-this.width/2)/this.zoom+this.position.x,i=(t.y-this.height/2)/this.zoom+this.position.y;return new c(e,i)}getViewport(){const t=this.width/this.zoom,e=this.height/this.zoom;return{x:this.position.x-t/2,y:this.position.y-e/2,width:t,height:e}}updateSize(t,e){this.width=t,this.height=e}}class L{constructor(){n(this,"keys",new Map);n(this,"keysJustPressed",new Set);n(this,"mousePosition",{x:0,y:0});n(this,"mouseButtons",new Map);this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();this.keys.get(e)||this.keysJustPressed.add(e),this.keys.set(e,!0)}),window.addEventListener("keyup",t=>{this.keys.set(t.key.toLowerCase(),!1)})}setupMouseListeners(){window.addEventListener("mousemove",t=>{this.mousePosition={x:t.clientX,y:t.clientY}}),window.addEventListener("mousedown",t=>{this.mouseButtons.set(t.button,!0)}),window.addEventListener("mouseup",t=>{this.mouseButtons.set(t.button,!1)})}isKeyPressed(t){return this.keys.get(t.toLowerCase())??!1}isKeyJustPressed(t){return this.keysJustPressed.has(t.toLowerCase())}clearJustPressedKeys(){this.keysJustPressed.clear()}isMouseButtonPressed(t=0){return this.mouseButtons.get(t)??!1}getMousePosition(){return{...this.mousePosition}}getMovementInput(){let t=0,e=0;return(this.isKeyPressed("w")||this.isKeyPressed("arrowup"))&&(e-=1),(this.isKeyPressed("s")||this.isKeyPressed("arrowdown"))&&(e+=1),(this.isKeyPressed("a")||this.isKeyPressed("arrowleft"))&&(t-=1),(this.isKeyPressed("d")||this.isKeyPressed("arrowright"))&&(t+=1),{x:t,y:e}}}var f=(g=>(g.PISTOL="pistol",g.RIFLE="rifle",g.SHOTGUN="shotgun",g))(f||{}),R=(g=>(g.SEMI_AUTO="semi_auto",g.FULL_AUTO="full_auto",g))(R||{});class x{constructor(t,e=0){n(this,"type");n(this,"config");n(this,"currentAmmo");n(this,"reserveAmmo");n(this,"lastFireTime",0);n(this,"fireInterval");n(this,"isReloading",!1);n(this,"reloadStartTime",0);n(this,"isMouseDown",!1);this.type=t,this.config=this.getWeaponConfig(t),this.currentAmmo=this.config.magazineCapacity,this.reserveAmmo=e,this.fireInterval=1/this.config.fireRate}getWeaponConfig(t){switch(t){case"pistol":return{type:"pistol",damage:10,fireRate:5,range:300,bulletSpeed:500,bulletSize:3,accuracy:.9,magazineCapacity:10,reloadTime:.8,fireMode:"semi_auto",spread:0};case"rifle":return{type:"rifle",damage:20,fireRate:8,range:500,bulletSpeed:700,bulletSize:4,accuracy:.95,magazineCapacity:30,reloadTime:2,fireMode:"full_auto",spread:15};case"shotgun":return{type:"shotgun",damage:15,fireRate:1,range:150,bulletSpeed:400,bulletSize:2,accuracy:.95,magazineCapacity:6,reloadTime:1.2,fireMode:"semi_auto",spread:15,pelletsPerShot:8}}}canFire(t){return this.currentAmmo<=0||this.isReloading?!1:this.config.fireMode==="semi_auto"?t-this.lastFireTime>=this.fireInterval:this.isMouseDown&&t-this.lastFireTime>=this.fireInterval}fire(t){return this.canFire(t)?(this.currentAmmo--,this.lastFireTime=t,!0):!1}setMouseDown(t){this.isMouseDown=t}startReload(t){this.isReloading||this.currentAmmo===this.config.magazineCapacity||this.reserveAmmo>0&&(this.isReloading=!0,this.reloadStartTime=t)}updateReload(t){if(this.isReloading&&t-this.reloadStartTime>=this.config.reloadTime){this.isReloading=!1;const e=this.config.magazineCapacity-this.currentAmmo,i=Math.min(e,this.reserveAmmo);this.currentAmmo+=i,this.reserveAmmo-=i}}getReloadProgress(){return this.isReloading,0}isReloadingNow(){return this.isReloading}getConfig(){return{...this.config}}getCurrentAmmo(){return this.currentAmmo}getReserveAmmo(){return this.reserveAmmo}addReserveAmmo(t){this.reserveAmmo+=t}getTotalAmmo(){return this.currentAmmo+this.reserveAmmo}getType(){return this.type}getWeaponType(){return this.type}getName(){switch(this.type){case"pistol":return"手枪";case"rifle":return"步枪";case"shotgun":return"霰弹枪"}}}class b{constructor(t,e,i,s,o,r,l){n(this,"position");n(this,"velocity");n(this,"damage");n(this,"range");n(this,"size");n(this,"distanceTraveled",0);n(this,"color","#ffff00");n(this,"ownerId");this.position=t.clone(),this.velocity=e.normalize().multiply(s),this.damage=i,this.range=o,this.size=r,this.ownerId=l}update(t){const e=this.velocity.multiply(t);this.position=this.position.add(e),this.distanceTraveled+=e.length()}isOutOfRange(){return this.distanceTraveled>this.range}render(t,e){const i=e.worldToScreen(this.position);t.drawCircle(i,this.size*e.getZoom(),this.color,!0)}getPosition(){return this.position.clone()}getDamage(){return this.damage}getSize(){return this.size}getOwnerId(){return this.ownerId}getDirection(){return this.velocity.normalize()}}class k{constructor(){n(this,"bullets",[])}addBullet(t){this.bullets.push(t)}update(t){for(let e=this.bullets.length-1;e>=0;e--)this.bullets[e].update(t),this.bullets[e].isOutOfRange()&&this.bullets.splice(e,1)}render(t,e){for(const i of this.bullets)i.render(t,e)}getBullets(){return this.bullets}removeBullet(t){this.bullets.splice(t,1)}clear(){this.bullets=[]}getCount(){return this.bullets.length}}class v{constructor(t){n(this,"position");n(this,"velocity");n(this,"speed",150);n(this,"radius",8);n(this,"color","#00ff00");n(this,"collisionSystem",null);n(this,"playerId","player");n(this,"weapons",new Map);n(this,"currentWeaponType",f.PISTOL);n(this,"bulletManager");n(this,"direction",new c(1,0));n(this,"mousePosition",new c(0,0));n(this,"lastReloadTime",0);n(this,"shouldFire",!1);n(this,"maxHealth",100);n(this,"health",100);n(this,"isDead",!1);n(this,"currentVehicle",null);n(this,"weaponBeforeVehicle",f.PISTOL);this.position=t.clone(),this.velocity=new c(0,0),this.weapons.set(f.PISTOL,new x(f.PISTOL,1/0)),this.bulletManager=new k}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.playerId,{position:this.position.clone(),radius:this.radius,type:"circle"})}setMousePosition(t,e){this.mousePosition=new c(t,e)}getCurrentWeapon(){const t=this.weapons.get(this.currentWeaponType);if(!t)throw new Error(`Weapon type ${this.currentWeaponType} not found`);return t}fire(t){const e=this.getCurrentWeapon(),i=e.getConfig();if(!(i.fireMode===R.SEMI_AUTO&&!this.shouldFire)&&e.fire(t)){this.shouldFire=!1;const s=i.pelletsPerShot||1;for(let o=0;o<s;o++){let l=(Math.random()-.5)*i.spread*(Math.PI/180);if(i.spread>0&&i.accuracy<1){const u=i.accuracy,y=Math.random()*(1-u)*Math.PI*2;l+=y}const h=this.direction.clone(),a=h.x*Math.cos(l)-h.y*Math.sin(l),d=h.x*Math.sin(l)+h.y*Math.cos(l),p=new b(this.position.clone(),new c(a,d),i.damage,i.bulletSpeed,i.range,i.bulletSize,this.playerId);this.bulletManager.addBullet(p)}}}setMouseDown(t){this.getCurrentWeapon().setMouseDown(t),t&&(this.shouldFire=!0)}reload(t){this.getCurrentWeapon().startReload(t),this.lastReloadTime=t}getReloadProgress(t){const e=this.getCurrentWeapon();if(!e.isReloadingNow())return 0;const i=e.getConfig(),s=t-this.lastReloadTime;return Math.min(s/i.reloadTime,1)}isReloading(){return this.getCurrentWeapon().isReloadingNow()}switchWeapon(t){this.currentVehicle!==null&&t!==f.PISTOL||this.weapons.has(t)&&(this.currentWeaponType=t)}getCurrentWeaponType(){return this.currentWeaponType}enterVehicle(t){this.currentVehicle=t,this.weaponBeforeVehicle=this.currentWeaponType,this.currentWeaponType=f.PISTOL,t.enterVehicle(this.playerId)}exitVehicle(){if(this.currentVehicle!==null){const t=this.currentVehicle.getPosition(),e=50,i=this.currentVehicle.getRotation(),s=new c(t.x+Math.cos(i+Math.PI/2)*e,t.y+Math.sin(i+Math.PI/2)*e);this.position=s,this.collisionSystem&&this.collisionSystem.updatePosition(this.playerId,this.position),this.currentVehicle.exitVehicle(),this.weapons.has(this.weaponBeforeVehicle)&&(this.currentWeaponType=this.weaponBeforeVehicle),this.currentVehicle=null}}getCurrentVehicle(){return this.currentVehicle}isInVehicle(){return this.currentVehicle!==null}pickupWeapon(t){if(this.weapons.has(t)){const e=this.weapons.get(t),i=e.getConfig();e.addReserveAmmo(i.magazineCapacity)}else{const e=new x(t,0),i=e.getConfig();e.addReserveAmmo(i.magazineCapacity),this.weapons.set(t,e)}}update(t,e,i){if(this.currentVehicle!==null){e.x>0?this.currentVehicle.turnRight():e.x<0&&this.currentVehicle.turnLeft(),e.y<0?this.currentVehicle.accelerate():e.y>0&&this.currentVehicle.decelerate(),this.position=this.currentVehicle.getPosition().clone();const a=this.mousePosition.subtract(this.position);a.length()>0&&(this.direction=a.normalize()),this.bulletManager.update(t),this.getCurrentWeapon().updateReload(i);return}const s=this.mousePosition.subtract(this.position);s.length()>0&&(this.direction=s.normalize()),this.bulletManager.update(t),this.getCurrentWeapon().updateReload(i);let r=new c(e.x,e.y);r.length()>0&&(r=r.normalize().multiply(this.speed));const l=.2;this.velocity.x+=(r.x-this.velocity.x)*l,this.velocity.y+=(r.y-this.velocity.y)*l;const h=this.position.add(this.velocity.multiply(t));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.playerId,h),this.collisionSystem.getCollisions(this.playerId).length>0){const d=this.position.add(new c(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.playerId,d),this.collisionSystem.getCollisions(this.playerId).length===0)this.position=d;else{const u=this.position.add(new c(0,this.velocity.y*t));this.collisionSystem.updatePosition(this.playerId,u),this.collisionSystem.getCollisions(this.playerId).length===0?this.position=u:this.collisionSystem.updatePosition(this.playerId,this.position)}}else this.position=h;else this.position=h}render(t,e,i){const s=e.worldToScreen(this.position),o=e.getZoom();t.drawCircle(s,this.radius*o,this.color,!0);const r=this.radius*1.5*o,l=s.add(this.direction.multiply(r));t.drawLine(s,l,"#ffff00",1),this.renderWeaponIcon(t,s,o),this.renderHealthBar(t,s,o),this.bulletManager.render(t,e),this.isReloading()&&this.renderReloadAnimation(t,e,i)}renderHealthBar(t,e,i){const s=this.radius*2.5*i,o=3*i,r=e.y-this.radius*1.5*i,l=t.getContext();l.fillStyle="#000000",l.fillRect(e.x-s/2,r,s,o),l.strokeStyle="#ffffff",l.lineWidth=1,l.strokeRect(e.x-s/2,r,s,o);const h=this.health/this.maxHealth,a=s*h;h>.5?l.fillStyle="#00ff00":h>.25?l.fillStyle="#ffff00":l.fillStyle="#ff0000",l.fillRect(e.x-s/2,r,a,o)}renderWeaponIcon(t,e,i){const s=t.getContext(),r=this.getCurrentWeapon().getType(),l=this.radius*1.2*i,h=e.add(this.direction.multiply(l)),a=this.radius*.8*i;switch(s.save(),r){case f.PISTOL:s.fillStyle="#ffff00",s.beginPath(),s.arc(h.x,h.y,a,0,Math.PI*2),s.fill();break;case f.RIFLE:s.fillStyle="#00ff00",s.save(),s.translate(h.x,h.y),s.rotate(Math.atan2(this.direction.y,this.direction.x)),s.fillRect(-a,-a*.5,a*2,a),s.restore();break;case f.SHOTGUN:s.fillStyle="#ff6600",s.beginPath();for(let d=0;d<6;d++){const p=d*Math.PI/3,u=h.x+Math.cos(p)*a,y=h.y+Math.sin(p)*a;d===0?s.moveTo(u,y):s.lineTo(u,y)}s.closePath(),s.fill();break}s.restore()}renderReloadAnimation(t,e,i){const s=this.getReloadProgress(i),o=e.worldToScreen(this.mousePosition),r=20*e.getZoom(),l=t.getContext();l.strokeStyle="rgba(255, 255, 255, 0.3)",l.lineWidth=2,l.beginPath(),l.arc(o.x,o.y,r,0,Math.PI*2),l.stroke(),l.strokeStyle="#00ff00",l.lineWidth=3,l.beginPath(),l.arc(o.x,o.y,r,-Math.PI/2,-Math.PI/2+Math.PI*2*s),l.stroke()}getPosition(){return this.position.clone()}setPosition(t){this.position=t.clone()}getRadius(){return this.radius}getWeapon(){return this.getCurrentWeapon()}getBulletManager(){return this.bulletManager}getDirection(){return this.direction.clone()}takeDamage(t){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}}class D{constructor(t,e){n(this,"position");n(this,"velocity");n(this,"speed",40);n(this,"radius",6);n(this,"color","#4a90e2");n(this,"id");n(this,"behavior","idle");n(this,"collisionSystem",null);n(this,"patrolPoints",[]);n(this,"currentPatrolIndex",0);n(this,"idleTimer",0);n(this,"idleDuration",2);n(this,"targetPosition",null);n(this,"direction",new c(1,0));n(this,"visionRange",125);n(this,"visionAngle",120);n(this,"showVision",!0);n(this,"fleeRange",150);n(this,"maxHealth",50);n(this,"health",50);n(this,"isDead",!1);n(this,"lastShotTime",0);n(this,"shotCooldown",.5);n(this,"onShoot",null);this.id=t,this.position=e.clone(),this.velocity=new c(0,0),this.health=this.maxHealth}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:this.radius,type:"circle"})}setPatrolPoints(t){this.patrolPoints=t.map(e=>e.clone()),this.patrolPoints.length>0&&(this.behavior="patrol",this.targetPosition=this.patrolPoints[0].clone())}setBehavior(t){this.behavior=t,t==="idle"&&(this.idleTimer=0,this.velocity=new c(0,0))}getBehavior(){return this.behavior}update(t,e,i=0){if(this.velocity.length()>0&&(this.direction=this.velocity.normalize()),this.isPointInVision(e)){this.setBehavior("chase"),this.targetPosition=e.clone();const r=e.subtract(this.position);r.length()>0&&(this.direction=r.normalize()),this.tryShoot(i)}else this.behavior==="chase"&&this.setBehavior("patrol");switch(this.behavior){case"idle":this.updateIdle(t);break;case"patrol":this.updatePatrol(t);break;case"chase":this.updateChase(t);break;case"flee":this.updateFlee(t,e);break}const o=this.position.add(this.velocity.multiply(t));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.id,o),this.collisionSystem.getCollisions(this.id).length>0){const l=this.position.add(new c(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.id,l),this.collisionSystem.getCollisions(this.id).length===0)this.position=l;else{const a=this.position.add(new c(0,this.velocity.y*t));this.collisionSystem.updatePosition(this.id,a),this.collisionSystem.getCollisions(this.id).length===0?this.position=a:this.collisionSystem.updatePosition(this.id,this.position)}}else this.position=o;else this.position=o}updateIdle(t){this.idleTimer+=t,this.velocity=new c(0,0),this.idleTimer>this.idleDuration&&this.setBehavior("patrol")}updatePatrol(t){if(this.patrolPoints.length===0){this.setBehavior("idle");return}this.targetPosition||(this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone());const e=this.targetPosition.subtract(this.position);e.length()<10?(this.currentPatrolIndex=(this.currentPatrolIndex+1)%this.patrolPoints.length,this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone(),this.velocity=new c(0,0)):this.velocity=e.normalize().multiply(this.speed)}updateChase(t){if(!this.targetPosition)return;const e=this.targetPosition.subtract(this.position);e.length()>0&&(this.velocity=e.normalize().multiply(this.speed*1.2))}updateFlee(t,e){const i=this.position.subtract(e),s=i.length();s>this.fleeRange?this.setBehavior("patrol"):s>0&&(this.velocity=i.normalize().multiply(this.speed*1.5))}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom();this.showVision&&this.drawVisionCone(t,e,i),t.drawCircle(i,this.radius*s,this.color,!0);const o=this.radius*1.5*s,r=i.add(this.direction.multiply(o));t.drawLine(i,r,"#ffffff",1),this.drawHealthBar(t,i,s)}drawHealthBar(t,e,i){const s=this.radius*2.5*i,o=3*i,r=e.y-this.radius*1.5*i,l=t.getContext();l.fillStyle="#000000",l.fillRect(e.x-s/2,r,s,o),l.strokeStyle="#ffffff",l.lineWidth=1,l.strokeRect(e.x-s/2,r,s,o);const h=this.health/this.maxHealth,a=s*h;h>.5?l.fillStyle="#00ff00":h>.25?l.fillStyle="#ffff00":l.fillStyle="#ff0000",l.fillRect(e.x-s/2,r,a,o)}drawVisionCone(t,e,i){const s=e.getZoom(),o=this.visionRange*s,r=this.visionAngle/2,l=Math.atan2(this.direction.y,this.direction.x),h=l-r*Math.PI/180,a=l+r*Math.PI/180,d=i.add(new c(Math.cos(h)*o,Math.sin(h)*o)),p=i.add(new c(Math.cos(a)*o,Math.sin(a)*o));t.drawLine(i,d,"#4a90e2",1),t.drawLine(i,p,"#4a90e2",1);const u=t.getContext();u.strokeStyle="#4a90e2",u.lineWidth=1,u.beginPath(),u.arc(i.x,i.y,o,h,a),u.stroke(),u.fillStyle="rgba(74, 144, 226, 0.1)",u.beginPath(),u.moveTo(i.x,i.y),u.arc(i.x,i.y,o,h,a),u.lineTo(i.x,i.y),u.fill()}getPosition(){return this.position.clone()}setPosition(t){this.position=t.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position)}getRadius(){return this.radius}getId(){return this.id}getDirection(){return this.direction.clone()}getVisionRange(){return this.visionRange}getVisionAngle(){return this.visionAngle}isPointInVision(t){const e=t.subtract(this.position);if(e.length()>this.visionRange)return!1;const s=Math.atan2(e.y,e.x),o=Math.atan2(this.direction.y,this.direction.x),r=this.visionAngle/2;let l=s-o;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;return Math.abs(l)<=r*Math.PI/180}setShowVision(t){this.showVision=t}getShowVision(){return this.showVision}takeDamage(t,e){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0),e&&(this.setBehavior("chase"),this.targetPosition=e.clone()))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}tryShoot(t){this.onShoot&&t-this.lastShotTime>=this.shotCooldown&&(this.lastShotTime=t,this.onShoot(this.position.clone(),this.direction.clone()))}setOnShoot(t){this.onShoot=t}}class C{constructor(){n(this,"npcs",new Map);n(this,"collisionSystem",null);n(this,"maxNPCs",5);n(this,"_spawnRange",600);n(this,"despawnRange",1e3);n(this,"npcIdCounter",0)}setCollisionSystem(t){this.collisionSystem=t;for(const e of this.npcs.values())e.setCollisionSystem(t)}createNPC(t,e){const i=new D(t,e);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),this.npcs.set(t,i),i}getNPC(t){return this.npcs.get(t)}removeNPC(t){return this.npcs.delete(t)}getAllNPCs(){return Array.from(this.npcs.values())}getNPCCount(){return this.npcs.size}update(t,e,i=0){const s=[];for(const[o,r]of this.npcs.entries())r.update(t,e,i),(r.getPosition().distance(e)>this.despawnRange||r.getIsDead())&&s.push(o);for(const o of s)this.removeNPC(o);this.spawnNPCsAroundPlayer(e)}spawnNPCsAroundPlayer(t){if(this.npcs.size>=this.maxNPCs)return;const e=this.maxNPCs-this.npcs.size;for(let i=0;i<e;i++){const s=Math.random()*Math.PI*2,o=400+Math.random()*200,r=t.x+Math.cos(s)*o,l=t.y+Math.sin(s)*o,h=`npc_${this.npcIdCounter++}`,a=this.createNPC(h,new c(r,l)),d=[new c(r,l),new c(r+200,l),new c(r+200,l+200),new c(r,l+200)];a.setPatrolPoints(d)}}render(t,e){for(const i of this.npcs.values())i.render(t,e)}clear(){this.npcs.clear()}}class N{constructor(){n(this,"colliders",new Map)}register(t,e){this.colliders.set(t,e)}unregister(t){this.colliders.delete(t)}updatePosition(t,e){const i=this.colliders.get(t);i&&(i.position=e.clone())}circleToCircle(t,e){return t.position.distance(e.position)<t.radius+e.radius}circleToRect(t,e){const i=e.position.x,s=e.position.x+(e.width||0),o=e.position.y,r=e.position.y+(e.height||0),l=Math.max(i,Math.min(t.position.x,s)),h=Math.max(o,Math.min(t.position.y,r));return Math.sqrt((t.position.x-l)**2+(t.position.y-h)**2)<t.radius}rectToRect(t,e){return t.position.x<e.position.x+(e.width||0)&&t.position.x+(t.width||0)>e.position.x&&t.position.y<e.position.y+(e.height||0)&&t.position.y+(t.height||0)>e.position.y}isColliding(t,e){const i=this.colliders.get(t),s=this.colliders.get(e);return!i||!s?!1:i.type==="circle"&&s.type==="circle"?this.circleToCircle(i,s):i.type==="circle"&&s.type==="rect"?this.circleToRect(i,s):i.type==="rect"&&s.type==="circle"?this.circleToRect(s,i):this.rectToRect(i,s)}getCollisions(t){const e=[];for(const[i]of this.colliders)i!==t&&this.isColliding(t,i)&&e.push(i);return e}pointInCollider(t,e){const i=this.colliders.get(e);return i?i.type==="circle"?t.distance(i.position)<i.radius:t.x>=i.position.x&&t.x<=i.position.x+(i.width||0)&&t.y>=i.position.y&&t.y<=i.position.y+(i.height||0):!1}getCollider(t){return this.colliders.get(t)}getCollisionNormal(t,e){const i=this.colliders.get(t),s=this.colliders.get(e);if(!i||!s)return null;const o=s.position.subtract(i.position);return o.length()===0?new c(1,0):o.normalize()}getCollisionNormalCircleRect(t,e){const i=this.colliders.get(t),s=this.colliders.get(e);if(!i||!s)return null;const o=s.position.x,r=s.position.x+(s.width||0),l=s.position.y,h=s.position.y+(s.height||0),a=Math.max(o,Math.min(i.position.x,r)),d=Math.max(l,Math.min(i.position.y,h)),p=new c(i.position.x-a,i.position.y-d);return p.length()===0?new c(1,0):p.normalize()}clear(){this.colliders.clear()}}class O{constructor(t,e,i=32){n(this,"tileSize");n(this,"elementMap",new Map);n(this,"collisionSystem");n(this,"chunkSize",10);n(this,"generatedChunks",new Set);n(this,"buildingIdCounter",0);this.tileSize=i,this.collisionSystem=new N}getChunkKey(t,e){return`${t},${e}`}_getTileChunk(t,e){return{x:Math.floor(t/this.chunkSize),y:Math.floor(e/this.chunkSize)}}generateChunk(t,e){const i=this.getChunkKey(t,e);if(this.generatedChunks.has(i))return;this.generatedChunks.add(i);const s=t*this.chunkSize,o=e*this.chunkSize,r=s+this.chunkSize,l=o+this.chunkSize;for(let h=o;h<l;h++)for(let a=s;a<r;a++){const d=`${a},${h}`;this.elementMap.set(d,{x:a*this.tileSize,y:h*this.tileSize,width:this.tileSize,height:this.tileSize,type:"grass",color:"#2d5016"})}this.generateRoadsInChunk(s,o,r,l),this.generateBuildingsInChunk(s,o,r,l)}generateRoadsInChunk(t,e,i,s){for(let o=e;o<s;o++)if(o%8===0)for(let r=t;r<i;r++){const l=`${r},${o}`,h=this.elementMap.get(l);h&&(h.type="road",h.color="#444444")}for(let o=t;o<i;o++)if(o%8===0)for(let r=e;r<s;r++){const l=`${o},${r}`,h=this.elementMap.get(l);h&&(h.type="road",h.color="#444444")}}generateBuildingsInChunk(t,e,i,s){const o=["#8b4513","#a0522d","#cd853f","#daa520"];for(let r=e+2;r<s-2;r+=10)for(let l=t+2;l<i-2;l+=10){const h=l*73856093^r*19349663,a=Math.abs(Math.sin(h)*1e4)%1,d=Math.abs(Math.sin(h+1)*1e4)%1,p=2+a*3|0,u=2+d*3|0;for(let y=0;y<u;y++)for(let w=0;w<p;w++){const S=l+w,M=r+y;if(S<i&&M<s){const B=`${S},${M}`,m=this.elementMap.get(B);if(m){const P=`building_${this.buildingIdCounter++}`;m.type="building",m.color=o[Math.floor(a*o.length)],m.id=P,this.collisionSystem.register(P,{position:new c(m.x,m.y),radius:0,type:"rect",width:m.width,height:m.height})}}}}}ensureChunksGenerated(t){const e=Math.floor(t.x/this.tileSize),i=Math.floor(t.y/this.tileSize),s=Math.ceil((t.x+t.width)/this.tileSize),o=Math.ceil((t.y+t.height)/this.tileSize),r=Math.floor(e/this.chunkSize),l=Math.floor(i/this.chunkSize),h=Math.ceil(s/this.chunkSize),a=Math.ceil(o/this.chunkSize);for(let d=l;d<a;d++)for(let p=r;p<h;p++)this.generateChunk(p,d)}render(t,e){const i=e.getViewport(),s=e.getZoom();this.ensureChunksGenerated(i);for(const o of this.elementMap.values()){if(o.x+o.width<i.x||o.x>i.x+i.width||o.y+o.height<i.y||o.y>i.y+i.height)continue;const r=e.worldToScreen(new c(o.x,o.y)),l=o.width*s,h=o.height*s;t.drawRect(r,l,h,o.color,!0),t.drawRect(r,l,h,"#333333",!1)}}getTileSize(){return this.tileSize}getCollisionSystem(){return this.collisionSystem}getBuildings(){return Array.from(this.elementMap.values()).filter(t=>t.type==="building")}}class H{constructor(t,e,i){n(this,"position");n(this,"type");n(this,"weaponType");n(this,"radius",8);n(this,"color");n(this,"id");n(this,"rotationAngle",0);this.id=t,this.position=e.clone(),this.type="weapon",this.weaponType=i,this.color=this.getColorByWeapon(i)}getColorByWeapon(t){switch(t){case f.PISTOL:return"#ffff00";case f.RIFLE:return"#00ff00";case f.SHOTGUN:return"#ff6600"}}update(t){this.rotationAngle+=t*3}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom(),o=t.getContext();switch(o.save(),o.translate(i.x,i.y),o.rotate(this.rotationAngle),this.weaponType){case f.PISTOL:this.drawPistolIcon(o,s);break;case f.RIFLE:this.drawRifleIcon(o,s);break;case f.SHOTGUN:this.drawShotgunIcon(o,s);break}o.restore(),t.drawCircle(i,3*s,"#ffffff",!0),this.drawWeaponLabel(t,i,s)}drawWeaponLabel(t,e,i){const s=t.getContext();let o="";switch(this.weaponType){case f.RIFLE:o="步枪";break;case f.SHOTGUN:o="霰弹枪";break;default:return}s.fillStyle=this.color,s.font=`${12*i}px Arial`,s.textAlign="center",s.textBaseline="top",s.fillText(o,e.x,e.y+this.radius*1.5*i)}drawPistolIcon(t,e){t.fillStyle=this.color,t.beginPath();for(let i=0;i<5;i++){const s=i*4*Math.PI/5-Math.PI/2,o=Math.cos(s)*this.radius*e,r=Math.sin(s)*this.radius*e;i===0?t.moveTo(o,r):t.lineTo(o,r)}t.closePath(),t.fill()}drawRifleIcon(t,e){t.fillStyle=this.color;const i=this.radius*1.5*e,s=this.radius*.8*e;t.fillRect(-i/2,-s/2,i,s),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(-i/2,-s/2,i,s)}drawShotgunIcon(t,e){t.fillStyle=this.color,t.beginPath(),t.arc(0,0,this.radius*e,0,Math.PI*2),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=1,t.stroke(),t.strokeStyle="#ffffff",t.lineWidth=.5;for(let i=0;i<3;i++){const s=i*Math.PI/3,o=Math.cos(s)*this.radius*.5*e,r=Math.sin(s)*this.radius*.5*e;t.beginPath(),t.moveTo(0,0),t.lineTo(o,r),t.stroke()}}getPosition(){return this.position.clone()}getId(){return this.id}getWeaponType(){return this.weaponType}getRadius(){return this.radius}}class I{constructor(){n(this,"items",new Map);n(this,"itemIdCounter",0)}addItem(t,e){const i=`item_${this.itemIdCounter++}`,s=new H(i,t,e);return this.items.set(i,s),s}removeItem(t){return this.items.delete(t)}getItem(t){return this.items.get(t)}getAllItems(){return Array.from(this.items.values())}update(t){for(const e of this.items.values())e.update(t)}render(t,e){for(const i of this.items.values())i.render(t,e)}getCount(){return this.items.size}clear(){this.items.clear()}}class E{constructor(t,e){n(this,"position");n(this,"velocity");n(this,"speed",600);n(this,"maxSpeed",900);n(this,"acceleration",450);n(this,"friction",.98);n(this,"width",40);n(this,"height",24);n(this,"color","#ff0000");n(this,"rotation",0);n(this,"id");n(this,"collisionSystem",null);n(this,"isOccupied",!1);n(this,"occupantId",null);n(this,"maxHealth",100);n(this,"health",100);n(this,"isDead",!1);n(this,"restitution",.6);n(this,"lastCollisionNormal",null);this.id=t,this.position=e.clone(),this.velocity=new c(0,0)}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:Math.max(this.width,this.height)/2,type:"circle"})}getId(){return this.id}getPosition(){return this.position.clone()}getWidth(){return this.width}getHeight(){return this.height}isOccupiedByPlayer(){return this.isOccupied}getOccupantId(){return this.occupantId}enterVehicle(t){this.isOccupied=!0,this.occupantId=t}exitVehicle(){this.isOccupied=!1,this.occupantId=null,this.velocity=new c(0,0)}setPosition(t){this.position=t.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position.clone())}setRotation(t){this.rotation=t}getRotation(){return this.rotation}accelerate(){if(this.velocity.length()<this.maxSpeed){const e=new c(Math.cos(this.rotation),Math.sin(this.rotation));this.velocity=this.velocity.add(e.multiply(this.acceleration*.016))}}decelerate(){this.velocity=this.velocity.multiply(.85)}turnLeft(){this.rotation-=.05}turnRight(){this.rotation+=.05}update(t){this.velocity=this.velocity.multiply(this.friction);const e=this.position.add(this.velocity.multiply(t));if(this.collisionSystem){this.collisionSystem.updatePosition(this.id,e);const i=this.collisionSystem.getCollisions(this.id);if(i.length>0){const s=this.velocity.length(),o=this.position.add(new c(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.id,o),this.collisionSystem.getCollisions(this.id).length===0)this.position=o,this.velocity=new c(this.velocity.x,-this.velocity.y*this.restitution);else{const l=this.position.add(new c(0,this.velocity.y*t));if(this.collisionSystem.updatePosition(this.id,l),this.collisionSystem.getCollisions(this.id).length===0)this.position=l,this.velocity=new c(-this.velocity.x*this.restitution,this.velocity.y);else{this.collisionSystem.updatePosition(this.id,this.position);let a=null;for(const d of i){const p=this.collisionSystem.getCollider(this.id),u=this.collisionSystem.getCollider(d);if(p&&u&&(p.type==="circle"&&u.type==="circle"?a=this.collisionSystem.getCollisionNormal(this.id,d):p.type==="circle"&&u.type==="rect"&&(a=this.collisionSystem.getCollisionNormalCircleRect(this.id,d)),a)){this.lastCollisionNormal=a;break}}if(a){const d=this.velocity.x*a.x+this.velocity.y*a.y;if(d<0){const p=(1+this.restitution)*d,u=new c(this.velocity.x-p*a.x,this.velocity.y-p*a.y);this.velocity=u}}else this.velocity=this.velocity.multiply(-this.restitution);if(s>50){const d=Math.max(1,Math.floor(s/30));this.takeDamage(d)}}}}else this.position=e}else this.position=e}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom(),o=t.getContext();o.save(),o.translate(i.x,i.y),o.rotate(this.rotation),o.fillStyle=this.color,o.fillRect(-this.width/2*s,-this.height/2*s,this.width*s,this.height*s),o.fillStyle="#87ceeb",o.fillRect(-this.width/3*s,-this.height/3*s,this.width/1.5*s,this.height/3*s),o.fillStyle="#ffff00",o.fillRect(-this.width/2*s,-this.height/4*s,3*s,3*s),o.fillRect(this.width/2*s-3*s,-this.height/4*s,3*s,3*s),o.restore(),this.isOccupied||(o.strokeStyle="#00ff00",o.lineWidth=2,o.strokeRect(i.x-this.width/2*s,i.y-this.height/2*s,this.width*s,this.height*s)),this.renderHealthBar(t,i,s)}renderHealthBar(t,e,i){const s=t.getContext(),o=this.width*i,r=4*i,l=this.height/2*i+8*i;s.fillStyle="#000000",s.fillRect(e.x-o/2,e.y+l,o,r),s.strokeStyle="#ffffff",s.lineWidth=1,s.strokeRect(e.x-o/2,e.y+l,o,r);const h=this.health/this.maxHealth,a=o*h;h>.5?s.fillStyle="#00ff00":h>.25?s.fillStyle="#ffff00":s.fillStyle="#ff0000",s.fillRect(e.x-o/2,e.y+l,a,r)}isPlayerNearby(t,e=50){return this.position.subtract(t).length()<e}takeDamage(t){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}getRadius(){return Math.max(this.width,this.height)/2}setRestitution(t){this.restitution=Math.max(0,Math.min(1,t))}getRestitution(){return this.restitution}getLastCollisionNormal(){return this.lastCollisionNormal}}class F{constructor(){n(this,"vehicles",new Map);n(this,"vehicleIdCounter",0);n(this,"collisionSystem",null);n(this,"maxVehicles",5);n(this,"spawnRange",800);n(this,"despawnRange",1200)}setCollisionSystem(t){this.collisionSystem=t}spawnVehicle(t){if(this.vehicles.size>=this.maxVehicles)return Array.from(this.vehicles.values())[0];const e=`vehicle_${this.vehicleIdCounter++}`,i=new E(e,t);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),this.vehicles.set(e,i),i}getVehicles(){return Array.from(this.vehicles.values())}getNearbyVehicles(t,e=100){return Array.from(this.vehicles.values()).filter(i=>i.isPlayerNearby(t,e))}getPlayerVehicle(t){for(const e of this.vehicles.values())if(e.getOccupantId()===t)return e;return null}update(t,e){const i=[];for(const[s,o]of this.vehicles){if(o.update(t),o.getIsDead()){i.push(s);continue}o.getPosition().subtract(e).length()>this.despawnRange&&i.push(s)}for(const s of i)this.vehicles.delete(s);if(this.vehicles.size<this.maxVehicles&&Math.random()<.01){const s=Math.random()*Math.PI*2,o=400+Math.random()*400,r=new c(e.x+Math.cos(s)*o,e.y+Math.sin(s)*o);this.spawnVehicle(r)}}render(t,e){for(const i of this.vehicles.values())i.render(t,e)}getCount(){return this.vehicles.size}}class Y{constructor(){n(this,"renderer");n(this,"camera");n(this,"inputManager");n(this,"player");n(this,"npcManager");n(this,"gameMap");n(this,"itemManager");n(this,"vehicleManager");n(this,"isRunning",!1);n(this,"frameCount",0);n(this,"lastFrameTime",0);n(this,"fps",0);n(this,"itemSpawnTimer",0);n(this,"itemSpawnInterval",3);n(this,"maxItems",3);n(this,"itemSpawnRange",600);n(this,"score",0);n(this,"gameOver",!1);n(this,"npcBulletManager");n(this,"gameLoop",()=>{if(!this.isRunning)return;const t=performance.now(),e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this.update(e),this.render(),this.frameCount++,t-this.lastFrameTime>1e3&&(this.fps=this.frameCount,this.frameCount=0),requestAnimationFrame(this.gameLoop)});this.renderer=new V("game-canvas"),this.camera=new W(this.renderer.getWidth(),this.renderer.getHeight()),this.inputManager=new L,this.gameMap=new O(0,0,32),this.npcManager=new C,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.setupNPCShootCallback(),this.itemManager=new I,this.vehicleManager=new F,this.vehicleManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcBulletManager=new k,this.player=new v(new c(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.camera.setPosition(this.player.getPosition()),window.addEventListener("resize",()=>{this.camera.updateSize(this.renderer.getWidth(),this.renderer.getHeight())}),document.addEventListener("mousedown",t=>{t.button===0&&this.player.setMouseDown(!0)}),document.addEventListener("mouseup",t=>{t.button===0&&this.player.setMouseDown(!1)})}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.gameLoop())}stop(){this.isRunning=!1}update(t){if(this.gameOver){this.inputManager.isKeyPressed("r")&&this.restartGame();return}const e=this.inputManager.getMovementInput(),i=this.inputManager.getMousePosition(),s=this.camera.screenToWorld(new c(i.x,i.y));this.player.setMousePosition(s.x,s.y);const o=performance.now()/1e3;this.player.fire(o),this.inputManager.isKeyPressed("r")&&this.player.reload(o),this.inputManager.isKeyPressed("1")&&this.player.switchWeapon(f.PISTOL),this.inputManager.isKeyPressed("2")&&this.player.switchWeapon(f.RIFLE),this.inputManager.isKeyPressed("3")&&this.player.switchWeapon(f.SHOTGUN),this.player.update(t,e,o),this.vehicleManager.update(t,this.player.getPosition()),this.handleVehicleInteraction(),this.npcManager.update(t,this.player.getPosition(),o),this.npcBulletManager.update(t),this.itemManager.update(t),this.itemSpawnTimer+=t,this.itemSpawnTimer>=this.itemSpawnInterval&&(this.itemSpawnTimer=0,this.itemManager.getCount()<this.maxItems&&this.spawnRandomItem()),this.cleanupFarItems(),this.checkItemPickup(),this.checkBulletHits(),this.checkNPCBulletHits(),this.cleanupNPCBullets(),this.checkDestroyedVehicles(),this.player.getIsDead()&&(this.gameOver=!0),this.camera.follow(this.player.getPosition(),.1),this.inputManager.isKeyPressed("q")&&this.camera.zoomOut(.02),this.inputManager.isKeyPressed("e")&&this.camera.zoomIn(.02),this.updateHUD(),this.inputManager.clearJustPressedKeys()}spawnRandomItem(){for(let t=0;t<5;t++){const e=Math.random()*Math.PI*2,i=300+Math.random()*300,s=this.player.getPosition().x+Math.cos(e)*i,o=this.player.getPosition().y+Math.sin(e)*i;if(!this.isPositionInBuilding(new c(s,o))){const r=[f.RIFLE,f.SHOTGUN],l=r[Math.floor(Math.random()*r.length)];this.itemManager.addItem(new c(s,o),l);return}}}cleanupFarItems(){const t=this.player.getPosition(),e=this.itemManager.getAllItems();for(const i of e)t.distance(i.getPosition())>this.itemSpawnRange&&this.itemManager.removeItem(i.getId())}isPositionInBuilding(t){const e=this.gameMap.getBuildings();for(const i of e)if(t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height)return!0;return!1}handleVehicleInteraction(){if(this.player.isInVehicle()){this.inputManager.isKeyJustPressed("f")&&this.player.exitVehicle();return}const t=this.vehicleManager.getNearbyVehicles(this.player.getPosition(),100);if(t.length>0&&this.inputManager.isKeyJustPressed("f")){const e=t[0];this.player.enterVehicle(e)}}checkItemPickup(){const t=this.player.getPosition(),e=this.player.getRadius();for(const i of this.itemManager.getAllItems())t.distance(i.getPosition())<e+i.getRadius()&&(this.player.pickupWeapon(i.getWeaponType()),this.itemManager.removeItem(i.getId()))}setupNPCShootCallback(){const t=this.npcManager.createNPC.bind(this.npcManager);this.npcManager.createNPC=(e,i)=>{const s=t(e,i);return s.setOnShoot((o,r)=>{const l=new b(o,r,10,500,300,3,e);this.npcBulletManager.addBullet(l)}),s}}restartGame(){this.score=0,this.gameOver=!1,this.npcBulletManager.clear(),this.player=new v(new c(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcManager=new C,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.setupNPCShootCallback(),this.itemManager=new I}checkBulletHits(){const t=this.player.getBulletManager().getBullets(),e=this.npcManager.getAllNPCs(),i=this.vehicleManager.getVehicles();for(let s=t.length-1;s>=0;s--){const o=t[s],r=o.getPosition(),l=o.getSize();let h=!1;for(const a of e){if(a.getIsDead())continue;const d=a.getPosition(),p=a.getRadius();if(r.distance(d)<l+p){const y=o.getDamage();a.takeDamage(y,this.player.getPosition()),a.getIsDead()&&this.score++,h=!0;break}}if(!h)for(const a of i){if(a.getIsDead())continue;const d=a.getPosition(),p=a.getRadius();if(r.distance(d)<l+p){const y=o.getDamage();a.takeDamage(y),h=!0;break}}h&&this.player.getBulletManager().removeBullet(s)}}checkNPCBulletHits(){const t=this.npcBulletManager.getBullets(),e=this.player.getPosition(),i=this.player.getRadius(),s=this.vehicleManager.getVehicles();for(let o=t.length-1;o>=0;o--){const r=t[o],l=r.getPosition(),h=r.getSize();let a=!1;if(!this.player.isInVehicle()&&l.distance(e)<h+i){const p=r.getDamage();this.player.takeDamage(p),a=!0}if(!a)for(const d of s){if(d.getIsDead())continue;const p=d.getPosition(),u=d.getRadius();if(l.distance(p)<h+u){const w=r.getDamage();d.takeDamage(w),a=!0;break}}a&&this.npcBulletManager.removeBullet(o)}}cleanupNPCBullets(){const t=this.npcBulletManager.getBullets(),e=this.player.getPosition();for(let i=t.length-1;i>=0;i--)t[i].getPosition().distance(e)>1e3&&this.npcBulletManager.removeBullet(i)}checkDestroyedVehicles(){if(this.player.isInVehicle()){const t=this.vehicleManager.getPlayerVehicle("player");t&&t.getIsDead()&&this.player.exitVehicle()}}render(){this.renderer.clear(),this.gameMap.render(this.renderer,this.camera),this.itemManager.render(this.renderer,this.camera),this.vehicleManager.render(this.renderer,this.camera),this.npcManager.render(this.renderer,this.camera),this.npcBulletManager.render(this.renderer,this.camera);const t=performance.now()/1e3;this.player.render(this.renderer,this.camera,t),this.drawDebugGrid(),this.gameOver&&this.drawGameOverScreen()}drawGameOverScreen(){const t=this.renderer.getContext(),e=this.renderer.getWidth(),i=this.renderer.getHeight();t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,e,i),t.fillStyle="#ff0000",t.font="bold 48px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("GAME OVER",e/2,i/2-60),t.fillStyle="#ffff00",t.font="bold 36px Arial",t.fillText(`最终得分: ${this.score}`,e/2,i/2+20),t.fillStyle="#00ff00",t.font="24px Arial",t.fillText("按 R 键重新开始",e/2,i/2+80)}drawDebugGrid(){const t=this.camera.getViewport(),e=32,i=Math.floor(t.x/e)*e,s=Math.floor(t.y/e)*e,o=i+t.width+e,r=s+t.height+e;for(let l=i;l<o;l+=e){const h=this.camera.worldToScreen(new c(l,s)),a=this.camera.worldToScreen(new c(l,r));this.renderer.drawLine(h,a,"#444444",.5)}for(let l=s;l<r;l+=e){const h=this.camera.worldToScreen(new c(i,l)),a=this.camera.worldToScreen(new c(o,l));this.renderer.drawLine(h,a,"#444444",.5)}}updateHUD(){const t=document.getElementById("score"),e=document.getElementById("weapon"),i=document.getElementById("ammo");if(t&&(t.textContent=`得分: ${this.score}`),e){const o=this.player.getWeapon().getName(),r=this.player.isReloading()?" [装弹中]":"";e.textContent=`武器: ${o}${r}`}if(i){const s=this.player.getWeapon(),o=s.getCurrentAmmo(),r=s.getReserveAmmo();i.textContent=`弹药: ${o}/${r}`}this.updateControlsDisplay()}updateControlsDisplay(){const t=document.getElementById("controls-walking"),e=document.getElementById("controls-driving");!t||!e||(this.player.isInVehicle()?(t.style.display="none",e.style.display="block"):(t.style.display="block",e.style.display="none"))}}const T=new Y;T.start();window.game=T;
