var B=Object.defineProperty;var A=(d,t,e)=>t in d?B(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var o=(d,t,e)=>A(d,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const h of n.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class W{constructor(t){o(this,"canvas");o(this,"ctx");o(this,"width");o(this,"height");const e=document.getElementById(t);if(!e)throw new Error(`Canvas element with id "${t}" not found`);this.canvas=e,this.ctx=e.getContext("2d"),this.width=window.innerWidth,this.height=window.innerHeight,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height}clear(t="#2a2a2a"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height)}drawRect(t,e,i,s,n=!0){this.ctx.fillStyle=s,this.ctx.strokeStyle=s,n?this.ctx.fillRect(t.x,t.y,e,i):this.ctx.strokeRect(t.x,t.y,e,i)}drawCircle(t,e,i,s=!0){this.ctx.fillStyle=i,this.ctx.strokeStyle=i,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,Math.PI*2),s?this.ctx.fill():this.ctx.stroke()}drawLine(t,e,i,s=1){this.ctx.strokeStyle=i,this.ctx.lineWidth=s,this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}drawText(t,e,i,s=16,n="Arial"){this.ctx.fillStyle=i,this.ctx.font=`${s}px ${n}`,this.ctx.fillText(t,e.x,e.y)}getWidth(){return this.width}getHeight(){return this.height}getContext(){return this.ctx}}class c{constructor(t=0,e=0){o(this,"x");o(this,"y");this.x=t,this.y=e}add(t){return new c(this.x+t.x,this.y+t.y)}subtract(t){return new c(this.x-t.x,this.y-t.y)}multiply(t){return new c(this.x*t,this.y*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t===0?new c(0,0):new c(this.x/t,this.y/t)}distance(t){return this.subtract(t).length()}clone(){return new c(this.x,this.y)}set(t,e){return this.x=t,this.y=e,this}}class V{constructor(t,e){o(this,"position");o(this,"zoom");o(this,"width");o(this,"height");o(this,"minZoom",.5);o(this,"maxZoom",3);this.position=new c(0,0),this.zoom=1,this.width=t,this.height=e}setPosition(t){this.position=t.clone()}getPosition(){return this.position.clone()}follow(t,e=.1){const i=t.subtract(this.position);this.position=this.position.add(i.multiply(e))}setZoom(t){this.zoom=Math.max(this.minZoom,Math.min(t,this.maxZoom))}getZoom(){return this.zoom}zoomIn(t=.1){this.setZoom(this.zoom+t)}zoomOut(t=.1){this.setZoom(this.zoom-t)}worldToScreen(t){const e=(t.x-this.position.x)*this.zoom+this.width/2,i=(t.y-this.position.y)*this.zoom+this.height/2;return new c(e,i)}screenToWorld(t){const e=(t.x-this.width/2)/this.zoom+this.position.x,i=(t.y-this.height/2)/this.zoom+this.position.y;return new c(e,i)}getViewport(){const t=this.width/this.zoom,e=this.height/this.zoom;return{x:this.position.x-t/2,y:this.position.y-e/2,width:t,height:e}}updateSize(t,e){this.width=t,this.height=e}}class L{constructor(){o(this,"keys",new Map);o(this,"keysJustPressed",new Set);o(this,"mousePosition",{x:0,y:0});o(this,"mouseButtons",new Map);this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();this.keys.get(e)||this.keysJustPressed.add(e),this.keys.set(e,!0)}),window.addEventListener("keyup",t=>{this.keys.set(t.key.toLowerCase(),!1)})}setupMouseListeners(){window.addEventListener("mousemove",t=>{this.mousePosition={x:t.clientX,y:t.clientY}}),window.addEventListener("mousedown",t=>{this.mouseButtons.set(t.button,!0)}),window.addEventListener("mouseup",t=>{this.mouseButtons.set(t.button,!1)})}isKeyPressed(t){return this.keys.get(t.toLowerCase())??!1}isKeyJustPressed(t){return this.keysJustPressed.has(t.toLowerCase())}clearJustPressedKeys(){this.keysJustPressed.clear()}isMouseButtonPressed(t=0){return this.mouseButtons.get(t)??!1}getMousePosition(){return{...this.mousePosition}}getMovementInput(){let t=0,e=0;return(this.isKeyPressed("w")||this.isKeyPressed("arrowup"))&&(e-=1),(this.isKeyPressed("s")||this.isKeyPressed("arrowdown"))&&(e+=1),(this.isKeyPressed("a")||this.isKeyPressed("arrowleft"))&&(t-=1),(this.isKeyPressed("d")||this.isKeyPressed("arrowright"))&&(t+=1),{x:t,y:e}}}var p=(d=>(d.PISTOL="pistol",d.RIFLE="rifle",d.SHOTGUN="shotgun",d))(p||{}),b=(d=>(d.SEMI_AUTO="semi_auto",d.FULL_AUTO="full_auto",d))(b||{});class x{constructor(t,e=0){o(this,"type");o(this,"config");o(this,"currentAmmo");o(this,"reserveAmmo");o(this,"lastFireTime",0);o(this,"fireInterval");o(this,"isReloading",!1);o(this,"reloadStartTime",0);o(this,"isMouseDown",!1);this.type=t,this.config=this.getWeaponConfig(t),this.currentAmmo=this.config.magazineCapacity,this.reserveAmmo=e,this.fireInterval=1/this.config.fireRate}getWeaponConfig(t){switch(t){case"pistol":return{type:"pistol",damage:10,fireRate:5,range:300,bulletSpeed:500,bulletSize:3,accuracy:.9,magazineCapacity:10,reloadTime:.8,fireMode:"semi_auto",spread:0};case"rifle":return{type:"rifle",damage:20,fireRate:8,range:500,bulletSpeed:700,bulletSize:4,accuracy:.95,magazineCapacity:30,reloadTime:2,fireMode:"full_auto",spread:15};case"shotgun":return{type:"shotgun",damage:15,fireRate:1,range:150,bulletSpeed:400,bulletSize:2,accuracy:.95,magazineCapacity:6,reloadTime:1.2,fireMode:"semi_auto",spread:15,pelletsPerShot:8}}}canFire(t){return this.currentAmmo<=0||this.isReloading?!1:this.config.fireMode==="semi_auto"?t-this.lastFireTime>=this.fireInterval:this.isMouseDown&&t-this.lastFireTime>=this.fireInterval}fire(t){return this.canFire(t)?(this.currentAmmo--,this.lastFireTime=t,!0):!1}setMouseDown(t){this.isMouseDown=t}startReload(t){this.isReloading||this.currentAmmo===this.config.magazineCapacity||this.reserveAmmo>0&&(this.isReloading=!0,this.reloadStartTime=t)}updateReload(t){if(this.isReloading&&t-this.reloadStartTime>=this.config.reloadTime){this.isReloading=!1;const e=this.config.magazineCapacity-this.currentAmmo,i=Math.min(e,this.reserveAmmo);this.currentAmmo+=i,this.reserveAmmo-=i}}getReloadProgress(){return this.isReloading,0}isReloadingNow(){return this.isReloading}getConfig(){return{...this.config}}getCurrentAmmo(){return this.currentAmmo}getReserveAmmo(){return this.reserveAmmo}addReserveAmmo(t){this.reserveAmmo+=t}getTotalAmmo(){return this.currentAmmo+this.reserveAmmo}getType(){return this.type}getWeaponType(){return this.type}getName(){switch(this.type){case"pistol":return"手枪";case"rifle":return"步枪";case"shotgun":return"霰弹枪"}}}class R{constructor(t,e,i,s,n,h,r){o(this,"position");o(this,"velocity");o(this,"damage");o(this,"range");o(this,"size");o(this,"distanceTraveled",0);o(this,"color","#ffff00");o(this,"ownerId");this.position=t.clone(),this.velocity=e.normalize().multiply(s),this.damage=i,this.range=n,this.size=h,this.ownerId=r}update(t){const e=this.velocity.multiply(t);this.position=this.position.add(e),this.distanceTraveled+=e.length()}isOutOfRange(){return this.distanceTraveled>this.range}render(t,e){const i=e.worldToScreen(this.position);t.drawCircle(i,this.size*e.getZoom(),this.color,!0)}getPosition(){return this.position.clone()}getDamage(){return this.damage}getSize(){return this.size}getOwnerId(){return this.ownerId}getDirection(){return this.velocity.normalize()}}class T{constructor(){o(this,"bullets",[])}addBullet(t){this.bullets.push(t)}update(t){for(let e=this.bullets.length-1;e>=0;e--)this.bullets[e].update(t),this.bullets[e].isOutOfRange()&&this.bullets.splice(e,1)}render(t,e){for(const i of this.bullets)i.render(t,e)}getBullets(){return this.bullets}removeBullet(t){this.bullets.splice(t,1)}clear(){this.bullets=[]}getCount(){return this.bullets.length}}class v{constructor(t){o(this,"position");o(this,"velocity");o(this,"speed",150);o(this,"radius",8);o(this,"color","#00ff00");o(this,"collisionSystem",null);o(this,"playerId","player");o(this,"weapons",new Map);o(this,"currentWeaponType",p.PISTOL);o(this,"bulletManager");o(this,"direction",new c(1,0));o(this,"mousePosition",new c(0,0));o(this,"lastReloadTime",0);o(this,"shouldFire",!1);o(this,"maxHealth",100);o(this,"health",100);o(this,"isDead",!1);o(this,"currentVehicle",null);o(this,"weaponBeforeVehicle",p.PISTOL);this.position=t.clone(),this.velocity=new c(0,0),this.weapons.set(p.PISTOL,new x(p.PISTOL,1/0)),this.bulletManager=new T}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.playerId,{position:this.position.clone(),radius:this.radius,type:"circle"})}setMousePosition(t,e){this.mousePosition=new c(t,e)}getCurrentWeapon(){const t=this.weapons.get(this.currentWeaponType);if(!t)throw new Error(`Weapon type ${this.currentWeaponType} not found`);return t}fire(t){const e=this.getCurrentWeapon(),i=e.getConfig();if(!(i.fireMode===b.SEMI_AUTO&&!this.shouldFire)&&e.fire(t)){this.shouldFire=!1;const s=i.pelletsPerShot||1;for(let n=0;n<s;n++){let r=(Math.random()-.5)*i.spread*(Math.PI/180);if(i.spread>0&&i.accuracy<1){const g=i.accuracy,m=Math.random()*(1-g)*Math.PI*2;r+=m}const l=this.direction.clone(),a=l.x*Math.cos(r)-l.y*Math.sin(r),u=l.x*Math.sin(r)+l.y*Math.cos(r),f=new R(this.position.clone(),new c(a,u),i.damage,i.bulletSpeed,i.range,i.bulletSize,this.playerId);this.bulletManager.addBullet(f)}}}setMouseDown(t){this.getCurrentWeapon().setMouseDown(t),t&&(this.shouldFire=!0)}reload(t){this.getCurrentWeapon().startReload(t),this.lastReloadTime=t}getReloadProgress(t){const e=this.getCurrentWeapon();if(!e.isReloadingNow())return 0;const i=e.getConfig(),s=t-this.lastReloadTime;return Math.min(s/i.reloadTime,1)}isReloading(){return this.getCurrentWeapon().isReloadingNow()}switchWeapon(t){this.currentVehicle!==null&&t!==p.PISTOL||this.weapons.has(t)&&(this.currentWeaponType=t)}getCurrentWeaponType(){return this.currentWeaponType}enterVehicle(t){this.currentVehicle=t,this.weaponBeforeVehicle=this.currentWeaponType,this.currentWeaponType=p.PISTOL,t.enterVehicle(this.playerId)}exitVehicle(){this.currentVehicle!==null&&(this.currentVehicle.exitVehicle(),this.weapons.has(this.weaponBeforeVehicle)&&(this.currentWeaponType=this.weaponBeforeVehicle),this.currentVehicle=null)}getCurrentVehicle(){return this.currentVehicle}isInVehicle(){return this.currentVehicle!==null}pickupWeapon(t){if(this.weapons.has(t)){const e=this.weapons.get(t),i=e.getConfig();e.addReserveAmmo(i.magazineCapacity)}else{const e=new x(t,0),i=e.getConfig();e.addReserveAmmo(i.magazineCapacity),this.weapons.set(t,e)}}update(t,e,i){if(this.currentVehicle!==null){e.x>0?this.currentVehicle.turnRight():e.x<0&&this.currentVehicle.turnLeft(),e.y<0?this.currentVehicle.accelerate():e.y>0&&this.currentVehicle.decelerate(),this.position=this.currentVehicle.getPosition().clone();const a=this.mousePosition.subtract(this.position);a.length()>0&&(this.direction=a.normalize()),this.bulletManager.update(t),this.getCurrentWeapon().updateReload(i);return}const s=this.mousePosition.subtract(this.position);s.length()>0&&(this.direction=s.normalize()),this.bulletManager.update(t),this.getCurrentWeapon().updateReload(i);let h=new c(e.x,e.y);h.length()>0&&(h=h.normalize().multiply(this.speed));const r=.2;this.velocity.x+=(h.x-this.velocity.x)*r,this.velocity.y+=(h.y-this.velocity.y)*r;const l=this.position.add(this.velocity.multiply(t));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.playerId,l),this.collisionSystem.getCollisions(this.playerId).length>0){const u=this.position.add(new c(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.playerId,u),this.collisionSystem.getCollisions(this.playerId).length===0)this.position=u;else{const g=this.position.add(new c(0,this.velocity.y*t));this.collisionSystem.updatePosition(this.playerId,g),this.collisionSystem.getCollisions(this.playerId).length===0?this.position=g:this.collisionSystem.updatePosition(this.playerId,this.position)}}else this.position=l;else this.position=l}render(t,e,i){const s=e.worldToScreen(this.position),n=e.getZoom();t.drawCircle(s,this.radius*n,this.color,!0);const h=this.radius*1.5*n,r=s.add(this.direction.multiply(h));t.drawLine(s,r,"#ffff00",1),this.renderWeaponIcon(t,s,n),this.renderHealthBar(t,s,n),this.bulletManager.render(t,e),this.isReloading()&&this.renderReloadAnimation(t,e,i)}renderHealthBar(t,e,i){const s=this.radius*2.5*i,n=3*i,h=e.y-this.radius*1.5*i,r=t.getContext();r.fillStyle="#000000",r.fillRect(e.x-s/2,h,s,n),r.strokeStyle="#ffffff",r.lineWidth=1,r.strokeRect(e.x-s/2,h,s,n);const l=this.health/this.maxHealth,a=s*l;l>.5?r.fillStyle="#00ff00":l>.25?r.fillStyle="#ffff00":r.fillStyle="#ff0000",r.fillRect(e.x-s/2,h,a,n)}renderWeaponIcon(t,e,i){const s=t.getContext(),h=this.getCurrentWeapon().getType(),r=this.radius*1.2*i,l=e.add(this.direction.multiply(r)),a=this.radius*.8*i;switch(s.save(),h){case p.PISTOL:s.fillStyle="#ffff00",s.beginPath(),s.arc(l.x,l.y,a,0,Math.PI*2),s.fill();break;case p.RIFLE:s.fillStyle="#00ff00",s.save(),s.translate(l.x,l.y),s.rotate(Math.atan2(this.direction.y,this.direction.x)),s.fillRect(-a,-a*.5,a*2,a),s.restore();break;case p.SHOTGUN:s.fillStyle="#ff6600",s.beginPath();for(let u=0;u<6;u++){const f=u*Math.PI/3,g=l.x+Math.cos(f)*a,m=l.y+Math.sin(f)*a;u===0?s.moveTo(g,m):s.lineTo(g,m)}s.closePath(),s.fill();break}s.restore()}renderReloadAnimation(t,e,i){const s=this.getReloadProgress(i),n=e.worldToScreen(this.mousePosition),h=20*e.getZoom(),r=t.getContext();r.strokeStyle="rgba(255, 255, 255, 0.3)",r.lineWidth=2,r.beginPath(),r.arc(n.x,n.y,h,0,Math.PI*2),r.stroke(),r.strokeStyle="#00ff00",r.lineWidth=3,r.beginPath(),r.arc(n.x,n.y,h,-Math.PI/2,-Math.PI/2+Math.PI*2*s),r.stroke()}getPosition(){return this.position.clone()}setPosition(t){this.position=t.clone()}getRadius(){return this.radius}getWeapon(){return this.getCurrentWeapon()}getBulletManager(){return this.bulletManager}getDirection(){return this.direction.clone()}takeDamage(t){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}}class O{constructor(t,e){o(this,"position");o(this,"velocity");o(this,"speed",40);o(this,"radius",6);o(this,"color","#4a90e2");o(this,"id");o(this,"behavior","idle");o(this,"collisionSystem",null);o(this,"patrolPoints",[]);o(this,"currentPatrolIndex",0);o(this,"idleTimer",0);o(this,"idleDuration",2);o(this,"targetPosition",null);o(this,"direction",new c(1,0));o(this,"visionRange",125);o(this,"visionAngle",120);o(this,"showVision",!0);o(this,"fleeRange",150);o(this,"maxHealth",50);o(this,"health",50);o(this,"isDead",!1);o(this,"lastShotTime",0);o(this,"shotCooldown",.5);o(this,"onShoot",null);this.id=t,this.position=e.clone(),this.velocity=new c(0,0),this.health=this.maxHealth}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:this.radius,type:"circle"})}setPatrolPoints(t){this.patrolPoints=t.map(e=>e.clone()),this.patrolPoints.length>0&&(this.behavior="patrol",this.targetPosition=this.patrolPoints[0].clone())}setBehavior(t){this.behavior=t,t==="idle"&&(this.idleTimer=0,this.velocity=new c(0,0))}getBehavior(){return this.behavior}update(t,e,i=0){if(this.velocity.length()>0&&(this.direction=this.velocity.normalize()),this.isPointInVision(e)){this.setBehavior("chase"),this.targetPosition=e.clone();const h=e.subtract(this.position);h.length()>0&&(this.direction=h.normalize()),this.tryShoot(i)}else this.behavior==="chase"&&this.setBehavior("patrol");switch(this.behavior){case"idle":this.updateIdle(t);break;case"patrol":this.updatePatrol(t);break;case"chase":this.updateChase(t);break;case"flee":this.updateFlee(t,e);break}const n=this.position.add(this.velocity.multiply(t));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.id,n),this.collisionSystem.getCollisions(this.id).length>0){const r=this.position.add(new c(this.velocity.x*t,0));if(this.collisionSystem.updatePosition(this.id,r),this.collisionSystem.getCollisions(this.id).length===0)this.position=r;else{const a=this.position.add(new c(0,this.velocity.y*t));this.collisionSystem.updatePosition(this.id,a),this.collisionSystem.getCollisions(this.id).length===0?this.position=a:this.collisionSystem.updatePosition(this.id,this.position)}}else this.position=n;else this.position=n}updateIdle(t){this.idleTimer+=t,this.velocity=new c(0,0),this.idleTimer>this.idleDuration&&this.setBehavior("patrol")}updatePatrol(t){if(this.patrolPoints.length===0){this.setBehavior("idle");return}this.targetPosition||(this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone());const e=this.targetPosition.subtract(this.position);e.length()<10?(this.currentPatrolIndex=(this.currentPatrolIndex+1)%this.patrolPoints.length,this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone(),this.velocity=new c(0,0)):this.velocity=e.normalize().multiply(this.speed)}updateChase(t){if(!this.targetPosition)return;const e=this.targetPosition.subtract(this.position);e.length()>0&&(this.velocity=e.normalize().multiply(this.speed*1.2))}updateFlee(t,e){const i=this.position.subtract(e),s=i.length();s>this.fleeRange?this.setBehavior("patrol"):s>0&&(this.velocity=i.normalize().multiply(this.speed*1.5))}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom();this.showVision&&this.drawVisionCone(t,e,i),t.drawCircle(i,this.radius*s,this.color,!0);const n=this.radius*1.5*s,h=i.add(this.direction.multiply(n));t.drawLine(i,h,"#ffffff",1),this.drawHealthBar(t,i,s)}drawHealthBar(t,e,i){const s=this.radius*2.5*i,n=3*i,h=e.y-this.radius*1.5*i,r=t.getContext();r.fillStyle="#000000",r.fillRect(e.x-s/2,h,s,n),r.strokeStyle="#ffffff",r.lineWidth=1,r.strokeRect(e.x-s/2,h,s,n);const l=this.health/this.maxHealth,a=s*l;l>.5?r.fillStyle="#00ff00":l>.25?r.fillStyle="#ffff00":r.fillStyle="#ff0000",r.fillRect(e.x-s/2,h,a,n)}drawVisionCone(t,e,i){const s=e.getZoom(),n=this.visionRange*s,h=this.visionAngle/2,r=Math.atan2(this.direction.y,this.direction.x),l=r-h*Math.PI/180,a=r+h*Math.PI/180,u=i.add(new c(Math.cos(l)*n,Math.sin(l)*n)),f=i.add(new c(Math.cos(a)*n,Math.sin(a)*n));t.drawLine(i,u,"#4a90e2",1),t.drawLine(i,f,"#4a90e2",1);const g=t.getContext();g.strokeStyle="#4a90e2",g.lineWidth=1,g.beginPath(),g.arc(i.x,i.y,n,l,a),g.stroke(),g.fillStyle="rgba(74, 144, 226, 0.1)",g.beginPath(),g.moveTo(i.x,i.y),g.arc(i.x,i.y,n,l,a),g.lineTo(i.x,i.y),g.fill()}getPosition(){return this.position.clone()}setPosition(t){this.position=t.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position)}getRadius(){return this.radius}getId(){return this.id}getDirection(){return this.direction.clone()}getVisionRange(){return this.visionRange}getVisionAngle(){return this.visionAngle}isPointInVision(t){const e=t.subtract(this.position);if(e.length()>this.visionRange)return!1;const s=Math.atan2(e.y,e.x),n=Math.atan2(this.direction.y,this.direction.x),h=this.visionAngle/2;let r=s-n;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;return Math.abs(r)<=h*Math.PI/180}setShowVision(t){this.showVision=t}getShowVision(){return this.showVision}takeDamage(t,e){this.isDead||(this.health-=t,this.health<=0&&(this.health=0,this.isDead=!0),e&&(this.setBehavior("chase"),this.targetPosition=e.clone()))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}tryShoot(t){this.onShoot&&t-this.lastShotTime>=this.shotCooldown&&(this.lastShotTime=t,this.onShoot(this.position.clone(),this.direction.clone()))}setOnShoot(t){this.onShoot=t}}class C{constructor(){o(this,"npcs",new Map);o(this,"collisionSystem",null);o(this,"maxNPCs",5);o(this,"_spawnRange",600);o(this,"despawnRange",1e3);o(this,"npcIdCounter",0)}setCollisionSystem(t){this.collisionSystem=t;for(const e of this.npcs.values())e.setCollisionSystem(t)}createNPC(t,e){const i=new O(t,e);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),this.npcs.set(t,i),i}getNPC(t){return this.npcs.get(t)}removeNPC(t){return this.npcs.delete(t)}getAllNPCs(){return Array.from(this.npcs.values())}getNPCCount(){return this.npcs.size}update(t,e,i=0){const s=[];for(const[n,h]of this.npcs.entries())h.update(t,e,i),(h.getPosition().distance(e)>this.despawnRange||h.getIsDead())&&s.push(n);for(const n of s)this.removeNPC(n);this.spawnNPCsAroundPlayer(e)}spawnNPCsAroundPlayer(t){if(this.npcs.size>=this.maxNPCs)return;const e=this.maxNPCs-this.npcs.size;for(let i=0;i<e;i++){const s=Math.random()*Math.PI*2,n=400+Math.random()*200,h=t.x+Math.cos(s)*n,r=t.y+Math.sin(s)*n,l=`npc_${this.npcIdCounter++}`,a=this.createNPC(l,new c(h,r)),u=[new c(h,r),new c(h+200,r),new c(h+200,r+200),new c(h,r+200)];a.setPatrolPoints(u)}}render(t,e){for(const i of this.npcs.values())i.render(t,e)}clear(){this.npcs.clear()}}class N{constructor(){o(this,"colliders",new Map)}register(t,e){this.colliders.set(t,e)}unregister(t){this.colliders.delete(t)}updatePosition(t,e){const i=this.colliders.get(t);i&&(i.position=e.clone())}circleToCircle(t,e){return t.position.distance(e.position)<t.radius+e.radius}circleToRect(t,e){const i=e.position.x,s=e.position.x+(e.width||0),n=e.position.y,h=e.position.y+(e.height||0),r=Math.max(i,Math.min(t.position.x,s)),l=Math.max(n,Math.min(t.position.y,h));return Math.sqrt((t.position.x-r)**2+(t.position.y-l)**2)<t.radius}rectToRect(t,e){return t.position.x<e.position.x+(e.width||0)&&t.position.x+(t.width||0)>e.position.x&&t.position.y<e.position.y+(e.height||0)&&t.position.y+(t.height||0)>e.position.y}isColliding(t,e){const i=this.colliders.get(t),s=this.colliders.get(e);return!i||!s?!1:i.type==="circle"&&s.type==="circle"?this.circleToCircle(i,s):i.type==="circle"&&s.type==="rect"?this.circleToRect(i,s):i.type==="rect"&&s.type==="circle"?this.circleToRect(s,i):this.rectToRect(i,s)}getCollisions(t){const e=[];for(const[i]of this.colliders)i!==t&&this.isColliding(t,i)&&e.push(i);return e}pointInCollider(t,e){const i=this.colliders.get(e);return i?i.type==="circle"?t.distance(i.position)<i.radius:t.x>=i.position.x&&t.x<=i.position.x+(i.width||0)&&t.y>=i.position.y&&t.y<=i.position.y+(i.height||0):!1}getCollider(t){return this.colliders.get(t)}clear(){this.colliders.clear()}}class H{constructor(t,e,i=32){o(this,"tileSize");o(this,"elementMap",new Map);o(this,"collisionSystem");o(this,"chunkSize",10);o(this,"generatedChunks",new Set);o(this,"buildingIdCounter",0);this.tileSize=i,this.collisionSystem=new N}getChunkKey(t,e){return`${t},${e}`}_getTileChunk(t,e){return{x:Math.floor(t/this.chunkSize),y:Math.floor(e/this.chunkSize)}}generateChunk(t,e){const i=this.getChunkKey(t,e);if(this.generatedChunks.has(i))return;this.generatedChunks.add(i);const s=t*this.chunkSize,n=e*this.chunkSize,h=s+this.chunkSize,r=n+this.chunkSize;for(let l=n;l<r;l++)for(let a=s;a<h;a++){const u=`${a},${l}`;this.elementMap.set(u,{x:a*this.tileSize,y:l*this.tileSize,width:this.tileSize,height:this.tileSize,type:"grass",color:"#2d5016"})}this.generateRoadsInChunk(s,n,h,r),this.generateBuildingsInChunk(s,n,h,r)}generateRoadsInChunk(t,e,i,s){for(let n=e;n<s;n++)if(n%8===0)for(let h=t;h<i;h++){const r=`${h},${n}`,l=this.elementMap.get(r);l&&(l.type="road",l.color="#444444")}for(let n=t;n<i;n++)if(n%8===0)for(let h=e;h<s;h++){const r=`${n},${h}`,l=this.elementMap.get(r);l&&(l.type="road",l.color="#444444")}}generateBuildingsInChunk(t,e,i,s){const n=["#8b4513","#a0522d","#cd853f","#daa520"];for(let h=e+2;h<s-2;h+=10)for(let r=t+2;r<i-2;r+=10){const l=r*73856093^h*19349663,a=Math.abs(Math.sin(l)*1e4)%1,u=Math.abs(Math.sin(l+1)*1e4)%1,f=2+a*3|0,g=2+u*3|0;for(let m=0;m<g;m++)for(let w=0;w<f;w++){const M=r+w,S=h+m;if(M<i&&S<s){const z=`${M},${S}`,y=this.elementMap.get(z);if(y){const P=`building_${this.buildingIdCounter++}`;y.type="building",y.color=n[Math.floor(a*n.length)],y.id=P,this.collisionSystem.register(P,{position:new c(y.x,y.y),radius:0,type:"rect",width:y.width,height:y.height})}}}}}ensureChunksGenerated(t){const e=Math.floor(t.x/this.tileSize),i=Math.floor(t.y/this.tileSize),s=Math.ceil((t.x+t.width)/this.tileSize),n=Math.ceil((t.y+t.height)/this.tileSize),h=Math.floor(e/this.chunkSize),r=Math.floor(i/this.chunkSize),l=Math.ceil(s/this.chunkSize),a=Math.ceil(n/this.chunkSize);for(let u=r;u<a;u++)for(let f=h;f<l;f++)this.generateChunk(f,u)}render(t,e){const i=e.getViewport(),s=e.getZoom();this.ensureChunksGenerated(i);for(const n of this.elementMap.values()){if(n.x+n.width<i.x||n.x>i.x+i.width||n.y+n.height<i.y||n.y>i.y+i.height)continue;const h=e.worldToScreen(new c(n.x,n.y)),r=n.width*s,l=n.height*s;t.drawRect(h,r,l,n.color,!0),t.drawRect(h,r,l,"#333333",!1)}}getTileSize(){return this.tileSize}getCollisionSystem(){return this.collisionSystem}getBuildings(){return Array.from(this.elementMap.values()).filter(t=>t.type==="building")}}class D{constructor(t,e,i){o(this,"position");o(this,"type");o(this,"weaponType");o(this,"radius",8);o(this,"color");o(this,"id");o(this,"rotationAngle",0);this.id=t,this.position=e.clone(),this.type="weapon",this.weaponType=i,this.color=this.getColorByWeapon(i)}getColorByWeapon(t){switch(t){case p.PISTOL:return"#ffff00";case p.RIFLE:return"#00ff00";case p.SHOTGUN:return"#ff6600"}}update(t){this.rotationAngle+=t*3}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom(),n=t.getContext();switch(n.save(),n.translate(i.x,i.y),n.rotate(this.rotationAngle),this.weaponType){case p.PISTOL:this.drawPistolIcon(n,s);break;case p.RIFLE:this.drawRifleIcon(n,s);break;case p.SHOTGUN:this.drawShotgunIcon(n,s);break}n.restore(),t.drawCircle(i,3*s,"#ffffff",!0),this.drawWeaponLabel(t,i,s)}drawWeaponLabel(t,e,i){const s=t.getContext();let n="";switch(this.weaponType){case p.RIFLE:n="步枪";break;case p.SHOTGUN:n="霰弹枪";break;default:return}s.fillStyle=this.color,s.font=`${12*i}px Arial`,s.textAlign="center",s.textBaseline="top",s.fillText(n,e.x,e.y+this.radius*1.5*i)}drawPistolIcon(t,e){t.fillStyle=this.color,t.beginPath();for(let i=0;i<5;i++){const s=i*4*Math.PI/5-Math.PI/2,n=Math.cos(s)*this.radius*e,h=Math.sin(s)*this.radius*e;i===0?t.moveTo(n,h):t.lineTo(n,h)}t.closePath(),t.fill()}drawRifleIcon(t,e){t.fillStyle=this.color;const i=this.radius*1.5*e,s=this.radius*.8*e;t.fillRect(-i/2,-s/2,i,s),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(-i/2,-s/2,i,s)}drawShotgunIcon(t,e){t.fillStyle=this.color,t.beginPath(),t.arc(0,0,this.radius*e,0,Math.PI*2),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=1,t.stroke(),t.strokeStyle="#ffffff",t.lineWidth=.5;for(let i=0;i<3;i++){const s=i*Math.PI/3,n=Math.cos(s)*this.radius*.5*e,h=Math.sin(s)*this.radius*.5*e;t.beginPath(),t.moveTo(0,0),t.lineTo(n,h),t.stroke()}}getPosition(){return this.position.clone()}getId(){return this.id}getWeaponType(){return this.weaponType}getRadius(){return this.radius}}class I{constructor(){o(this,"items",new Map);o(this,"itemIdCounter",0)}addItem(t,e){const i=`item_${this.itemIdCounter++}`,s=new D(i,t,e);return this.items.set(i,s),s}removeItem(t){return this.items.delete(t)}getItem(t){return this.items.get(t)}getAllItems(){return Array.from(this.items.values())}update(t){for(const e of this.items.values())e.update(t)}render(t,e){for(const i of this.items.values())i.render(t,e)}getCount(){return this.items.size}clear(){this.items.clear()}}class E{constructor(t,e){o(this,"position");o(this,"velocity");o(this,"speed",600);o(this,"maxSpeed",900);o(this,"acceleration",450);o(this,"friction",.98);o(this,"width",40);o(this,"height",24);o(this,"color","#ff0000");o(this,"rotation",0);o(this,"id");o(this,"collisionSystem",null);o(this,"isOccupied",!1);o(this,"occupantId",null);this.id=t,this.position=e.clone(),this.velocity=new c(0,0)}setCollisionSystem(t){this.collisionSystem=t,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:Math.max(this.width,this.height)/2,type:"circle"})}getId(){return this.id}getPosition(){return this.position.clone()}getWidth(){return this.width}getHeight(){return this.height}isOccupiedByPlayer(){return this.isOccupied}getOccupantId(){return this.occupantId}enterVehicle(t){this.isOccupied=!0,this.occupantId=t}exitVehicle(){this.isOccupied=!1,this.occupantId=null,this.velocity=new c(0,0)}setPosition(t){this.position=t.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position.clone())}setRotation(t){this.rotation=t}getRotation(){return this.rotation}accelerate(){if(this.velocity.length()<this.maxSpeed){const e=new c(Math.cos(this.rotation),Math.sin(this.rotation));this.velocity=this.velocity.add(e.multiply(this.acceleration*.016))}}decelerate(){this.velocity=this.velocity.multiply(.85)}turnLeft(){this.rotation-=.05}turnRight(){this.rotation+=.05}update(t){this.velocity=this.velocity.multiply(this.friction),this.position=this.position.add(this.velocity.multiply(t)),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position.clone())}render(t,e){const i=e.worldToScreen(this.position),s=e.getZoom(),n=t.getContext();n.save(),n.translate(i.x,i.y),n.rotate(this.rotation),n.fillStyle=this.color,n.fillRect(-this.width/2*s,-this.height/2*s,this.width*s,this.height*s),n.fillStyle="#87ceeb",n.fillRect(-this.width/3*s,-this.height/3*s,this.width/1.5*s,this.height/3*s),n.fillStyle="#ffff00",n.fillRect(-this.width/2*s,-this.height/4*s,3*s,3*s),n.fillRect(this.width/2*s-3*s,-this.height/4*s,3*s,3*s),n.restore(),this.isOccupied||(n.strokeStyle="#00ff00",n.lineWidth=2,n.strokeRect(i.x-this.width/2*s,i.y-this.height/2*s,this.width*s,this.height*s))}isPlayerNearby(t,e=50){return this.position.subtract(t).length()<e}}class ${constructor(){o(this,"vehicles",new Map);o(this,"vehicleIdCounter",0);o(this,"collisionSystem",null);o(this,"maxVehicles",5);o(this,"spawnRange",800);o(this,"despawnRange",1200)}setCollisionSystem(t){this.collisionSystem=t}spawnVehicle(t){if(this.vehicles.size>=this.maxVehicles)return Array.from(this.vehicles.values())[0];const e=`vehicle_${this.vehicleIdCounter++}`,i=new E(e,t);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),this.vehicles.set(e,i),i}getVehicles(){return Array.from(this.vehicles.values())}getNearbyVehicles(t,e=100){return Array.from(this.vehicles.values()).filter(i=>i.isPlayerNearby(t,e))}getPlayerVehicle(t){for(const e of this.vehicles.values())if(e.getOccupantId()===t)return e;return null}update(t,e){const i=[];for(const[s,n]of this.vehicles)n.update(t),n.getPosition().subtract(e).length()>this.despawnRange&&i.push(s);for(const s of i)this.vehicles.delete(s);if(this.vehicles.size<this.maxVehicles&&Math.random()<.01){const s=Math.random()*Math.PI*2,n=400+Math.random()*400,h=new c(e.x+Math.cos(s)*n,e.y+Math.sin(s)*n);this.spawnVehicle(h)}}render(t,e){for(const i of this.vehicles.values())i.render(t,e)}getCount(){return this.vehicles.size}}class F{constructor(){o(this,"renderer");o(this,"camera");o(this,"inputManager");o(this,"player");o(this,"npcManager");o(this,"gameMap");o(this,"itemManager");o(this,"vehicleManager");o(this,"isRunning",!1);o(this,"frameCount",0);o(this,"lastFrameTime",0);o(this,"fps",0);o(this,"itemSpawnTimer",0);o(this,"itemSpawnInterval",3);o(this,"maxItems",3);o(this,"itemSpawnRange",600);o(this,"score",0);o(this,"gameOver",!1);o(this,"npcBulletManager");o(this,"gameLoop",()=>{if(!this.isRunning)return;const t=performance.now(),e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this.update(e),this.render(),this.frameCount++,t-this.lastFrameTime>1e3&&(this.fps=this.frameCount,this.frameCount=0),requestAnimationFrame(this.gameLoop)});this.renderer=new W("game-canvas"),this.camera=new V(this.renderer.getWidth(),this.renderer.getHeight()),this.inputManager=new L,this.gameMap=new H(0,0,32),this.npcManager=new C,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.setupNPCShootCallback(),this.itemManager=new I,this.vehicleManager=new $,this.vehicleManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcBulletManager=new T,this.player=new v(new c(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.camera.setPosition(this.player.getPosition()),window.addEventListener("resize",()=>{this.camera.updateSize(this.renderer.getWidth(),this.renderer.getHeight())}),document.addEventListener("mousedown",t=>{t.button===0&&this.player.setMouseDown(!0)}),document.addEventListener("mouseup",t=>{t.button===0&&this.player.setMouseDown(!1)})}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.gameLoop())}stop(){this.isRunning=!1}update(t){if(this.gameOver){this.inputManager.isKeyPressed("r")&&this.restartGame();return}const e=this.inputManager.getMovementInput(),i=this.inputManager.getMousePosition(),s=this.camera.screenToWorld(new c(i.x,i.y));this.player.setMousePosition(s.x,s.y);const n=performance.now()/1e3;this.player.fire(n),this.inputManager.isKeyPressed("r")&&this.player.reload(n),this.inputManager.isKeyPressed("1")&&this.player.switchWeapon(p.PISTOL),this.inputManager.isKeyPressed("2")&&this.player.switchWeapon(p.RIFLE),this.inputManager.isKeyPressed("3")&&this.player.switchWeapon(p.SHOTGUN),this.player.update(t,e,n),this.vehicleManager.update(t,this.player.getPosition()),this.handleVehicleInteraction(),this.npcManager.update(t,this.player.getPosition(),n),this.npcBulletManager.update(t),this.itemManager.update(t),this.itemSpawnTimer+=t,this.itemSpawnTimer>=this.itemSpawnInterval&&(this.itemSpawnTimer=0,this.itemManager.getCount()<this.maxItems&&this.spawnRandomItem()),this.cleanupFarItems(),this.checkItemPickup(),this.checkBulletHits(),this.checkNPCBulletHits(),this.cleanupNPCBullets(),this.player.getIsDead()&&(this.gameOver=!0),this.camera.follow(this.player.getPosition(),.1),this.inputManager.isKeyPressed("q")&&this.camera.zoomOut(.02),this.inputManager.isKeyPressed("e")&&this.camera.zoomIn(.02),this.updateHUD(),this.inputManager.clearJustPressedKeys()}spawnRandomItem(){for(let t=0;t<5;t++){const e=Math.random()*Math.PI*2,i=300+Math.random()*300,s=this.player.getPosition().x+Math.cos(e)*i,n=this.player.getPosition().y+Math.sin(e)*i;if(!this.isPositionInBuilding(new c(s,n))){const h=[p.RIFLE,p.SHOTGUN],r=h[Math.floor(Math.random()*h.length)];this.itemManager.addItem(new c(s,n),r);return}}}cleanupFarItems(){const t=this.player.getPosition(),e=this.itemManager.getAllItems();for(const i of e)t.distance(i.getPosition())>this.itemSpawnRange&&this.itemManager.removeItem(i.getId())}isPositionInBuilding(t){const e=this.gameMap.getBuildings();for(const i of e)if(t.x>=i.x&&t.x<=i.x+i.width&&t.y>=i.y&&t.y<=i.y+i.height)return!0;return!1}handleVehicleInteraction(){if(this.player.isInVehicle()){this.inputManager.isKeyJustPressed("f")&&this.player.exitVehicle();return}const t=this.vehicleManager.getNearbyVehicles(this.player.getPosition(),100);if(t.length>0&&this.inputManager.isKeyJustPressed("f")){const e=t[0];this.player.enterVehicle(e)}}checkItemPickup(){const t=this.player.getPosition(),e=this.player.getRadius();for(const i of this.itemManager.getAllItems())t.distance(i.getPosition())<e+i.getRadius()&&(this.player.pickupWeapon(i.getWeaponType()),this.itemManager.removeItem(i.getId()))}setupNPCShootCallback(){const t=this.npcManager.createNPC.bind(this.npcManager);this.npcManager.createNPC=(e,i)=>{const s=t(e,i);return s.setOnShoot((n,h)=>{const r=new R(n,h,10,500,300,3,e);this.npcBulletManager.addBullet(r)}),s}}restartGame(){this.score=0,this.gameOver=!1,this.npcBulletManager.clear(),this.player=new v(new c(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcManager=new C,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.setupNPCShootCallback(),this.itemManager=new I}checkBulletHits(){const t=this.player.getBulletManager().getBullets(),e=this.npcManager.getAllNPCs();for(let i=t.length-1;i>=0;i--){const s=t[i],n=s.getPosition(),h=s.getSize();let r=!1;for(const l of e){if(l.getIsDead())continue;const a=l.getPosition(),u=l.getRadius();if(n.distance(a)<h+u){const g=s.getDamage();l.takeDamage(g,this.player.getPosition()),l.getIsDead()&&this.score++,r=!0;break}}r&&this.player.getBulletManager().removeBullet(i)}}checkNPCBulletHits(){const t=this.npcBulletManager.getBullets(),e=this.player.getPosition(),i=this.player.getRadius();for(let s=t.length-1;s>=0;s--){const n=t[s],h=n.getPosition(),r=n.getSize();if(h.distance(e)<r+i){const a=n.getDamage();this.player.takeDamage(a),this.npcBulletManager.removeBullet(s)}}}cleanupNPCBullets(){const t=this.npcBulletManager.getBullets(),e=this.player.getPosition();for(let i=t.length-1;i>=0;i--)t[i].getPosition().distance(e)>1e3&&this.npcBulletManager.removeBullet(i)}render(){this.renderer.clear(),this.gameMap.render(this.renderer,this.camera),this.itemManager.render(this.renderer,this.camera),this.vehicleManager.render(this.renderer,this.camera),this.npcManager.render(this.renderer,this.camera),this.npcBulletManager.render(this.renderer,this.camera);const t=performance.now()/1e3;this.player.render(this.renderer,this.camera,t),this.drawDebugGrid(),this.gameOver&&this.drawGameOverScreen()}drawGameOverScreen(){const t=this.renderer.getContext(),e=this.renderer.getWidth(),i=this.renderer.getHeight();t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,e,i),t.fillStyle="#ff0000",t.font="bold 48px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("GAME OVER",e/2,i/2-60),t.fillStyle="#ffff00",t.font="bold 36px Arial",t.fillText(`最终得分: ${this.score}`,e/2,i/2+20),t.fillStyle="#00ff00",t.font="24px Arial",t.fillText("按 R 键重新开始",e/2,i/2+80)}drawDebugGrid(){const t=this.camera.getViewport(),e=32,i=Math.floor(t.x/e)*e,s=Math.floor(t.y/e)*e,n=i+t.width+e,h=s+t.height+e;for(let r=i;r<n;r+=e){const l=this.camera.worldToScreen(new c(r,s)),a=this.camera.worldToScreen(new c(r,h));this.renderer.drawLine(l,a,"#444444",.5)}for(let r=s;r<h;r+=e){const l=this.camera.worldToScreen(new c(i,r)),a=this.camera.worldToScreen(new c(n,r));this.renderer.drawLine(l,a,"#444444",.5)}}updateHUD(){const t=document.getElementById("fps"),e=document.getElementById("position");if(t&&(t.textContent=this.fps.toString()),e){this.player.getPosition();const i=this.npcManager.getNPCCount(),s=this.player.getWeapon(),n=s.getCurrentAmmo(),h=s.getReserveAmmo(),r=this.player.getBulletManager().getCount(),l=s.getName(),a=this.itemManager.getCount(),u=this.player.isReloading()?" [装弹中]":"",f=this.player.getHealth(),g=this.player.getMaxHealth(),m=this.vehicleManager.getCount();let w=`血量: ${f}/${g} | 得分: ${this.score} | NPCs: ${i} | 武器: ${l}${u} | 弹药: ${n}/${h} | 子弹: ${r} | 物品: ${a} | 车辆: ${m}`;this.player.isInVehicle()?w+=" | 状态: 在车辆中 (按E离开)":this.vehicleManager.getNearbyVehicles(this.player.getPosition(),100).length>0&&(w+=" | 提示: 按E进入车辆"),e.textContent=w}}}const k=new F;k.start();window.game=k;
