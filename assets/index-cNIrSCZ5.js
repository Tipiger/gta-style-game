var A=Object.defineProperty;var V=(p,e,t)=>e in p?A(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var o=(p,e,t)=>V(p,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class N{constructor(e){o(this,"canvas");o(this,"ctx");o(this,"width");o(this,"height");const t=document.getElementById(e);if(!t)throw new Error(`Canvas element with id "${e}" not found`);this.canvas=t,this.ctx=t.getContext("2d"),this.width=window.innerWidth,this.height=window.innerHeight,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height}clear(e="#2a2a2a"){this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.width,this.height)}drawRect(e,t,i,s,n=!0){this.ctx.fillStyle=s,this.ctx.strokeStyle=s,n?this.ctx.fillRect(e.x,e.y,t,i):this.ctx.strokeRect(e.x,e.y,t,i)}drawCircle(e,t,i,s=!0){this.ctx.fillStyle=i,this.ctx.strokeStyle=i,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,Math.PI*2),s?this.ctx.fill():this.ctx.stroke()}drawLine(e,t,i,s=1){this.ctx.strokeStyle=i,this.ctx.lineWidth=s,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke()}drawText(e,t,i,s=16,n="Arial"){this.ctx.fillStyle=i,this.ctx.font=`${s}px ${n}`,this.ctx.fillText(e,t.x,t.y)}getWidth(){return this.width}getHeight(){return this.height}getContext(){return this.ctx}drawColliderCircle(e,t,i="#00ff00",s=2){this.ctx.strokeStyle=i,this.ctx.lineWidth=s,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,Math.PI*2),this.ctx.stroke()}drawColliderRect(e,t,i,s="#00ff00",n=2){this.ctx.strokeStyle=s,this.ctx.lineWidth=n,this.ctx.strokeRect(e.x,e.y,t,i)}}class d{constructor(e=0,t=0){o(this,"x");o(this,"y");this.x=e,this.y=t}add(e){return new d(this.x+e.x,this.y+e.y)}subtract(e){return new d(this.x-e.x,this.y-e.y)}multiply(e){return new d(this.x*e,this.y*e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const e=this.length();return e===0?new d(0,0):new d(this.x/e,this.y/e)}distance(e){return this.subtract(e).length()}clone(){return new d(this.x,this.y)}set(e,t){return this.x=e,this.y=t,this}dot(e){return this.x*e.x+this.y*e.y}}class E{constructor(e,t){o(this,"position");o(this,"zoom");o(this,"width");o(this,"height");o(this,"minZoom",.5);o(this,"maxZoom",3);this.position=new d(0,0),this.zoom=1,this.width=e,this.height=t}setPosition(e){this.position=e.clone()}getPosition(){return this.position.clone()}follow(e,t=.1){const i=e.subtract(this.position);this.position=this.position.add(i.multiply(t))}setZoom(e){this.zoom=Math.max(this.minZoom,Math.min(e,this.maxZoom))}getZoom(){return this.zoom}zoomIn(e=.1){this.setZoom(this.zoom+e)}zoomOut(e=.1){this.setZoom(this.zoom-e)}worldToScreen(e){const t=(e.x-this.position.x)*this.zoom+this.width/2,i=(e.y-this.position.y)*this.zoom+this.height/2;return new d(t,i)}screenToWorld(e){const t=(e.x-this.width/2)/this.zoom+this.position.x,i=(e.y-this.height/2)/this.zoom+this.position.y;return new d(t,i)}getViewport(){const e=this.width/this.zoom,t=this.height/this.zoom;return{x:this.position.x-e/2,y:this.position.y-t/2,width:e,height:t}}updateSize(e,t){this.width=e,this.height=t}}class z{constructor(){o(this,"keys",new Map);o(this,"keysJustPressed",new Set);o(this,"mousePosition",{x:0,y:0});o(this,"mouseButtons",new Map);this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();this.keys.get(t)||this.keysJustPressed.add(t),this.keys.set(t,!0)}),window.addEventListener("keyup",e=>{this.keys.set(e.key.toLowerCase(),!1)})}setupMouseListeners(){window.addEventListener("mousemove",e=>{this.mousePosition={x:e.clientX,y:e.clientY}}),window.addEventListener("mousedown",e=>{this.mouseButtons.set(e.button,!0)}),window.addEventListener("mouseup",e=>{this.mouseButtons.set(e.button,!1)})}isKeyPressed(e){return this.keys.get(e.toLowerCase())??!1}isKeyJustPressed(e){return this.keysJustPressed.has(e.toLowerCase())}clearJustPressedKeys(){this.keysJustPressed.clear()}isMouseButtonPressed(e=0){return this.mouseButtons.get(e)??!1}getMousePosition(){return{...this.mousePosition}}getMovementInput(){let e=0,t=0;return(this.isKeyPressed("w")||this.isKeyPressed("arrowup"))&&(t-=1),(this.isKeyPressed("s")||this.isKeyPressed("arrowdown"))&&(t+=1),(this.isKeyPressed("a")||this.isKeyPressed("arrowleft"))&&(e-=1),(this.isKeyPressed("d")||this.isKeyPressed("arrowright"))&&(e+=1),{x:e,y:t}}}var x=(p=>(p.PISTOL="pistol",p.RIFLE="rifle",p.SHOTGUN="shotgun",p))(x||{}),T=(p=>(p.SEMI_AUTO="semi_auto",p.FULL_AUTO="full_auto",p))(T||{});class P{constructor(e,t=0){o(this,"type");o(this,"config");o(this,"currentAmmo");o(this,"reserveAmmo");o(this,"lastFireTime",0);o(this,"fireInterval");o(this,"isReloading",!1);o(this,"reloadStartTime",0);o(this,"isMouseDown",!1);o(this,"damageBonus",0);this.type=e,this.config=this.getWeaponConfig(e),this.currentAmmo=this.config.magazineCapacity,this.reserveAmmo=t,this.fireInterval=1/this.config.fireRate}getWeaponConfig(e){switch(e){case"pistol":return{type:"pistol",damage:10,fireRate:2.22,range:300,bulletSpeed:500,bulletSize:3,accuracy:.9,magazineCapacity:10,reloadTime:.8,fireMode:"semi_auto",spread:0};case"rifle":return{type:"rifle",damage:20,fireRate:8,range:500,bulletSpeed:700,bulletSize:4,accuracy:.95,magazineCapacity:30,reloadTime:2,fireMode:"full_auto",spread:15};case"shotgun":return{type:"shotgun",damage:15,fireRate:1,range:150,bulletSpeed:400,bulletSize:2,accuracy:.95,magazineCapacity:6,reloadTime:1.2,fireMode:"semi_auto",spread:15,pelletsPerShot:8}}}canFire(e){return this.currentAmmo<=0||this.isReloading?!1:this.config.fireMode==="semi_auto"?e-this.lastFireTime>=this.fireInterval:this.isMouseDown&&e-this.lastFireTime>=this.fireInterval}fire(e){return this.canFire(e)?(this.currentAmmo--,this.lastFireTime=e,!0):!1}setMouseDown(e){this.isMouseDown=e}startReload(e){this.isReloading||this.currentAmmo===this.config.magazineCapacity||this.reserveAmmo>0&&(this.isReloading=!0,this.reloadStartTime=e)}updateReload(e){if(this.isReloading&&e-this.reloadStartTime>=this.config.reloadTime){this.isReloading=!1;const t=this.config.magazineCapacity-this.currentAmmo,i=Math.min(t,this.reserveAmmo);this.currentAmmo+=i,this.reserveAmmo-=i}}getReloadProgress(){return this.isReloading,0}isReloadingNow(){return this.isReloading}getConfig(){return{...this.config}}getCurrentAmmo(){return this.currentAmmo}getReserveAmmo(){return this.reserveAmmo}addReserveAmmo(e){this.reserveAmmo+=e}getTotalAmmo(){return this.currentAmmo+this.reserveAmmo}getType(){return this.type}getWeaponType(){return this.type}getName(){switch(this.type){case"pistol":return"æ‰‹æžª";case"rifle":return"æ­¥æžª";case"shotgun":return"éœ°å¼¹æžª"}}addDamageBonus(e){this.damageBonus+=e}getDamageBonus(){return this.damageBonus}getActualDamage(){return this.config.damage+this.damageBonus}}class R{constructor(e,t,i,s,n,l,a){o(this,"position");o(this,"velocity");o(this,"damage");o(this,"range");o(this,"size");o(this,"distanceTraveled",0);o(this,"color","#ffff00");o(this,"ownerId");this.position=e.clone(),this.velocity=t.normalize().multiply(s),this.damage=i,this.range=n,this.size=l,this.ownerId=a}update(e){const t=this.velocity.multiply(e);this.position=this.position.add(t),this.distanceTraveled+=t.length()}isOutOfRange(){return this.distanceTraveled>this.range}render(e,t){const i=t.worldToScreen(this.position);e.drawCircle(i,this.size*t.getZoom(),this.color,!0)}getPosition(){return this.position.clone()}getDamage(){return this.damage}getSize(){return this.size}getOwnerId(){return this.ownerId}getDirection(){return this.velocity.normalize()}}class L{constructor(){o(this,"bullets",[])}addBullet(e){this.bullets.push(e)}update(e){for(let t=this.bullets.length-1;t>=0;t--)this.bullets[t].update(e),this.bullets[t].isOutOfRange()&&this.bullets.splice(t,1)}render(e,t){for(const i of this.bullets)i.render(e,t)}getBullets(){return this.bullets}removeBullet(e){this.bullets.splice(e,1)}clear(){this.bullets=[]}getCount(){return this.bullets.length}}class b{constructor(e){o(this,"position");o(this,"velocity");o(this,"speed",150);o(this,"radius",8);o(this,"color","#00ff00");o(this,"collisionSystem",null);o(this,"playerId","player");o(this,"weapons",new Map);o(this,"currentWeaponType",x.PISTOL);o(this,"bulletManager");o(this,"direction",new d(1,0));o(this,"mousePosition",new d(0,0));o(this,"lastReloadTime",0);o(this,"shouldFire",!1);o(this,"maxHealth",100);o(this,"health",100);o(this,"isDead",!1);o(this,"currentVehicle",null);o(this,"weaponBeforeVehicle",x.PISTOL);o(this,"autoShootRange",300);o(this,"getNPCsCallback",null);this.position=e.clone(),this.velocity=new d(0,0),this.weapons.set(x.PISTOL,new P(x.PISTOL,1/0)),this.bulletManager=new L}setCollisionSystem(e){this.collisionSystem=e,this.collisionSystem.register(this.playerId,{position:this.position.clone(),radius:this.radius,type:"circle"})}setMousePosition(e,t){this.mousePosition=new d(e,t)}setGetNPCsCallback(e){this.getNPCsCallback=e}getCurrentWeapon(){const e=this.weapons.get(this.currentWeaponType);if(!e)throw new Error(`Weapon type ${this.currentWeaponType} not found`);return e}findNearestEnemy(){if(!this.getNPCsCallback)return null;const e=this.getNPCsCallback();let t=null,i=this.autoShootRange;for(const s of e){if(s.getIsDead&&s.getIsDead())continue;const n=s.getPosition(),l=this.position.distance(n);if(l<i){if(this.collisionSystem&&!this.collisionSystem.raycastBuildings(this.position,n))continue;i=l,t=s}}return t}fire(e){const t=this.getCurrentWeapon(),i=t.getConfig(),s=this.findNearestEnemy();if(s){const n=s.getPosition().subtract(this.position),l=n.length();if(l>0&&(this.direction=n.normalize()),l>i.range){this.shouldFire=!1;return}if(t.getCurrentAmmo()<=0){t.getReserveAmmo()>0&&this.reload(e);return}this.shouldFire=!0,t.setMouseDown(!0)}else{this.shouldFire=!1,t.setMouseDown(!1);return}if(!(i.fireMode===T.SEMI_AUTO&&!this.shouldFire)&&t.fire(e)){this.shouldFire=!1;const n=i.pelletsPerShot||1;for(let l=0;l<n;l++){let r=(Math.random()-.5)*i.spread*(Math.PI/180);if(i.spread>0&&i.accuracy<1){const f=i.accuracy,m=Math.random()*(1-f)*Math.PI*2;r+=m}const h=this.direction.clone(),c=h.x*Math.cos(r)-h.y*Math.sin(r),g=h.x*Math.sin(r)+h.y*Math.cos(r),u=new R(this.position.clone(),new d(c,g),t.getActualDamage(),i.bulletSpeed,i.range,i.bulletSize,this.playerId);this.bulletManager.addBullet(u)}}}reload(e){const t=this.getCurrentWeapon();t.isReloadingNow()||(this.lastReloadTime=e),t.startReload(e)}getReloadProgress(e){const t=this.getCurrentWeapon();if(!t.isReloadingNow())return 0;const i=t.getConfig(),s=e-this.lastReloadTime;return Math.min(s/i.reloadTime,1)}isReloading(){return this.getCurrentWeapon().isReloadingNow()}switchWeapon(e){this.currentVehicle!==null&&e!==x.PISTOL||this.weapons.has(e)&&(this.currentWeaponType=e)}getCurrentWeaponType(){return this.currentWeaponType}enterVehicle(e){this.currentVehicle=e,this.weaponBeforeVehicle=this.currentWeaponType,this.currentWeaponType=x.PISTOL,e.enterVehicle(this.playerId)}exitVehicle(){if(this.currentVehicle!==null){const e=this.currentVehicle.getPosition(),t=50,i=this.currentVehicle.getRotation(),s=new d(e.x+Math.cos(i+Math.PI/2)*t,e.y+Math.sin(i+Math.PI/2)*t);this.position=s,this.collisionSystem&&this.collisionSystem.updatePosition(this.playerId,this.position),this.currentVehicle.exitVehicle(),this.weapons.has(this.weaponBeforeVehicle)&&(this.currentWeaponType=this.weaponBeforeVehicle),this.currentVehicle=null}}getCurrentVehicle(){return this.currentVehicle}isInVehicle(){return this.currentVehicle!==null}pickupWeapon(e){if(this.weapons.has(e)){const t=this.weapons.get(e),i=t.getConfig();t.addReserveAmmo(i.magazineCapacity)}else{const t=new P(e,0),i=t.getConfig();t.addReserveAmmo(i.magazineCapacity),this.weapons.set(e,t)}}update(e,t,i){if(this.currentVehicle!==null){t.x>0?this.currentVehicle.turnRight():t.x<0&&this.currentVehicle.turnLeft(),t.y<0?this.currentVehicle.accelerate():t.y>0&&this.currentVehicle.decelerate(),this.position=this.currentVehicle.getPosition().clone(),this.bulletManager.update(e),this.getCurrentWeapon().updateReload(i);return}this.bulletManager.update(e),this.getCurrentWeapon().updateReload(i);let n=new d(t.x,t.y);n.length()>0&&(n=n.normalize().multiply(this.speed));const l=.2;this.velocity.x+=(n.x-this.velocity.x)*l,this.velocity.y+=(n.y-this.velocity.y)*l;const a=this.position.add(this.velocity.multiply(e));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.playerId,a),this.collisionSystem.getCollisions(this.playerId).length>0){const h=this.position.add(new d(this.velocity.x*e,0));if(this.collisionSystem.updatePosition(this.playerId,h),this.collisionSystem.getCollisions(this.playerId).length===0)this.position=h;else{const g=this.position.add(new d(0,this.velocity.y*e));this.collisionSystem.updatePosition(this.playerId,g),this.collisionSystem.getCollisions(this.playerId).length===0?this.position=g:this.collisionSystem.updatePosition(this.playerId,this.position)}}else this.position=a;else this.position=a}render(e,t,i){const s=t.worldToScreen(this.position),n=t.getZoom();e.drawCircle(s,this.radius*n,this.color,!0),this.renderWeaponIcon(e,s,n),this.renderHealthBar(e,s,n),this.bulletManager.render(e,t),this.isReloading()&&this.renderReloadAnimation(e,t,i)}renderHealthBar(e,t,i){const s=this.radius*2.5*i,n=3*i,l=t.y-this.radius*1.5*i,a=e.getContext();a.fillStyle="#000000",a.fillRect(t.x-s/2,l,s,n),a.strokeStyle="#ffffff",a.lineWidth=1,a.strokeRect(t.x-s/2,l,s,n);const r=this.health/this.maxHealth,h=s*r;r>.5?a.fillStyle="#00ff00":r>.25?a.fillStyle="#ffff00":a.fillStyle="#ff0000",a.fillRect(t.x-s/2,l,h,n)}renderWeaponIcon(e,t,i){const s=e.getContext(),l=this.getCurrentWeapon().getType(),a=this.radius*1.2*i,r=t.add(this.direction.multiply(a)),h=this.radius*.8*i;switch(s.save(),l){case x.PISTOL:s.fillStyle="#ffff00",s.beginPath(),s.arc(r.x,r.y,h,0,Math.PI*2),s.fill();break;case x.RIFLE:s.fillStyle="#00ff00",s.save(),s.translate(r.x,r.y),s.rotate(Math.atan2(this.direction.y,this.direction.x)),s.fillRect(-h,-h*.5,h*2,h),s.restore();break;case x.SHOTGUN:s.fillStyle="#ff6600",s.beginPath();for(let c=0;c<6;c++){const g=c*Math.PI/3,u=r.x+Math.cos(g)*h,f=r.y+Math.sin(g)*h;c===0?s.moveTo(u,f):s.lineTo(u,f)}s.closePath(),s.fill();break}s.restore()}renderReloadAnimation(e,t,i){const s=this.getReloadProgress(i),n=t.worldToScreen(this.position),l=20*t.getZoom(),a=e.getContext();a.strokeStyle="rgba(255, 255, 255, 0.3)",a.lineWidth=2,a.beginPath(),a.arc(n.x,n.y,l,0,Math.PI*2),a.stroke(),a.strokeStyle="#00ff00",a.lineWidth=3,a.beginPath();const r=Math.max(s,.01);a.arc(n.x,n.y,l,-Math.PI/2,-Math.PI/2+Math.PI*2*r),a.stroke()}getPosition(){return this.position.clone()}setPosition(e){this.position=e.clone()}getRadius(){return this.radius}getWeapon(){return this.getCurrentWeapon()}getBulletManager(){return this.bulletManager}getDirection(){return this.direction.clone()}takeDamage(e){this.isDead||(this.health-=e,this.health<=0&&(this.health=0,this.isDead=!0))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}increaseMaxHealth(e){this.maxHealth+=e,this.health=this.maxHealth}increaseSpeed(e){this.speed+=e}heal(e){this.isDead||(this.health=Math.min(this.health+e,this.maxHealth))}getSpeed(){return this.speed}getWeapons(){return Array.from(this.weapons.values())}}class H{constructor(e,t){o(this,"position");o(this,"velocity");o(this,"speed",40);o(this,"radius",6);o(this,"color","#4a90e2");o(this,"id");o(this,"behavior","idle");o(this,"collisionSystem",null);o(this,"patrolPoints",[]);o(this,"currentPatrolIndex",0);o(this,"idleTimer",0);o(this,"idleDuration",2);o(this,"targetPosition",null);o(this,"direction",new d(1,0));o(this,"visionRange",187.5);o(this,"visionAngle",120);o(this,"showVision",!1);o(this,"fleeRange",150);o(this,"maxHealth",50);o(this,"health",50);o(this,"isDead",!1);o(this,"lastShotTime",0);o(this,"shotCooldown",.5);o(this,"onShoot",null);this.id=e,this.position=t.clone(),this.velocity=new d(0,0),this.health=this.maxHealth}setProperties(e,t,i){this.maxHealth=e,this.health=e,this.speed=t,this.shotCooldown=i}setCollisionSystem(e){this.collisionSystem=e,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:this.radius,type:"circle"})}setPatrolPoints(e){this.patrolPoints=e.map(t=>t.clone()),this.patrolPoints.length>0&&(this.behavior="patrol",this.targetPosition=this.patrolPoints[0].clone())}setBehavior(e){this.behavior=e,e==="idle"&&(this.idleTimer=0,this.velocity=new d(0,0))}getBehavior(){return this.behavior}update(e,t,i=0){if(this.velocity.length()>0&&(this.direction=this.velocity.normalize()),this.isPointInVisionWithLineOfSight(t)){this.setBehavior("chase"),this.targetPosition=t.clone();const l=t.subtract(this.position);l.length()>0&&(this.direction=l.normalize()),this.tryShoot(i)}else this.behavior==="chase"&&this.setBehavior("patrol");switch(this.behavior){case"idle":this.updateIdle(e);break;case"patrol":this.updatePatrol(e);break;case"chase":this.updateChase(e);break;case"flee":this.updateFlee(e,t);break}const n=this.position.add(this.velocity.multiply(e));if(this.collisionSystem)if(this.collisionSystem.updatePosition(this.id,n),this.collisionSystem.getCollisions(this.id).length>0){const a=this.position.add(new d(this.velocity.x*e,0));if(this.collisionSystem.updatePosition(this.id,a),this.collisionSystem.getCollisions(this.id).length===0)this.position=a;else{const h=this.position.add(new d(0,this.velocity.y*e));this.collisionSystem.updatePosition(this.id,h),this.collisionSystem.getCollisions(this.id).length===0?this.position=h:this.collisionSystem.updatePosition(this.id,this.position)}}else this.position=n;else this.position=n}updateIdle(e){this.idleTimer+=e,this.velocity=new d(0,0),this.idleTimer>this.idleDuration&&this.setBehavior("patrol")}updatePatrol(e){if(this.patrolPoints.length===0){this.setBehavior("idle");return}this.targetPosition||(this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone());const t=this.targetPosition.subtract(this.position);t.length()<10?(this.currentPatrolIndex=(this.currentPatrolIndex+1)%this.patrolPoints.length,this.targetPosition=this.patrolPoints[this.currentPatrolIndex].clone(),this.velocity=new d(0,0)):this.velocity=t.normalize().multiply(this.speed)}updateChase(e){if(!this.targetPosition)return;const t=this.targetPosition.subtract(this.position);t.length()>0&&(this.velocity=t.normalize().multiply(this.speed*1.2))}updateFlee(e,t){const i=this.position.subtract(t),s=i.length();s>this.fleeRange?this.setBehavior("patrol"):s>0&&(this.velocity=i.normalize().multiply(this.speed*1.5))}render(e,t){const i=t.worldToScreen(this.position),s=t.getZoom();this.showVision&&this.drawVisionCone(e,t,i),e.drawCircle(i,this.radius*s,this.color,!0);const n=this.radius*1.5*s,l=i.add(this.direction.multiply(n));e.drawLine(i,l,"#ffffff",1),this.drawHealthBar(e,i,s)}drawHealthBar(e,t,i){const s=this.radius*2.5*i,n=3*i,l=t.y-this.radius*1.5*i,a=e.getContext();a.fillStyle="#000000",a.fillRect(t.x-s/2,l,s,n),a.strokeStyle="#ffffff",a.lineWidth=1,a.strokeRect(t.x-s/2,l,s,n);const r=this.health/this.maxHealth,h=s*r;r>.5?a.fillStyle="#00ff00":r>.25?a.fillStyle="#ffff00":a.fillStyle="#ff0000",a.fillRect(t.x-s/2,l,h,n)}drawVisionCone(e,t,i){const s=t.getZoom(),n=this.visionRange*s,l=this.visionAngle/2,a=Math.atan2(this.direction.y,this.direction.x),r=a-l*Math.PI/180,h=a+l*Math.PI/180,c=i.add(new d(Math.cos(r)*n,Math.sin(r)*n)),g=i.add(new d(Math.cos(h)*n,Math.sin(h)*n));e.drawLine(i,c,"#4a90e2",1),e.drawLine(i,g,"#4a90e2",1);const u=e.getContext();u.strokeStyle="#4a90e2",u.lineWidth=1,u.beginPath(),u.arc(i.x,i.y,n,r,h),u.stroke(),u.fillStyle="rgba(74, 144, 226, 0.1)",u.beginPath(),u.moveTo(i.x,i.y),u.arc(i.x,i.y,n,r,h),u.lineTo(i.x,i.y),u.fill()}getPosition(){return this.position.clone()}setPosition(e){this.position=e.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position)}getRadius(){return this.radius}getId(){return this.id}getDirection(){return this.direction.clone()}getVisionRange(){return this.visionRange}getVisionAngle(){return this.visionAngle}isPointInVision(e){const t=e.subtract(this.position);if(t.length()>this.visionRange)return!1;const s=Math.atan2(t.y,t.x),n=Math.atan2(this.direction.y,this.direction.x),l=this.visionAngle/2;let a=s-n;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;return Math.abs(a)<=l*Math.PI/180}isPointInVisionWithLineOfSight(e){return this.isPointInVision(e)?this.collisionSystem?this.collisionSystem.raycast(this.position,e,[this.id,"player"]):!0:!1}setShowVision(e){this.showVision=e}getShowVision(){return this.showVision}takeDamage(e,t){this.isDead||(this.health-=e,this.health<=0&&(this.health=0,this.isDead=!0),t&&(this.setBehavior("chase"),this.targetPosition=t.clone()))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}tryShoot(e){this.onShoot&&e-this.lastShotTime>=this.shotCooldown&&(this.lastShotTime=e,this.onShoot(this.position.clone(),this.direction.clone()))}setOnShoot(e){this.onShoot=e}cleanup(){this.collisionSystem&&this.collisionSystem.unregister(this.id)}}class I{constructor(){o(this,"npcs",new Map);o(this,"collisionSystem",null);o(this,"gameMap",null);o(this,"maxNPCs",5);o(this,"_spawnRange",600);o(this,"despawnRange",1e3);o(this,"npcIdCounter",0);o(this,"npcHealth",50);o(this,"npcSpeed",40);o(this,"npcShootCooldown",.5)}setCollisionSystem(e){this.collisionSystem=e;for(const t of this.npcs.values())t.setCollisionSystem(e)}setGameMap(e){this.gameMap=e}setNPCProperties(e,t,i){this.npcHealth=e,this.npcSpeed=t,this.npcShootCooldown=i;for(const s of this.npcs.values())s.setProperties(e,t,i)}setMaxNPCs(e){this.maxNPCs=e}createNPC(e,t){const i=new H(e,t);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),i.setProperties(this.npcHealth,this.npcSpeed,this.npcShootCooldown),this.npcs.set(e,i),i}getNPC(e){return this.npcs.get(e)}removeNPC(e){const t=this.npcs.get(e);return t&&t.cleanup(),this.npcs.delete(e)}getAllNPCs(){return Array.from(this.npcs.values())}getNPCCount(){return this.npcs.size}update(e,t,i=0){const s=[];for(const[n,l]of this.npcs.entries())l.update(e,t,i),(l.getPosition().distance(t)>this.despawnRange||l.getIsDead())&&s.push(n);for(const n of s)this.removeNPC(n);this.spawnNPCsAroundPlayer(t)}spawnNPCsAroundPlayer(e){if(this.npcs.size>=this.maxNPCs)return;const t=this.maxNPCs-this.npcs.size;for(let i=0;i<t;i++){let s=null;for(let r=0;r<10;r++){const h=Math.random()*Math.PI*2,c=400+Math.random()*200,g=e.x+Math.cos(h)*c,u=e.y+Math.sin(h)*c,f=new d(g,u);if(!(this.gameMap&&this.gameMap.isPointInBuilding(f))){s=f;break}}if(!s)continue;const n=`npc_${this.npcIdCounter++}`,l=this.createNPC(n,s),a=[s.clone(),new d(s.x+200,s.y),new d(s.x+200,s.y+200),new d(s.x,s.y+200)];l.setPatrolPoints(a)}}render(e,t){for(const i of this.npcs.values())i.render(e,t)}clear(){for(const e of this.npcs.values())e.cleanup();this.npcs.clear()}}class D{constructor(){o(this,"colliders",new Map)}register(e,t){this.colliders.set(e,t)}unregister(e){this.colliders.delete(e)}updatePosition(e,t){const i=this.colliders.get(e);i&&(i.position=t.clone())}circleToCircle(e,t){return e.position.distance(t.position)<e.radius+t.radius}circleToRect(e,t){const i=t.position.x,s=t.position.x+(t.width||0),n=t.position.y,l=t.position.y+(t.height||0),a=Math.max(i,Math.min(e.position.x,s)),r=Math.max(n,Math.min(e.position.y,l));return Math.sqrt((e.position.x-a)**2+(e.position.y-r)**2)<e.radius}rectToRect(e,t){return e.position.x<t.position.x+(t.width||0)&&e.position.x+(e.width||0)>t.position.x&&e.position.y<t.position.y+(t.height||0)&&e.position.y+(e.height||0)>t.position.y}isColliding(e,t){const i=this.colliders.get(e),s=this.colliders.get(t);return!i||!s?!1:i.type==="circle"&&s.type==="circle"?this.circleToCircle(i,s):i.type==="circle"&&s.type==="rect"?this.circleToRect(i,s):i.type==="rect"&&s.type==="circle"?this.circleToRect(s,i):this.rectToRect(i,s)}getCollisions(e){const t=[];for(const[i]of this.colliders)i!==e&&this.isColliding(e,i)&&t.push(i);return t}pointInCollider(e,t){const i=this.colliders.get(t);return i?i.type==="circle"?e.distance(i.position)<i.radius:e.x>=i.position.x&&e.x<=i.position.x+(i.width||0)&&e.y>=i.position.y&&e.y<=i.position.y+(i.height||0):!1}getCollider(e){return this.colliders.get(e)}getCollisionNormal(e,t){const i=this.colliders.get(e),s=this.colliders.get(t);if(!i||!s)return null;const n=s.position.subtract(i.position);return n.length()===0?new d(1,0):n.normalize()}getCollisionNormalCircleRect(e,t){const i=this.colliders.get(e),s=this.colliders.get(t);if(!i||!s)return null;const n=s.position.x,l=s.position.x+(s.width||0),a=s.position.y,r=s.position.y+(s.height||0),h=Math.max(n,Math.min(i.position.x,l)),c=Math.max(a,Math.min(i.position.y,r)),g=new d(i.position.x-h,i.position.y-c);return g.length()===0?new d(1,0):g.normalize()}raycastBuildings(e,t){const i=t.subtract(e),s=i.length();if(s===0)return!0;const n=i.normalize();for(const[l,a]of this.colliders)if(l.startsWith("building_")&&this.raycastCollider(e,n,s,a))return!1;return!0}raycast(e,t,i=[]){const s=t.subtract(e),n=s.length();if(n===0)return!0;const l=s.normalize(),a=new Set(i);for(const[r,h]of this.colliders)if(!a.has(r)&&this.raycastCollider(e,l,n,h))return!1;return!0}raycastCollider(e,t,i,s){return s.type==="circle"?this.raycastCircle(e,t,i,s):this.raycastRect(e,t,i,s)}raycastCircle(e,t,i,s){const l=s.position.subtract(e).dot(t);return l<0||l>i?!1:e.add(t.multiply(l)).distance(s.position)<s.radius}raycastRect(e,t,i,s){const n=s.position.x,l=s.position.x+(s.width||0),a=s.position.y,r=s.position.y+(s.height||0);let h=0,c=i;if(Math.abs(t.x)>1e-4){const g=(n-e.x)/t.x,u=(l-e.x)/t.x,f=Math.min(g,u),m=Math.max(g,u);h=Math.max(h,f),c=Math.min(c,m)}else if(e.x<n||e.x>l)return!1;if(Math.abs(t.y)>1e-4){const g=(a-e.y)/t.y,u=(r-e.y)/t.y,f=Math.min(g,u),m=Math.max(g,u);h=Math.max(h,f),c=Math.min(c,m)}else if(e.y<a||e.y>r)return!1;return h<=c}}class W{constructor(e,t,i=32){o(this,"tileSize");o(this,"elementMap",new Map);o(this,"collisionSystem");o(this,"chunkSize",10);o(this,"generatedChunks",new Set);o(this,"buildingIdCounter",0);this.tileSize=i,this.collisionSystem=new D}getChunkKey(e,t){return`${e},${t}`}_getTileChunk(e,t){return{x:Math.floor(e/this.chunkSize),y:Math.floor(t/this.chunkSize)}}generateChunk(e,t){const i=this.getChunkKey(e,t);if(this.generatedChunks.has(i))return;this.generatedChunks.add(i);const s=e*this.chunkSize,n=t*this.chunkSize,l=s+this.chunkSize,a=n+this.chunkSize;for(let r=n;r<a;r++)for(let h=s;h<l;h++){const c=`${h},${r}`;this.elementMap.set(c,{x:h*this.tileSize,y:r*this.tileSize,width:this.tileSize,height:this.tileSize,type:"grass",color:"#2d5016"})}this.generateRoadsInChunk(s,n,l,a),this.generateBuildingsInChunk(s,n,l,a)}generateRoadsInChunk(e,t,i,s){for(let n=t;n<s;n++)if(n%8===0)for(let l=e;l<i;l++){const a=`${l},${n}`,r=this.elementMap.get(a);r&&(r.type="road",r.color="#444444")}for(let n=e;n<i;n++)if(n%8===0)for(let l=t;l<s;l++){const a=`${n},${l}`,r=this.elementMap.get(a);r&&(r.type="road",r.color="#444444")}}generateBuildingsInChunk(e,t,i,s){const n=["#8b4513","#a0522d","#cd853f","#daa520"];for(let l=t+2;l<s-2;l+=10)for(let a=e+2;a<i-2;a+=10){const r=a*73856093^l*19349663,h=Math.abs(Math.sin(r)*1e4)%1,c=Math.abs(Math.sin(r+1)*1e4)%1,g=2+h*3|0,u=2+c*3|0;for(let f=0;f<u;f++)for(let m=0;m<g;m++){const y=a+m,w=l+f;if(y<i&&w<s){const M=`${y},${w}`,C=this.elementMap.get(M);if(C){const S=`building_${this.buildingIdCounter++}`;C.type="building",C.color=n[Math.floor(h*n.length)],C.id=S,this.collisionSystem.register(S,{position:new d(C.x,C.y),radius:0,type:"rect",width:C.width,height:C.height})}}}}}ensureChunksGenerated(e){const t=Math.floor(e.x/this.tileSize),i=Math.floor(e.y/this.tileSize),s=Math.ceil((e.x+e.width)/this.tileSize),n=Math.ceil((e.y+e.height)/this.tileSize),l=Math.floor(t/this.chunkSize),a=Math.floor(i/this.chunkSize),r=Math.ceil(s/this.chunkSize),h=Math.ceil(n/this.chunkSize);for(let c=a;c<h;c++)for(let g=l;g<r;g++)this.generateChunk(g,c)}render(e,t){const i=t.getViewport(),s=t.getZoom();this.ensureChunksGenerated(i);for(const n of this.elementMap.values()){if(n.x+n.width<i.x||n.x>i.x+i.width||n.y+n.height<i.y||n.y>i.y+i.height)continue;const l=t.worldToScreen(new d(n.x,n.y)),a=n.width*s,r=n.height*s;e.drawRect(l,a,r,n.color,!0),e.drawRect(l,a,r,"#333333",!1)}}getTileSize(){return this.tileSize}getCollisionSystem(){return this.collisionSystem}getBuildings(){return Array.from(this.elementMap.values()).filter(e=>e.type==="building")}isPointInBuilding(e){const t=this.getBuildings();for(const i of t)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;return!1}}class ${constructor(e,t,i){o(this,"position");o(this,"type");o(this,"weaponType");o(this,"radius",8);o(this,"color");o(this,"id");o(this,"rotationAngle",0);this.id=e,this.position=t.clone(),this.type="weapon",this.weaponType=i,this.color=this.getColorByWeapon(i)}getColorByWeapon(e){switch(e){case x.PISTOL:return"#ffff00";case x.RIFLE:return"#00ff00";case x.SHOTGUN:return"#ff6600"}}update(e){this.rotationAngle+=e*3}render(e,t){const i=t.worldToScreen(this.position),s=t.getZoom(),n=e.getContext();switch(n.save(),n.translate(i.x,i.y),n.rotate(this.rotationAngle),this.weaponType){case x.PISTOL:this.drawPistolIcon(n,s);break;case x.RIFLE:this.drawRifleIcon(n,s);break;case x.SHOTGUN:this.drawShotgunIcon(n,s);break}n.restore(),e.drawCircle(i,3*s,"#ffffff",!0),this.drawWeaponLabel(e,i,s)}drawWeaponLabel(e,t,i){const s=e.getContext();let n="";switch(this.weaponType){case x.RIFLE:n="æ­¥æžª";break;case x.SHOTGUN:n="éœ°å¼¹æžª";break;default:return}s.fillStyle=this.color,s.font=`${12*i}px Arial`,s.textAlign="center",s.textBaseline="top",s.fillText(n,t.x,t.y+this.radius*1.5*i)}drawPistolIcon(e,t){e.fillStyle=this.color,e.beginPath();for(let i=0;i<5;i++){const s=i*4*Math.PI/5-Math.PI/2,n=Math.cos(s)*this.radius*t,l=Math.sin(s)*this.radius*t;i===0?e.moveTo(n,l):e.lineTo(n,l)}e.closePath(),e.fill()}drawRifleIcon(e,t){e.fillStyle=this.color;const i=this.radius*1.5*t,s=this.radius*.8*t;e.fillRect(-i/2,-s/2,i,s),e.strokeStyle="#ffffff",e.lineWidth=1,e.strokeRect(-i/2,-s/2,i,s)}drawShotgunIcon(e,t){e.fillStyle=this.color,e.beginPath(),e.arc(0,0,this.radius*t,0,Math.PI*2),e.fill(),e.strokeStyle="#ffffff",e.lineWidth=1,e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=.5;for(let i=0;i<3;i++){const s=i*Math.PI/3,n=Math.cos(s)*this.radius*.5*t,l=Math.sin(s)*this.radius*.5*t;e.beginPath(),e.moveTo(0,0),e.lineTo(n,l),e.stroke()}}getPosition(){return this.position.clone()}getId(){return this.id}getWeaponType(){return this.weaponType}getRadius(){return this.radius}}class k{constructor(){o(this,"items",new Map);o(this,"itemIdCounter",0)}addItem(e,t){const i=`item_${this.itemIdCounter++}`,s=new $(i,e,t);return this.items.set(i,s),s}removeItem(e){return this.items.delete(e)}getItem(e){return this.items.get(e)}getAllItems(){return Array.from(this.items.values())}update(e){for(const t of this.items.values())t.update(e)}render(e,t){for(const i of this.items.values())i.render(e,t)}getCount(){return this.items.size}clear(){this.items.clear()}}class O{constructor(e,t){o(this,"position");o(this,"velocity");o(this,"speed",600);o(this,"maxSpeed",900);o(this,"acceleration",450);o(this,"friction",.98);o(this,"width",40);o(this,"height",24);o(this,"color","#ff0000");o(this,"rotation",0);o(this,"id");o(this,"collisionSystem",null);o(this,"isOccupied",!1);o(this,"occupantId",null);o(this,"maxHealth",100);o(this,"health",100);o(this,"isDead",!1);o(this,"restitution",.6);o(this,"lastCollisionNormal",null);this.id=e,this.position=t.clone(),this.velocity=new d(0,0)}setCollisionSystem(e){this.collisionSystem=e,this.collisionSystem.register(this.id,{position:this.position.clone(),radius:Math.max(this.width,this.height)/2,type:"circle"})}getId(){return this.id}getPosition(){return this.position.clone()}getWidth(){return this.width}getHeight(){return this.height}isOccupiedByPlayer(){return this.isOccupied}getOccupantId(){return this.occupantId}enterVehicle(e){this.isOccupied=!0,this.occupantId=e}exitVehicle(){this.isOccupied=!1,this.occupantId=null,this.velocity=new d(0,0)}setPosition(e){this.position=e.clone(),this.collisionSystem&&this.collisionSystem.updatePosition(this.id,this.position.clone())}setRotation(e){this.rotation=e}getRotation(){return this.rotation}accelerate(){if(this.velocity.length()<this.maxSpeed){const t=new d(Math.cos(this.rotation),Math.sin(this.rotation));this.velocity=this.velocity.add(t.multiply(this.acceleration*.016))}}decelerate(){this.velocity=this.velocity.multiply(.85)}turnLeft(){this.rotation-=.05}turnRight(){this.rotation+=.05}update(e){this.velocity=this.velocity.multiply(this.friction);const t=this.position.add(this.velocity.multiply(e));if(this.collisionSystem){this.collisionSystem.updatePosition(this.id,t);const i=this.collisionSystem.getCollisions(this.id);if(i.length>0){const s=this.velocity.length(),n=this.position.add(new d(this.velocity.x*e,0));if(this.collisionSystem.updatePosition(this.id,n),this.collisionSystem.getCollisions(this.id).length===0)this.position=n,this.velocity=new d(this.velocity.x,-this.velocity.y*this.restitution);else{const a=this.position.add(new d(0,this.velocity.y*e));if(this.collisionSystem.updatePosition(this.id,a),this.collisionSystem.getCollisions(this.id).length===0)this.position=a,this.velocity=new d(-this.velocity.x*this.restitution,this.velocity.y);else{this.collisionSystem.updatePosition(this.id,this.position);let h=null;for(const c of i){const g=this.collisionSystem.getCollider(this.id),u=this.collisionSystem.getCollider(c);if(g&&u&&(g.type==="circle"&&u.type==="circle"?h=this.collisionSystem.getCollisionNormal(this.id,c):g.type==="circle"&&u.type==="rect"&&(h=this.collisionSystem.getCollisionNormalCircleRect(this.id,c)),h)){this.lastCollisionNormal=h;break}}if(h){const c=this.velocity.x*h.x+this.velocity.y*h.y;if(c<0){const g=(1+this.restitution)*c,u=new d(this.velocity.x-g*h.x,this.velocity.y-g*h.y);this.velocity=u}}else this.velocity=this.velocity.multiply(-this.restitution);if(s>50){const c=Math.max(1,Math.floor(s/30));this.takeDamage(c)}}}}else this.position=t}else this.position=t}render(e,t){const i=t.worldToScreen(this.position),s=t.getZoom(),n=e.getContext();n.save(),n.translate(i.x,i.y),n.rotate(this.rotation),n.fillStyle=this.color,n.fillRect(-this.width/2*s,-this.height/2*s,this.width*s,this.height*s),n.fillStyle="#87ceeb",n.fillRect(-this.width/3*s,-this.height/3*s,this.width/1.5*s,this.height/3*s),n.fillStyle="#ffff00",n.fillRect(-this.width/2*s,-this.height/4*s,3*s,3*s),n.fillRect(this.width/2*s-3*s,-this.height/4*s,3*s,3*s),n.restore(),this.isOccupied||(n.strokeStyle="#00ff00",n.lineWidth=2,n.strokeRect(i.x-this.width/2*s,i.y-this.height/2*s,this.width*s,this.height*s)),this.renderHealthBar(e,i,s)}renderHealthBar(e,t,i){const s=e.getContext(),n=this.width*i,l=4*i,a=this.height/2*i+8*i;s.fillStyle="#000000",s.fillRect(t.x-n/2,t.y+a,n,l),s.strokeStyle="#ffffff",s.lineWidth=1,s.strokeRect(t.x-n/2,t.y+a,n,l);const r=this.health/this.maxHealth,h=n*r;r>.5?s.fillStyle="#00ff00":r>.25?s.fillStyle="#ffff00":s.fillStyle="#ff0000",s.fillRect(t.x-n/2,t.y+a,h,l)}isPlayerNearby(e,t=50){return this.position.subtract(e).length()<t}takeDamage(e){this.isDead||(this.health-=e,this.health<=0&&(this.health=0,this.isDead=!0))}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getIsDead(){return this.isDead}getRadius(){return Math.max(this.width,this.height)/2}setRestitution(e){this.restitution=Math.max(0,Math.min(1,e))}getRestitution(){return this.restitution}getLastCollisionNormal(){return this.lastCollisionNormal}cleanup(){this.collisionSystem&&this.collisionSystem.unregister(this.id)}}class U{constructor(){o(this,"vehicles",new Map);o(this,"vehicleIdCounter",0);o(this,"collisionSystem",null);o(this,"maxVehicles",0);o(this,"spawnRange",800);o(this,"despawnRange",1200)}setCollisionSystem(e){this.collisionSystem=e}spawnVehicle(e){if(this.vehicles.size>=this.maxVehicles)return Array.from(this.vehicles.values())[0];const t=`vehicle_${this.vehicleIdCounter++}`,i=new O(t,e);return this.collisionSystem&&i.setCollisionSystem(this.collisionSystem),this.vehicles.set(t,i),i}getVehicles(){return Array.from(this.vehicles.values())}getNearbyVehicles(e,t=100){return Array.from(this.vehicles.values()).filter(i=>i.isPlayerNearby(e,t))}getPlayerVehicle(e){for(const t of this.vehicles.values())if(t.getOccupantId()===e)return t;return null}update(e,t){const i=[];for(const[s,n]of this.vehicles){if(n.update(e),n.getIsDead()){i.push(s);continue}n.getPosition().subtract(t).length()>this.despawnRange&&i.push(s)}for(const s of i){const n=this.vehicles.get(s);n&&n.cleanup(),this.vehicles.delete(s)}if(this.vehicles.size<this.maxVehicles&&Math.random()<.01){const s=Math.random()*Math.PI*2,n=400+Math.random()*400,l=new d(t.x+Math.cos(s)*n,t.y+Math.sin(s)*n);this.spawnVehicle(l)}}render(e,t){for(const i of this.vehicles.values())i.render(e,t)}getCount(){return this.vehicles.size}}class F{constructor(){o(this,"currentLevel",1);o(this,"levelTimeLimit",30);o(this,"levelTimeRemaining",30);o(this,"levelStartTime",0);o(this,"isLevelActive",!1);o(this,"levelConfig",{npcCount:e=>Math.min(5+Math.floor((e-1)*4),30),npcHealth:e=>50+(e-1)*35,npcSpeed:e=>40+(e-1)*15,npcShootCooldown:e=>Math.max(.5-(e-1)*.12,.05),scoreMultiplier:e=>1+(e-1)*1.5});this.startLevel(1)}startLevel(e){this.currentLevel=e,this.levelTimeRemaining=this.levelTimeLimit,this.levelStartTime=performance.now()/1e3,this.isLevelActive=!0}update(e){this.isLevelActive&&(this.levelTimeRemaining-=e,this.levelTimeRemaining<0&&(this.levelTimeRemaining=0))}isLevelComplete(){return this.levelTimeRemaining<=0&&this.isLevelActive}completeLevel(){this.isLevelActive=!1,this.startLevel(this.currentLevel+1)}getCurrentLevel(){return this.currentLevel}getTimeRemaining(){return Math.max(0,this.levelTimeRemaining)}getNPCCount(){return this.levelConfig.npcCount(this.currentLevel)}getNPCHealth(){return this.levelConfig.npcHealth(this.currentLevel)}getNPCSpeed(){return this.levelConfig.npcSpeed(this.currentLevel)}getNPCShootCooldown(){return this.levelConfig.npcShootCooldown(this.currentLevel)}getScoreMultiplier(){return this.levelConfig.scoreMultiplier(this.currentLevel)}getLevelTimeLimit(){return this.levelTimeLimit}isActive(){return this.isLevelActive}reset(){this.currentLevel=1,this.levelTimeRemaining=this.levelTimeLimit,this.isLevelActive=!1}}var v=(p=>(p.MAX_HEALTH="max_health",p.MOVEMENT_SPEED="movement_speed",p.WEAPON_DAMAGE="weapon_damage",p.HEALTH_REGEN="health_regen",p.KILL_HEAL="kill_heal",p))(v||{});class _{constructor(){o(this,"upgrades",new Map);o(this,"upgradeConfigs",new Map);this.initializeUpgradeConfigs()}initializeUpgradeConfigs(){const e=[{type:"max_health",name:"â¤ï¸ ç”Ÿå‘½å€¼æå‡",description:"å¢žåŠ æœ€å¤§è¡€é‡",icon:"â¤ï¸",baseValue:30,stackValue:30},{type:"movement_speed",name:"âš¡ ç§»åŠ¨é€Ÿåº¦",description:"æå‡çŽ©å®¶ç§»åŠ¨é€Ÿåº¦",icon:"âš¡",baseValue:30,stackValue:30},{type:"weapon_damage",name:"ðŸ’¥ æ­¦å™¨ä¼¤å®³",description:"æ‰€æœ‰æ­¦å™¨ä¼¤å®³å¢žåŠ ",icon:"ðŸ’¥",baseValue:5,stackValue:5},{type:"health_regen",name:"ðŸ”„ ç”Ÿå‘½æ¢å¤",description:"æ¯ç§’æ¢å¤ä¸€å®šè¡€é‡",icon:"ðŸ”„",baseValue:1,stackValue:1},{type:"kill_heal",name:"ðŸŽ¯ å‡»æ€æ¢å¤",description:"å‡»æ€æ•Œäººæ¢å¤è¡€é‡",icon:"ðŸŽ¯",baseValue:15,stackValue:15}];for(const t of e)this.upgradeConfigs.set(t.type,t)}applyUpgrade(e){const t=this.upgradeConfigs.get(e);if(!t){console.error(`Unknown upgrade type: ${e}`);return}const i=this.upgrades.get(e);i?(i.count++,i.totalValue+=t.stackValue):this.upgrades.set(e,{type:e,count:1,totalValue:t.baseValue})}getUpgradeRecord(e){return this.upgrades.get(e)}getAllUpgrades(){return Array.from(this.upgrades.values())}getUpgradeConfig(e){return this.upgradeConfigs.get(e)}getUpgradeValue(e){const t=this.upgrades.get(e);return t?t.totalValue:0}getNextUpgradeValue(e){const t=this.upgradeConfigs.get(e);if(!t)return 0;const i=this.upgrades.get(e);return i?i.totalValue+t.stackValue:t.baseValue}generateUpgradeOptions(e=3){const t=Array.from(this.upgradeConfigs.keys()),i=[],s=t.sort(()=>Math.random()-.5);for(let n=0;n<Math.min(e,s.length);n++)i.push(s[n]);return i}getUpgradeDisplayInfo(e){const t=this.upgradeConfigs.get(e),i=this.upgrades.get(e);if(!t)throw new Error(`Unknown upgrade type: ${e}`);return{name:t.name,description:t.description,icon:t.icon,currentValue:i?i.totalValue:0,nextValue:this.getNextUpgradeValue(e),count:i?i.count:0}}reset(){this.upgrades.clear()}getSummary(){const e=this.getAllUpgrades();return e.length===0?"æš‚æ— å‡çº§":e.map(t=>{const i=this.upgradeConfigs.get(t.type);return`${i?.icon} ${i?.name}: ${t.count}x (æ€»è®¡: +${t.totalValue})`}).join(`
`)}}class K{constructor(){o(this,"renderer");o(this,"camera");o(this,"inputManager");o(this,"player");o(this,"npcManager");o(this,"gameMap");o(this,"itemManager");o(this,"vehicleManager");o(this,"isRunning",!1);o(this,"frameCount",0);o(this,"lastFrameTime",0);o(this,"fps",0);o(this,"itemSpawnTimer",0);o(this,"itemSpawnInterval",3);o(this,"maxItems",0);o(this,"itemSpawnRange",600);o(this,"score",0);o(this,"gameOver",!1);o(this,"npcBulletManager");o(this,"levelManager");o(this,"upgradeSystem");o(this,"levelUpPending",!1);o(this,"debugMode",!1);o(this,"levelConfirmed",!1);o(this,"isPaused",!1);o(this,"healthRegenTimer",0);o(this,"gameLoop",()=>{if(!this.isRunning)return;const e=performance.now(),t=(e-this.lastFrameTime)/1e3;this.lastFrameTime=e,this.update(t),this.render(),this.frameCount++,e-this.lastFrameTime>1e3&&(this.fps=this.frameCount,this.frameCount=0),requestAnimationFrame(this.gameLoop)});this.renderer=new N("game-canvas"),this.camera=new E(this.renderer.getWidth(),this.renderer.getHeight()),this.inputManager=new z,this.gameMap=new W(0,0,32),this.npcManager=new I,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcManager.setGameMap(this.gameMap),this.setupNPCShootCallback(),this.itemManager=new k,this.vehicleManager=new U,this.vehicleManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcBulletManager=new L,this.levelManager=new F,this.upgradeSystem=new _,this.player=new b(new d(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.player.setGetNPCsCallback(()=>this.npcManager.getAllNPCs()),this.camera.setPosition(this.player.getPosition()),window.addEventListener("resize",()=>{this.camera.updateSize(this.renderer.getWidth(),this.renderer.getHeight())})}start(){if(!this.isRunning){if(!this.levelConfirmed){this.showLevelConfirmDialog();return}this.isRunning=!0,this.lastFrameTime=performance.now(),this.gameLoop()}}stop(){this.isRunning=!1}update(e){if(this.inputManager.isKeyJustPressed("Escape")&&!this.gameOver&&this.levelConfirmed){this.isPaused=!this.isPaused,this.isPaused?this.showPauseMenu():this.closePauseMenu(),this.inputManager.clearJustPressedKeys();return}if(this.isPaused){this.inputManager.clearJustPressedKeys();return}if(this.gameOver){this.inputManager.isKeyPressed("r")&&this.restartGame();return}this.levelManager.update(e),this.levelManager.isLevelComplete()&&!this.levelUpPending&&(this.levelUpPending=!0,this.levelUp());const t=this.inputManager.getMovementInput();if(this.inputManager.isKeyJustPressed("p")){this.debugMode=!this.debugMode;for(const r of this.npcManager.getAllNPCs())r.setShowVision(this.debugMode)}const i=performance.now()/1e3;this.player.fire(i),this.inputManager.isKeyPressed("r")&&this.player.reload(i),this.inputManager.isKeyPressed("1")&&this.player.switchWeapon(x.PISTOL),this.inputManager.isKeyPressed("2")&&this.player.switchWeapon(x.RIFLE),this.inputManager.isKeyPressed("3")&&this.player.switchWeapon(x.SHOTGUN),this.player.update(e,t,i),this.handleHealthRegen(e),this.vehicleManager.update(e,this.player.getPosition()),this.handleVehicleInteraction(),this.npcManager.update(e,this.player.getPosition(),i),this.npcBulletManager.update(e),this.itemManager.update(e),this.itemSpawnTimer+=e,this.itemSpawnTimer>=this.itemSpawnInterval&&(this.itemSpawnTimer=0,this.itemManager.getCount()<this.maxItems&&this.spawnRandomItem()),this.cleanupFarItems(),this.checkItemPickup(),this.checkBulletsHitBuildings(),this.checkBulletHits(),this.checkNPCBulletHits(),this.cleanupNPCBullets(),this.checkDestroyedVehicles(),this.player.getIsDead()&&(this.gameOver=!0),this.camera.follow(this.player.getPosition(),.1);const n=this.player.isInVehicle()?.9:1.5,l=this.camera.getZoom(),a=n-l;Math.abs(a)>.01?this.camera.setZoom(l+a*.1):this.camera.setZoom(n),this.updateHUD(),this.inputManager.clearJustPressedKeys()}spawnRandomItem(){for(let e=0;e<5;e++){const t=Math.random()*Math.PI*2,i=300+Math.random()*300,s=this.player.getPosition().x+Math.cos(t)*i,n=this.player.getPosition().y+Math.sin(t)*i;if(!this.isPositionInBuilding(new d(s,n))){const l=[x.RIFLE,x.SHOTGUN],a=l[Math.floor(Math.random()*l.length)];this.itemManager.addItem(new d(s,n),a);return}}}dropItemFromNPC(e){const t=[x.RIFLE,x.SHOTGUN],i=t[Math.floor(Math.random()*t.length)];this.itemManager.addItem(e.clone(),i)}cleanupFarItems(){const e=this.player.getPosition(),t=this.itemManager.getAllItems();for(const i of t)e.distance(i.getPosition())>this.itemSpawnRange&&this.itemManager.removeItem(i.getId())}isPositionInBuilding(e){const t=this.gameMap.getBuildings();for(const i of t)if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return!0;return!1}handleVehicleInteraction(){if(this.player.isInVehicle()){this.inputManager.isKeyJustPressed("f")&&this.player.exitVehicle();return}const e=this.vehicleManager.getNearbyVehicles(this.player.getPosition(),100);if(e.length>0&&this.inputManager.isKeyJustPressed("f")){const t=e[0];this.player.enterVehicle(t)}}checkItemPickup(){const e=this.player.getPosition(),t=this.player.getRadius();for(const i of this.itemManager.getAllItems())e.distance(i.getPosition())<t+i.getRadius()&&(this.player.pickupWeapon(i.getWeaponType()),this.itemManager.removeItem(i.getId()))}setupNPCShootCallback(){const e=this.npcManager.createNPC.bind(this.npcManager);this.npcManager.createNPC=(t,i)=>{const s=e(t,i);return s.setOnShoot((n,l)=>{const a=new R(n,l,10,500,300,3,t);this.npcBulletManager.addBullet(a)}),s}}applyLevelConfig(){this.levelManager.getCurrentLevel();const e=this.levelManager.getNPCCount(),t=this.levelManager.getNPCHealth(),i=this.levelManager.getNPCSpeed(),s=this.levelManager.getNPCShootCooldown();this.npcManager.setMaxNPCs(e),this.npcManager.setNPCProperties(t,i,s)}levelUp(){this.levelManager.completeLevel(),this.showLevelConfirmDialog()}showLevelConfirmDialog(){this.isPaused=!0,this.levelManager.getCurrentLevel()>1?this.showUpgradeDialog():this.showLevelInfoDialog()}showUpgradeDialog(){const e=this.upgradeSystem.generateUpgradeOptions(3);this.createUpgradeDialog(e,()=>{this.showLevelInfoDialog()})}showLevelInfoDialog(){const e=this.levelManager.getCurrentLevel(),t=this.levelManager.getNPCCount(),i=this.levelManager.getNPCHealth(),s=this.levelManager.getNPCSpeed(),n=this.levelManager.getNPCShootCooldown(),l=this.levelManager.getLevelTimeLimit(),a=this.levelManager.getScoreMultiplier(),r=`ðŸ“Š å…³å¡ä¿¡æ¯ï¼š
  â€¢ æ•Œäººæ•°é‡: ${t}
  â€¢ æ•Œäººè¡€é‡: ${i}
  â€¢ æ•Œäººé€Ÿåº¦: ${s}
  â€¢ æ•Œäººå°„é€Ÿ: ${(1/n).toFixed(1)} å‘/ç§’
  â€¢ æ—¶é—´é™åˆ¶: ${l} ç§’
  â€¢ å¾—åˆ†å€æ•°: ${a}x

å‡†å¤‡å¥½äº†å—ï¼Ÿ`;this.createCustomConfirmDialog(r,`ç¬¬ ${e} å…³`,()=>{this.levelConfirmed=!0,this.levelManager.startLevel(e),this.applyLevelConfig(),this.npcManager.clear(),this.levelUpPending=!1,this.isPaused=!1,this.lastFrameTime=performance.now(),this.isRunning||(this.isRunning=!0,this.gameLoop())})}createCustomConfirmDialog(e,t,i){const s=document.getElementById("level-confirm-dialog");s&&s.remove();const n=document.createElement("div");n.id="level-confirm-dialog",n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-family: 'Courier New', monospace;
    `;const l=document.createElement("div");l.style.cssText=`
      background-color: #1a1a1a;
      border: 3px solid #00ff00;
      border-radius: 8px;
      padding: 0;
      max-width: 500px;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
      animation: slideIn 0.3s ease-out;
      overflow: hidden;
    `;const a=document.createElement("style");a.textContent=`
      @keyframes slideIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    `,document.head.appendChild(a);const r=document.createElement("div");r.style.cssText=`
      background-color: #0a0a0a;
      border-bottom: 2px solid #00ff00;
      padding: 15px;
      text-align: center;
    `;const h=document.createElement("div");h.textContent=t,h.style.cssText=`
      color: #00ff00;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      letter-spacing: 2px;
    `,r.appendChild(h);const c=document.createElement("div");c.style.cssText=`
      padding: 30px;
    `;const g=document.createElement("pre");g.textContent=e,g.style.cssText=`
      color: #00ff00;
      font-size: 14px;
      line-height: 1.6;
      margin: 0 0 30px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    `;const u=document.createElement("div");u.style.cssText=`
      display: flex;
      gap: 15px;
      justify-content: center;
    `;const f=document.createElement("button");f.textContent="å¼€å§‹æ¸¸æˆ",f.style.cssText=`
      padding: 12px 30px;
      background-color: #00ff00;
      color: #000;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
    `,f.onmouseover=()=>{f.style.backgroundColor="#00cc00",f.style.boxShadow="0 0 15px rgba(0, 255, 0, 0.8)"},f.onmouseout=()=>{f.style.backgroundColor="#00ff00",f.style.boxShadow="none"},f.onclick=()=>{n.remove(),i()},u.appendChild(f),c.appendChild(g),c.appendChild(u),l.appendChild(r),l.appendChild(c),n.appendChild(l),document.body.appendChild(n)}restartGame(){this.score=0,this.gameOver=!1,this.npcBulletManager.clear(),this.levelUpPending=!1,this.levelConfirmed=!1,this.healthRegenTimer=0,this.levelManager.reset(),this.upgradeSystem.reset(),this.showLevelConfirmDialog(),this.player=new b(new d(0,0)),this.player.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcManager=new I,this.npcManager.setCollisionSystem(this.gameMap.getCollisionSystem()),this.npcManager.setGameMap(this.gameMap),this.setupNPCShootCallback(),this.player.setGetNPCsCallback(()=>this.npcManager.getAllNPCs()),this.itemManager=new k}checkBulletsHitBuildings(){const e=this.player.getBulletManager().getBullets();for(let i=e.length-1;i>=0;i--){const s=e[i];this.gameMap.isPointInBuilding(s.getPosition())&&this.player.getBulletManager().removeBullet(i)}const t=this.npcBulletManager.getBullets();for(let i=t.length-1;i>=0;i--){const s=t[i];this.gameMap.isPointInBuilding(s.getPosition())&&this.npcBulletManager.removeBullet(i)}}checkBulletHits(){const e=this.player.getBulletManager().getBullets(),t=this.npcManager.getAllNPCs(),i=this.vehicleManager.getVehicles(),s=this.player.getCurrentVehicle();for(let n=e.length-1;n>=0;n--){const l=e[n],a=l.getPosition(),r=l.getSize();let h=!1;for(const c of t){if(c.getIsDead())continue;const g=c.getPosition(),u=c.getRadius();if(a.distance(g)<r+u){const m=l.getDamage();if(c.takeDamage(m,this.player.getPosition()),c.getIsDead()){const y=this.levelManager.getScoreMultiplier();this.score+=Math.floor(y),this.dropItemFromNPC(g),this.handleKillHeal(),this.npcManager.removeNPC(c.getId())}h=!0;break}}if(!h)for(const c of i){if(c.getIsDead()||s===c)continue;const g=c.getPosition(),u=c.getRadius();if(a.distance(g)<r+u){const m=l.getDamage();c.takeDamage(m),h=!0;break}}h&&this.player.getBulletManager().removeBullet(n)}}checkNPCBulletHits(){const e=this.npcBulletManager.getBullets(),t=this.player.getPosition(),i=this.player.getRadius(),s=this.vehicleManager.getVehicles();for(let n=e.length-1;n>=0;n--){const l=e[n],a=l.getPosition(),r=l.getSize();let h=!1;if(!this.player.isInVehicle()&&a.distance(t)<r+i){const g=l.getDamage();this.player.takeDamage(g),h=!0}if(!h)for(const c of s){if(c.getIsDead())continue;const g=c.getPosition(),u=c.getRadius();if(a.distance(g)<r+u){const m=l.getDamage();c.takeDamage(m),h=!0;break}}h&&this.npcBulletManager.removeBullet(n)}}cleanupNPCBullets(){const e=this.npcBulletManager.getBullets(),t=this.player.getPosition();for(let i=e.length-1;i>=0;i--)e[i].getPosition().distance(t)>1e3&&this.npcBulletManager.removeBullet(i)}checkDestroyedVehicles(){if(this.player.isInVehicle()){const e=this.vehicleManager.getPlayerVehicle("player");e&&e.getIsDead()&&this.player.exitVehicle()}}render(){this.renderer.clear(),this.gameMap.render(this.renderer,this.camera),this.itemManager.render(this.renderer,this.camera),this.vehicleManager.render(this.renderer,this.camera),this.npcManager.render(this.renderer,this.camera),this.npcBulletManager.render(this.renderer,this.camera);const e=performance.now()/1e3;this.player.render(this.renderer,this.camera,e),this.drawDebugGrid(),this.debugMode&&this.drawColliders(),this.gameOver&&this.drawGameOverScreen()}drawGameOverScreen(){const e=this.renderer.getContext(),t=this.renderer.getWidth(),i=this.renderer.getHeight();e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,t,i),e.fillStyle="#ff0000",e.font="bold 48px Arial",e.textAlign="center",e.textBaseline="middle",e.fillText("GAME OVER",t/2,i/2-100),e.fillStyle="#00ffff",e.font="bold 36px Arial",e.fillText(`æœ€ç»ˆå…³å¡: ${this.levelManager.getCurrentLevel()}`,t/2,i/2-20),e.fillStyle="#ffff00",e.font="bold 36px Arial",e.fillText(`æœ€ç»ˆå¾—åˆ†: ${this.score}`,t/2,i/2+40),e.fillStyle="#00ff00",e.font="24px Arial",e.fillText("æŒ‰ R é”®é‡æ–°å¼€å§‹",t/2,i/2+100)}drawDebugGrid(){const e=this.camera.getViewport(),t=32,i=Math.floor(e.x/t)*t,s=Math.floor(e.y/t)*t,n=i+e.width+t,l=s+e.height+t;for(let a=i;a<n;a+=t){const r=this.camera.worldToScreen(new d(a,s)),h=this.camera.worldToScreen(new d(a,l));this.renderer.drawLine(r,h,"#444444",.5)}for(let a=s;a<l;a+=t){const r=this.camera.worldToScreen(new d(i,a)),h=this.camera.worldToScreen(new d(n,a));this.renderer.drawLine(r,h,"#444444",.5)}}updateHUD(){const e=document.getElementById("score"),t=document.getElementById("weapon"),i=document.getElementById("ammo");if(e){const s=this.levelManager.getCurrentLevel(),n=Math.ceil(this.levelManager.getTimeRemaining());e.textContent=`å…³å¡: ${s} | æ—¶é—´: ${n}s | å¾—åˆ†: ${this.score}`}if(t){const n=this.player.getWeapon().getName(),l=this.player.isReloading()?" [è£…å¼¹ä¸­]":"";t.textContent=`æ­¦å™¨: ${n}${l}`}if(i){const s=this.player.getWeapon(),n=s.getCurrentAmmo(),l=s.getReserveAmmo();i.textContent=`å¼¹è¯: ${n}/${l}`}this.updateControlsDisplay()}updateControlsDisplay(){const e=document.getElementById("controls-walking"),t=document.getElementById("controls-driving");!e||!t||(this.player.isInVehicle()?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none"))}drawColliders(){const e=this.gameMap.getCollisionSystem();this.camera.getViewport();const t=e.colliders;for(const[i,s]of t){const n=this.camera.worldToScreen(s.position),l=200;if(n.x<-l||n.x>this.renderer.getWidth()+l||n.y<-l||n.y>this.renderer.getHeight()+l)continue;let a="#00ff00";if(i.startsWith("building_")?a="#ff0000":i.startsWith("player")?a="#00ffff":i.startsWith("npc_")?a="#ffff00":i.startsWith("vehicle_")&&(a="#ff00ff"),s.type==="circle")this.renderer.drawColliderCircle(n,s.radius,a,1.5);else if(s.type==="rect"){const h=this.camera.worldToScreen(new d(s.position.x+s.width,s.position.y+s.height)),c=h.x-n.x,g=h.y-n.y;this.renderer.drawColliderRect(n,c,g,a,1.5)}const r=new d(n.x+5,n.y-5);this.renderer.drawText(i,r,a,10,"Arial")}}createUpgradeDialog(e,t){const i=document.getElementById("upgrade-dialog");i&&i.remove();const s=document.createElement("div");s.id="upgrade-dialog",s.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-family: 'Courier New', monospace;
    `;const n=document.createElement("div");n.style.cssText=`
      background-color: #1a1a1a;
      border: 3px solid #ffff00;
      border-radius: 8px;
      padding: 0;
      max-width: 800px;
      box-shadow: 0 0 30px rgba(255, 255, 0, 0.5);
      animation: slideIn 0.3s ease-out;
      overflow: hidden;
    `;const l=document.createElement("div");l.style.cssText=`
      background-color: #0a0a0a;
      border-bottom: 2px solid #ffff00;
      padding: 15px;
      text-align: center;
    `;const a=document.createElement("div");a.textContent="ðŸŽ® é€‰æ‹©å‡çº§",a.style.cssText=`
      color: #ffff00;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
      letter-spacing: 2px;
    `,l.appendChild(a);const r=document.createElement("div");r.style.cssText=`
      padding: 30px;
    `;const h=document.createElement("div");h.style.cssText=`
      color: #00ff00;
      font-size: 12px;
      line-height: 1.6;
      margin-bottom: 20px;
      padding: 10px;
      background-color: rgba(0, 255, 0, 0.1);
      border-left: 2px solid #00ff00;
    `;const c=this.upgradeSystem.getAllUpgrades();if(c.length>0){let u=`ðŸ“Š å½“å‰å‡çº§ï¼š
`;for(const f of c){const m=this.upgradeSystem.getUpgradeConfig(f.type);u+=`  ${m?.icon} ${m?.name}: ${f.count}x (æ€»è®¡: +${f.totalValue})
`}h.textContent=u}else h.textContent="æš‚æ— å‡çº§";r.appendChild(h);const g=document.createElement("div");g.style.cssText=`
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    `;for(const u of e){if(!this.upgradeSystem.getUpgradeConfig(u))continue;const m=this.upgradeSystem.getUpgradeDisplayInfo(u),y=document.createElement("button");y.style.cssText=`
        padding: 15px;
        background-color: #0a3a0a;
        border: 2px solid #00ff00;
        border-radius: 4px;
        color: #00ff00;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Courier New', monospace;
        text-align: left;
        line-height: 1.6;
      `;const w=`${m.icon} ${m.name}

${m.description}

å½“å‰: +${m.currentValue}
é€‰æ‹©åŽ: +${m.nextValue}
(å·²é€‰æ‹© ${m.count} æ¬¡)`;y.textContent=w,y.onmouseover=()=>{y.style.backgroundColor="#0a5a0a",y.style.boxShadow="0 0 15px rgba(0, 255, 0, 0.8)"},y.onmouseout=()=>{y.style.backgroundColor="#0a3a0a",y.style.boxShadow="none"},y.onclick=()=>{this.upgradeSystem.applyUpgrade(u),this.applyUpgradeEffect(u),s.remove(),t()},g.appendChild(y)}r.appendChild(g),n.appendChild(l),n.appendChild(r),s.appendChild(n),document.body.appendChild(s)}applyUpgradeEffect(e){switch(this.upgradeSystem.getUpgradeValue(e),e){case v.MAX_HEALTH:const t=this.upgradeSystem.getUpgradeConfig(v.MAX_HEALTH)?.stackValue||30;this.player.increaseMaxHealth(t);break;case v.MOVEMENT_SPEED:const i=this.upgradeSystem.getUpgradeConfig(v.MOVEMENT_SPEED)?.stackValue||30;this.player.increaseSpeed(i);break;case v.WEAPON_DAMAGE:const s=this.upgradeSystem.getUpgradeConfig(v.WEAPON_DAMAGE)?.stackValue||5,n=this.player.getWeapons();for(const l of n)l.addDamageBonus(s);break;case v.HEALTH_REGEN:break;case v.KILL_HEAL:break}}handleHealthRegen(e){const t=this.upgradeSystem.getUpgradeValue(v.HEALTH_REGEN);t<=0||(this.healthRegenTimer+=e,this.healthRegenTimer>=1&&(this.healthRegenTimer=0,this.player.heal(t)))}handleKillHeal(){const e=this.upgradeSystem.getUpgradeValue(v.KILL_HEAL);e>0&&this.player.heal(e)}showPauseMenu(){const e=document.getElementById("pause-menu");e&&e.remove();const t=document.createElement("div");t.id="pause-menu",t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-family: 'Courier New', monospace;
    `;const i=document.createElement("div");i.style.cssText=`
      background-color: #1a1a1a;
      border: 3px solid #00ffff;
      border-radius: 8px;
      padding: 0;
      max-width: 600px;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      animation: slideIn 0.3s ease-out;
      overflow: hidden;
    `;const s=document.createElement("div");s.style.cssText=`
      background-color: #0a0a0a;
      border-bottom: 2px solid #00ffff;
      padding: 20px;
      text-align: center;
    `;const n=document.createElement("div");n.textContent="â¸ï¸ æ¸¸æˆæš‚åœ",n.style.cssText=`
      color: #00ffff;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      letter-spacing: 2px;
    `,s.appendChild(n);const l=document.createElement("div");l.style.cssText=`
      padding: 30px;
    `;const a=document.createElement("div");a.style.cssText=`
      color: #00ff00;
      font-size: 14px;
      line-height: 1.8;
      margin-bottom: 30px;
      padding: 15px;
      background-color: rgba(0, 255, 0, 0.1);
      border-left: 3px solid #00ff00;
    `;const r=this.levelManager.getCurrentLevel(),h=this.player.getHealth(),c=this.player.getMaxHealth(),g=Math.round(h/c*100),u=this.upgradeSystem.getAllUpgrades();let f=`ðŸ“Š æ¸¸æˆçŠ¶æ€ï¼š
  â€¢ å½“å‰å…³å¡: ${r}
  â€¢ çŽ©å®¶è¡€é‡: ${h}/${c} (${g}%)
  â€¢ å½“å‰å¾—åˆ†: ${this.score}

ðŸŽ® å½“å‰å‡çº§:`;if(u.length>0)for(const M of u){const C=this.upgradeSystem.getUpgradeConfig(M.type);f+=`
  ${C?.icon} ${C?.name}: ${M.count}x (æ€»è®¡: +${M.totalValue})`}else f+=`
  æš‚æ— å‡çº§`;a.textContent=f,l.appendChild(a);const m=document.createElement("div");m.style.cssText=`
      display: flex;
      gap: 15px;
      justify-content: center;
    `;const y=document.createElement("button");y.textContent="ç»§ç»­æ¸¸æˆ (ESC)",y.style.cssText=`
      padding: 12px 30px;
      background-color: #00ffff;
      color: #000;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
    `,y.onmouseover=()=>{y.style.backgroundColor="#00dddd",y.style.boxShadow="0 0 15px rgba(0, 255, 255, 0.8)"},y.onmouseout=()=>{y.style.backgroundColor="#00ffff",y.style.boxShadow="none"},y.onclick=()=>{this.isPaused=!1,this.closePauseMenu()};const w=document.createElement("button");w.textContent="é‡æ–°å¼€å§‹",w.style.cssText=`
      padding: 12px 30px;
      background-color: #ff6600;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
    `,w.onmouseover=()=>{w.style.backgroundColor="#ff5500",w.style.boxShadow="0 0 15px rgba(255, 102, 0, 0.8)"},w.onmouseout=()=>{w.style.backgroundColor="#ff6600",w.style.boxShadow="none"},w.onclick=()=>{this.closePauseMenu(),this.restartGame()},m.appendChild(y),m.appendChild(w),l.appendChild(m),i.appendChild(s),i.appendChild(l),t.appendChild(i),document.body.appendChild(t)}closePauseMenu(){const e=document.getElementById("pause-menu");e&&e.remove()}}const B=new K;B.start();window.game=B;
